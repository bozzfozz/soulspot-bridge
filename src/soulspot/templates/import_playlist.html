{# Hey future me - Import Playlist page!
   Shows auth status via HTMX, then a form for Spotify playlist URL/ID.
   getConnectSpotifyHTML() helper handles unauthenticated state.
   htmx:responseError catches 401s from cross-device access (no session cookie). #}

{% extends "base.html" %}

{% block title %}Import Playlist - SoulSpot{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: var(--space-8);">
        <div style="width: 80px; height: 80px; margin: 0 auto var(--space-6); background: linear-gradient(135deg, var(--accent-primary), #a855f7); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-xl);">
            <i class="fa-solid fa-plus" style="color: white; font-size: 2rem;"></i>
        </div>
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-3);">Import Spotify Playlist</h1>
        <p style="color: var(--text-muted); font-size: var(--font-size-lg);">Import a Spotify playlist to start downloading tracks</p>
    </div>

    <!-- Authentication Status -->
    <div id="auth-status" 
         hx-get="/api/auth/session" 
         hx-trigger="load"
         hx-swap="innerHTML"
         style="margin-bottom: var(--space-6);">
        <div class="card" style="padding: var(--space-6);">
            <div style="display: flex; align-items: center; gap: var(--space-4);">
                <div class="spinner"></div>
                <span style="color: var(--text-muted);">Checking authentication status...</span>
            </div>
        </div>
    </div>

    <!-- Import Form -->
    <div class="card" style="padding: var(--space-6);">
        <form id="import-form" 
              hx-post="/api/playlists/import"
              hx-target="#import-result"
              hx-swap="innerHTML">
            
            <div style="margin-bottom: var(--space-5);">
                <label for="playlist_id" style="display: block; font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">
                    Spotify Playlist ID or URL <span style="color: var(--accent-primary);">*</span>
                </label>
                <input type="text" 
                       id="playlist_id" 
                       name="playlist_id" 
                       class="form-input"
                       style="width: 100%;"
                       placeholder="spotify:playlist:... or https://open.spotify.com/playlist/..."
                       required>
                <p style="margin-top: var(--space-2); font-size: var(--font-size-sm); color: var(--text-muted);">
                    Enter a Spotify playlist ID or paste the full URL
                </p>
            </div>

            <div style="margin-bottom: var(--space-6); padding: var(--space-4); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                <label style="display: flex; align-items: center; gap: var(--space-3); cursor: pointer;">
                    <input type="checkbox" 
                           id="fetch_all_tracks"
                           name="fetch_all_tracks" 
                           checked
                           class="form-checkbox">
                    <span style="font-weight: var(--font-weight-medium);">Fetch all tracks in the playlist</span>
                </label>
            </div>

            <div style="display: flex; flex-wrap: wrap; justify-content: flex-end; gap: var(--space-3); padding-top: var(--space-4); border-top: 1px solid var(--border-primary);">
                <a href="/auth" class="btn btn-outline">
                    <i class="fa-solid fa-key"></i>
                    Re-authenticate Spotify
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fa-solid fa-plus"></i>
                    Import Playlist
                </button>
            </div>
        </form>
    </div>

    <!-- Result Area -->
    <div id="import-result" style="margin-top: var(--space-6);"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-secondary);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .form-checkbox {
        width: 20px;
        height: 20px;
        border-radius: var(--radius-sm);
        border: 2px solid var(--border-secondary);
        background: transparent;
        cursor: pointer;
    }
    .form-checkbox:checked {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
    }
    .status-card {
        padding: var(--space-5);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }
    .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xl);
        flex-shrink: 0;
    }
</style>
<script>
function getConnectSpotifyHTML() {
    return `
        <div class="status-card" style="background: rgba(var(--accent-primary-rgb), 0.1); border: 1px solid rgba(var(--accent-primary-rgb), 0.2);">
            <div class="status-icon" style="background: var(--accent-primary);">
                <i class="fa-solid fa-circle-info" style="color: white;"></i>
            </div>
            <div style="flex: 1;">
                <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Connect Spotify</p>
                <p style="font-size: var(--font-size-sm); color: var(--text-muted);">Connect your Spotify account to start importing playlists</p>
            </div>
            <a href="/auth" class="btn btn-primary">Connect Now</a>
        </div>
    `;
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'auth-status') {
        try {
            const response = JSON.parse(evt.detail.xhr.response);
            const statusDiv = document.getElementById('auth-status');
            
            if (response.has_access_token && !response.token_expired) {
                statusDiv.innerHTML = `
                    <div class="status-card" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div class="status-icon" style="background: #22c55e;">
                            <i class="fa-solid fa-check" style="color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Spotify Connected</p>
                            <p style="font-size: var(--font-size-sm); color: var(--text-muted);">Ready to import playlists and download tracks</p>
                        </div>
                        <a href="/api/auth/logout" class="btn btn-outline btn-sm">Disconnect</a>
                    </div>
                `;
            } else if (response.token_expired) {
                statusDiv.innerHTML = `
                    <div class="status-card" style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.2);">
                        <div class="status-icon" style="background: #eab308;">
                            <i class="fa-solid fa-triangle-exclamation" style="color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Spotify Token Expired</p>
                            <p style="font-size: var(--font-size-sm); color: var(--text-muted);">Will auto-refresh when needed, or reconnect manually</p>
                        </div>
                        <a href="/auth" class="btn btn-warning btn-sm">Reconnect</a>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = getConnectSpotifyHTML();
            }
        } catch (e) {
            document.getElementById('auth-status').innerHTML = getConnectSpotifyHTML();
        }
    }
    
    if (evt.detail.target.id === 'import-result') {
        try {
            const response = JSON.parse(evt.detail.xhr.response);
            if (response.playlist_id) {
                SoulSpot.showNotification('Playlist imported successfully!', 'success');
            }
        } catch (e) {}
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    if (evt.detail.target.id === 'auth-status') {
        document.getElementById('auth-status').innerHTML = getConnectSpotifyHTML();
    }
    
    if (evt.detail.xhr.status === 401 && evt.detail.target.id === 'import-form') {
        try {
            const response = JSON.parse(evt.detail.xhr.response);
            document.getElementById('import-result').innerHTML = `
                <div class="status-card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div class="status-icon" style="background: #ef4444;">
                        <i class="fa-solid fa-circle-xmark" style="color: white;"></i>
                    </div>
                    <div style="flex: 1;">
                        <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Authentication Required</p>
                        <p style="font-size: var(--font-size-sm); color: var(--text-muted);">${response.detail}</p>
                    </div>
                    <a href="/auth" class="btn btn-error">Connect Spotify</a>
                </div>
            `;
            SoulSpot.showNotification(response.detail, 'error');
        } catch (e) {
            document.getElementById('import-result').innerHTML = getConnectSpotifyHTML();
        }
    }
});
</script>
{% endblock %}
