{# Hey future me - this is the NEW dashboard page!
   Uses macros for stat_card and page_header.
   Stats come from the backend as a dict with playlists, tracks, downloads, queue_size, active_downloads.
   Recent activity and playlists are passed separately.
   The HTMX auto-refresh is for stats every 30s - might cause issues if API endpoint changes. #}

{% extends "base.html" %}

{% block title %}Dashboard - SoulSpot{% endblock %}

{% import "includes/macros.html" as macros %}

{% block content %}
<!-- Page Header -->
{{ macros.page_header(
    title="Dashboard",
    subtitle="Welcome back! Here's what's happening with your music library.",
    action_text="Import Playlist",
    action_url="/playlists/import",
    action_icon="fa-solid fa-plus",
    action_class="btn-primary"
) }}

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    {{ macros.stat_card("Total Playlists", stats.playlists|default(0), "fa-solid fa-list", "12% from last month", "positive") }}
    {{ macros.stat_card("Total Tracks", stats.tracks|default(0), "fa-solid fa-music", "8% from last month", "positive") }}
    {{ macros.stat_card("Downloaded", stats.downloads|default(0), "fa-solid fa-download", "24% from last month", "positive") }}

    <!-- Queue (Custom for badge) -->
    <div class="stat-card">
        <div class="stat-card-icon">
            <i class="fa-solid fa-clock"></i>
        </div>
        <div class="stat-card-content">
            <div class="stat-card-label">In Queue</div>
            <div class="stat-card-value">{{ stats.queue_size|default(0) }}</div>
            {% if stats.queue_size and stats.queue_size > 0 %}
            <div class="stat-card-change">
                <span class="badge badge-warning">{{ stats.active_downloads|default(0) }} active</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Playlists -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2>Recent Playlists</h2>
        <a href="/playlists" class="btn btn-outline btn-sm">
            View All
            <i class="fa-solid fa-arrow-right"></i>
        </a>
    </div>

    <div class="grid grid-cols-6">
        {% if playlists %}
        {% for playlist in playlists[:6] %}
        <div class="media-card">
            <div class="media-card-image">
                <img src="{{ playlist.cover_url or 'https://via.placeholder.com/300x300?text=Playlist' }}"
                    alt="{{ playlist.name }}">
                <div class="media-card-overlay">
                    <div class="media-card-actions">
                        <button class="btn-icon btn-primary">
                            <i class="fa-solid fa-play"></i>
                        </button>
                        <button class="btn-icon">
                            <i class="fa-solid fa-ellipsis"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="media-card-content">
                <div class="media-card-title">{{ playlist.name }}</div>
                <div class="media-card-subtitle">{{ playlist.track_count }} tracks</div>
                <div class="media-card-meta">
                    <span class="badge badge-success">{{ playlist.downloaded_count|default(0) }} downloaded</span>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="card" style="grid-column: 1 / -1;">
            <div style="text-align: center; padding: 3rem;">
                <i class="fa-solid fa-list" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                <h3>No Playlists Yet</h3>
                <p class="text-muted" style="margin-top: 0.5rem;">Import your first playlist from Spotify to get
                    started.</p>
                <a href="/playlists/import" class="btn btn-primary" style="margin-top: 1.5rem;">
                    <i class="fa-solid fa-plus"></i>
                    Import Playlist
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Activity -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2>Recent Activity</h2>
        <a href="/downloads" class="btn btn-outline btn-sm">
            View All
            <i class="fa-solid fa-arrow-right"></i>
        </a>
    </div>

    <div class="card">
        {% if recent_activity %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for activity in recent_activity[:5] %}
            <div
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <div style="width: 48px; height: 48px; flex-shrink: 0;">
                    <img src="{{ activity.album_art or 'https://via.placeholder.com/48x48?text=â™ª' }}"
                        alt="{{ activity.title }}"
                        style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-sm);">
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: var(--font-weight-medium); color: var(--text-primary);">{{ activity.title }}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: 0.25rem;">{{ activity.artist }}</div>
                </div>
                <div>
                    {% if activity.status == 'completed' %}
                    <span class="badge badge-success">
                        <i class="fa-solid fa-check"></i>
                        Completed
                    </span>
                    {% elif activity.status == 'downloading' %}
                    <span class="badge badge-info">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        Downloading
                    </span>
                    {% elif activity.status == 'failed' %}
                    <span class="badge badge-error">
                        <i class="fa-solid fa-times"></i>
                        Failed
                    </span>
                    {% endif %}
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--text-muted);">
                    {{ activity.timestamp }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem;">
            <i class="fa-solid fa-clock-rotate-left"
                style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
            <h3>No Recent Activity</h3>
            <p class="text-muted" style="margin-top: 0.5rem;">Your download activity will appear here.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Spotify Connection Status -->
<div class="card">
    <div class="flex items-center gap-4">
        <div
            style="width: 64px; height: 64px; background: var(--bg-success); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
            <i class="fa-brands fa-spotify" style="font-size: 2rem; color: var(--color-success);"></i>
        </div>
        <div style="flex: 1;">
            <h3>Spotify Connected</h3>
            <p class="text-muted" style="margin-top: 0.25rem;">Your Spotify account is connected and ready to sync.</p>
        </div>
        <a href="/playlists/import" class="btn btn-primary">
            <i class="fa-solid fa-sync"></i>
            Sync Now
        </a>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-refresh stats every 30 seconds
    setInterval(() => {
        htmx.ajax('GET', '/api/stats', {
            target: '.stat-card',
            swap: 'outerHTML'
        });
    }, 30000);
</script>
{% endblock %}
