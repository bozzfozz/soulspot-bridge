{# Hey future me - Spotify OAuth authorization page!
   initiateSpotifyAuth() calls /api/auth/authorize to get the Spotify auth URL.
   On success, redirects to Spotify. On failure, shows error with config hint.
   SPOTIFY_CLIENT_ID and SPOTIFY_REDIRECT_URI must be in .env! #}

{% extends "base.html" %}

{% block title %}Spotify Auth - SoulSpot{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: var(--space-8);">
        <div style="width: 80px; height: 80px; margin: 0 auto var(--space-6); background: #1DB954; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-xl);">
            <i class="fa-brands fa-spotify" style="color: white; font-size: 2.5rem;"></i>
        </div>
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-3);">Connect Spotify</h1>
        <p style="color: var(--text-muted); font-size: var(--font-size-lg);">
            Connect your Spotify account to import playlists and access your music library
        </p>
    </div>
    
    <!-- Authorization Section -->
    <div class="card" style="margin-bottom: var(--space-6);">
        <div style="padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--border-primary);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold);">Step 1: Authorize Application</h2>
        </div>
        <div style="padding: var(--space-6);">
            <p style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--space-6);">
                Click the button below to connect your Spotify account. You'll be redirected to Spotify to authorize this application.
            </p>
            
            <button id="auth-btn" 
                    class="btn btn-primary btn-lg"
                    style="background: #1DB954; border-color: #1DB954;"
                    onclick="initiateSpotifyAuth()">
                <i class="fa-brands fa-spotify"></i>
                Connect with Spotify
            </button>
            
            <div id="auth-result" style="margin-top: var(--space-6);"></div>
        </div>
    </div>

    <!-- OAuth Flow Info -->
    <div class="card" style="padding: var(--space-6); background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
        <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
            <i class="fa-solid fa-circle-info" style="color: #3b82f6;"></i>
            How It Works
        </h3>
        <ol style="list-style: none; display: flex; flex-direction: column; gap: var(--space-3); font-size: var(--font-size-sm);">
            <li style="display: flex; align-items: flex-start; gap: var(--space-3);">
                <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); flex-shrink: 0;">1</span>
                <span>Click "Connect with Spotify" to start the authorization flow</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: var(--space-3);">
                <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); flex-shrink: 0;">2</span>
                <span>You'll be redirected to Spotify to grant access to your account</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: var(--space-3);">
                <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); flex-shrink: 0;">3</span>
                <span>After authorization, Spotify will redirect you back to this application</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: var(--space-3);">
                <span style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); flex-shrink: 0;">4</span>
                <span>Your session will be established and you can start using Spotify features</span>
            </li>
        </ol>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: var(--space-2);
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .status-card {
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
    }
</style>
<script>
async function initiateSpotifyAuth() {
    const btn = document.getElementById('auth-btn');
    const resultDiv = document.getElementById('auth-result');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Connecting...';
    
    try {
        const response = await fetch('/api/auth/authorize', {
            method: 'GET',
            credentials: 'same-origin',
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.authorization_url) {
            SoulSpot.showNotification('Redirecting to Spotify...', 'info');
            
            resultDiv.innerHTML = `
                <div class="status-card" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <i class="fa-solid fa-check-circle" style="color: #22c55e; font-size: var(--font-size-xl);"></i>
                    <div>
                        <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Redirecting to Spotify...</p>
                        <p style="font-size: var(--font-size-sm); color: var(--text-muted);">Please wait while we redirect you</p>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                window.location.href = data.authorization_url;
            }, 500);
        } else {
            throw new Error('No authorization URL received');
        }
    } catch (error) {
        console.error('Authorization error:', error);
        
        SoulSpot.showNotification('Failed to connect to Spotify', 'error');
        
        resultDiv.innerHTML = `
            <div class="status-card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                <i class="fa-solid fa-circle-xmark" style="color: #ef4444; font-size: var(--font-size-xl);"></i>
                <div>
                    <p style="font-weight: var(--font-weight-bold); margin-bottom: var(--space-1);">Failed to start authorization</p>
                    <p style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--space-2);">${error.message}</p>
                    <p style="font-size: var(--font-size-xs); color: var(--text-muted);">Make sure SPOTIFY_CLIENT_ID and SPOTIFY_REDIRECT_URI are configured in your .env file</p>
                </div>
            </div>
        `;
        
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-brands fa-spotify"></i> Connect with Spotify';
    }
}
</script>
{% endblock %}
