{# Hey future me - Settings page with tabbed interface!
   Tabs: General, Integration, Downloads, Appearance, Advanced.
   All the JS logic for tab switching, form validation, and API calls is at the bottom.
   Password fields have toggle buttons - watch for the onclick handler! #}

{% extends "base.html" %}

{% block title %}Settings - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-6); flex-wrap: wrap; gap: var(--space-4);">
    <div style="display: flex; align-items: center; gap: var(--space-4);">
        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-secondary), #7c3aed); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-gear" style="color: white; font-size: 1.25rem;"></i>
        </div>
        <div>
            <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-1);">Settings</h1>
            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Configure your SoulSpot instance</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button class="btn btn-outline" onclick="confirmReset()">
            <i class="bi bi-arrow-counterclockwise"></i>
            Reset to Defaults
        </button>
        <button class="btn btn-primary" onclick="saveSettings()">
            <i class="bi bi-floppy"></i>
            Save Changes
        </button>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="card" style="margin-bottom: var(--space-6);">
    <div class="tabs-nav" style="display: flex; border-bottom: 1px solid var(--border-primary); overflow-x: auto;">
        <button class="tab-btn active" data-tab="general" onclick="switchTab('general')">
            <i class="bi bi-sliders"></i>
            General
        </button>
        <button class="tab-btn" data-tab="spotify-sync" onclick="switchTab('spotify-sync')">
            <i class="bi bi-spotify" style="color: #1DB954;"></i>
            Spotify Sync
        </button>
        <button class="tab-btn" data-tab="integration" onclick="switchTab('integration')">
            <i class="bi bi-plug"></i>
            Integration
        </button>
        <button class="tab-btn" data-tab="download" onclick="switchTab('download')">
            <i class="bi bi-download"></i>
            Downloads
        </button>
        <button class="tab-btn" data-tab="library" onclick="switchTab('library')">
            <i class="bi bi-folder-symlink"></i>
            Library
        </button>
        <button class="tab-btn" data-tab="appearance" onclick="switchTab('appearance')">
            <i class="bi bi-palette"></i>
            Appearance
        </button>
        <button class="tab-btn" data-tab="automation" onclick="switchTab('automation')">
            <i class="bi bi-robot"></i>
            Automation
        </button>
        <button class="tab-btn" data-tab="advanced" onclick="switchTab('advanced')">
            <i class="bi bi-gear"></i>
            Advanced
        </button>
    </div>
</div>

<!-- Settings Form -->
<form id="settings-form" onsubmit="saveSettings(event)">
    <!-- General Settings Tab -->
    <div id="tab-general" class="tab-content">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">General Settings</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="app-name">Application Name</label>
                    <input type="text" id="app-name" name="general.app_name" class="form-input" value="SoulSpot" required>
                    <p class="form-helper">Display name for the application</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="log-level">Log Level</label>
                    <select id="log-level" name="general.log_level" class="form-input" required>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                    <p class="form-helper">Logging verbosity level</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="debug-mode" name="general.debug" style="accent-color: var(--accent-primary);">
                        <span>Enable Debug Mode</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Show detailed debug information (not recommended for production)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Spotify Sync Settings Tab -->
    <div id="tab-spotify-sync" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Master Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-primary);">
                <div>
                    <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                        <i class="bi bi-spotify" style="color: #1DB954; margin-right: var(--space-2);"></i>
                        Spotify Auto-Sync
                    </h2>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Automatically sync data from your Spotify account</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="spotify-auto-sync-enabled" checked onchange="toggleSpotifySyncSetting('auto_sync_enabled')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Sync Types -->
            <div class="form-stack" id="spotify-sync-options">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">What to Sync</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #1DB954, #169c46);">
                            <i class="bi bi-people"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Followed Artists</div>
                            <div class="sync-option-desc">Sync artists you follow on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-artists" checked onchange="toggleSpotifySyncSetting('auto_sync_artists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #7c3aed, #6366f1);">
                            <i class="bi bi-music-note-list"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Playlists</div>
                            <div class="sync-option-desc">Sync your Spotify playlists</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-playlists" checked onchange="toggleSpotifySyncSetting('auto_sync_playlists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="bi bi-heart"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Liked Songs</div>
                            <div class="sync-option-desc">Sync your Liked Songs playlist</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-liked-songs" checked onchange="toggleSpotifySyncSetting('auto_sync_liked_songs')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="bi bi-disc"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Saved Albums</div>
                            <div class="sync-option-desc">Sync albums you've saved to your library</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-saved-albums" checked onchange="toggleSpotifySyncSetting('auto_sync_saved_albums')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Sync Intervals -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Sync Intervals</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="artists-sync-interval">Artists Sync Cooldown</label>
                        <div class="input-with-suffix">
                            <input type="number" id="artists-sync-interval" class="form-input" value="5" min="1" max="60" style="max-width: 100px;">
                            <span class="input-suffix">minutes</span>
                        </div>
                        <p class="form-helper">Minimum time between artist sync runs</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="playlists-sync-interval">Playlists Sync Cooldown</label>
                        <div class="input-with-suffix">
                            <input type="number" id="playlists-sync-interval" class="form-input" value="10" min="1" max="60" style="max-width: 100px;">
                            <span class="input-suffix">minutes</span>
                        </div>
                        <p class="form-helper">Minimum time between playlist sync runs</p>
                    </div>
                </div>
            </div>

            <!-- Image Download -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Image Storage</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="bi bi-images"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Download Images Locally</div>
                            <div class="sync-option-desc">Store artist, album, and playlist images on disk for offline access</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-download-images" checked onchange="toggleSpotifySyncSetting('download_images')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Disk Usage Stats -->
                <div id="image-stats-container" class="stats-container" style="margin-top: var(--space-4);">
                    <div class="stat-box">
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-artists-count">-</div>
                            <div class="stat-label">Artist Images</div>
                            <div class="stat-size" id="stat-artists-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon"><i class="bi bi-disc"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-albums-count">-</div>
                            <div class="stat-label">Album Covers</div>
                            <div class="stat-size" id="stat-albums-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon"><i class="bi bi-music-note-list"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-playlists-count">-</div>
                            <div class="stat-label">Playlist Covers</div>
                            <div class="stat-size" id="stat-playlists-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box stat-total">
                        <div class="stat-icon"><i class="bi bi-hdd"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-count">-</div>
                            <div class="stat-label">Total Images</div>
                            <div class="stat-size" id="stat-total-size">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cleanup Behavior -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Cleanup Behavior</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">
                            <i class="bi bi-person-dash"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Remove Unfollowed Artists</div>
                            <div class="sync-option-desc">Automatically remove artists when you unfollow them on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-remove-unfollowed-artists" checked onchange="toggleSpotifySyncSetting('remove_unfollowed_artists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card" style="margin-top: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #b45309);">
                            <i class="bi bi-list-ul"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Remove Deleted Playlists</div>
                            <div class="sync-option-desc">Automatically remove playlists when you delete them on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-remove-unfollowed-playlists" onchange="toggleSpotifySyncSetting('remove_unfollowed_playlists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="alert alert-info" style="margin-top: var(--space-4);">
                    <i class="bi bi-info-circle"></i>
                    <span>Downloaded tracks are never automatically removed. Only metadata and images are affected by these settings.</span>
                </div>
            </div>

            <!-- Save Button for Intervals -->
            <div style="margin-top: var(--space-6); display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="saveSpotifySyncSettings()">
                    <i class="bi bi-floppy"></i>
                    Save Sync Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Integration Settings Tab -->
    <div id="tab-integration" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Spotify -->
            <div style="margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="bi bi-spotify" style="color: #1DB954;"></i>
                    Spotify Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="spotify-client-id">Client ID</label>
                        <input type="text" id="spotify-client-id" name="integration.spotify_client_id" class="form-input" placeholder="Your Spotify Client ID">
                        <p class="form-helper">Get this from <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: var(--accent-primary);">Spotify Developer Dashboard</a></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-client-secret">Client Secret</label>
                        <div class="input-with-toggle">
                            <input type="password" id="spotify-client-secret" name="integration.spotify_client_secret" class="form-input" placeholder="Your Spotify Client Secret">
                            <button type="button" class="btn-icon" onclick="togglePassword('spotify-client-secret')" title="Toggle visibility">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-redirect-uri">Redirect URI</label>
                        <input type="url" id="spotify-redirect-uri" name="integration.spotify_redirect_uri" class="form-input" value="http://localhost:8000/api/auth/callback">
                    </div>
                </div>
            </div>

            <!-- slskd -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary); margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="bi bi-server" style="color: #3b82f6;"></i>
                    slskd Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="slskd-url">slskd URL</label>
                        <input type="url" id="slskd-url" name="integration.slskd_url" class="form-input" value="http://localhost:5030" required>
                        <p class="form-helper">Base URL for your slskd instance</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="slskd-username">Username</label>
                            <input type="text" id="slskd-username" name="integration.slskd_username" class="form-input" value="admin" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="slskd-password">Password</label>
                            <div class="input-with-toggle">
                                <input type="password" id="slskd-password" name="integration.slskd_password" class="form-input" placeholder="slskd password">
                                <button type="button" class="btn-icon" onclick="togglePassword('slskd-password')" title="Toggle visibility">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="slskd-api-key">API Key (Optional)</label>
                        <div class="input-with-toggle">
                            <input type="password" id="slskd-api-key" name="integration.slskd_api_key" class="form-input" placeholder="Optional API key">
                            <button type="button" class="btn-icon" onclick="togglePassword('slskd-api-key')" title="Toggle visibility">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MusicBrainz -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="bi bi-music-note" style="color: #ba478f;"></i>
                    MusicBrainz Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-app-name">Application Name</label>
                        <input type="text" id="musicbrainz-app-name" name="integration.musicbrainz_app_name" class="form-input" value="SoulSpot" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-contact">Contact Email</label>
                        <input type="email" id="musicbrainz-contact" name="integration.musicbrainz_contact" class="form-input" placeholder="your@email.com">
                        <p class="form-helper">MusicBrainz requires a contact email for API access</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Settings Tab -->
    <div id="tab-download" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Download Queue Configuration</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="max-concurrent-downloads">Maximum Concurrent Downloads</label>
                    <input type="number" id="max-concurrent-downloads" name="download.max_concurrent_downloads" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of downloads that can run simultaneously (1-10, recommended: 3)</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="default-max-retries">Default Maximum Retries</label>
                    <input type="number" id="default-max-retries" name="download.default_max_retries" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of retry attempts for failed downloads (1-10)</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable-priority-queue" name="download.enable_priority_queue" checked style="accent-color: var(--accent-primary);">
                        <span>Enable Priority Queue</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Allow downloads to be prioritized (P0/P1/P2)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Settings Tab -->
    <div id="tab-appearance" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Theme & Appearance</h2>
            
            <div class="form-group">
                <label class="form-label">Theme</label>
                <div class="theme-options">
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="dark" checked onclick="applyTheme('dark')">
                        <div class="theme-card">
                            <i class="bi bi-moon" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Dark</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="light" onclick="applyTheme('light')">
                        <div class="theme-card">
                            <i class="bi bi-sun" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Light</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="auto" onclick="applyTheme('auto')">
                        <div class="theme-card">
                            <i class="bi bi-circle-half" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Auto</span>
                        </div>
                    </label>
                </div>
                <p class="form-helper" style="margin-top: var(--space-3);">Choose how the application looks. Auto follows your system preferences.</p>
            </div>

            <div class="alert alert-info" style="margin-top: var(--space-6);">
                <i class="bi bi-info-circle"></i>
                <span><strong>Theme Persistence:</strong> Your theme preference is saved in your browser and will be remembered on future visits.</span>
            </div>
        </div>
    </div>

    <!-- Library Naming Settings Tab -->
    <div id="tab-library" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-primary);">
                <div>
                    <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                        <i class="bi bi-folder-symlink" style="color: var(--accent-primary); margin-right: var(--space-2);"></i>
                        Library File Naming
                    </h2>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Configure how files and folders are named. Compatible with Lidarr.</p>
                </div>
            </div>

            <!-- Lidarr Compatibility Notice -->
            <div class="alert alert-info" style="margin-bottom: var(--space-6);">
                <i class="fa-solid fa-info-circle"></i>
                <span><strong>Lidarr Compatible:</strong> Default settings match Lidarr's naming format for seamless coexistence on shared libraries.</span>
            </div>

            <!-- Template Formats Section -->
            <div style="margin-bottom: var(--space-8);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-tags" style="color: #1DB954;"></i>
                    Naming Templates
                </h3>
                
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="naming-artist-folder">Artist Folder Format</label>
                        <input type="text" id="naming-artist-folder" class="form-input" value="{Artist Name}" 
                               oninput="validateAndPreviewNaming()">
                        <p class="form-helper">Template for artist folder names. Variables: <code>{Artist Name}</code>, <code>{Artist CleanName}</code></p>
                        <div id="naming-artist-folder-error" class="validation-error" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="naming-album-folder">Album Folder Format</label>
                        <input type="text" id="naming-album-folder" class="form-input" value="{Album Title} ({Release Year})"
                               oninput="validateAndPreviewNaming()">
                        <p class="form-helper">Template for album folder names. Variables: <code>{Album Title}</code>, <code>{Album CleanTitle}</code>, <code>{Album Type}</code>, <code>{Release Year}</code></p>
                        <div id="naming-album-folder-error" class="validation-error" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="naming-track-format">Track Filename Format</label>
                        <input type="text" id="naming-track-format" class="form-input" value="{Track Number:00} - {Track Title}"
                               oninput="validateAndPreviewNaming()">
                        <p class="form-helper">Template for track filenames. Variables: <code>{Track Number}</code>, <code>{Track Number:00}</code>, <code>{Track Title}</code></p>
                        <div id="naming-track-format-error" class="validation-error" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="naming-multi-disc-format">Multi-Disc Track Format</label>
                        <input type="text" id="naming-multi-disc-format" class="form-input" value="{Medium:00}-{Track Number:00} - {Track Title}"
                               oninput="validateAndPreviewNaming()">
                        <p class="form-helper">Template for multi-disc albums. Adds disc number prefix. Variables: <code>{Medium}</code>, <code>{Medium:00}</code></p>
                        <div id="naming-multi-disc-format-error" class="validation-error" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Live Preview Section -->
            <div style="margin-bottom: var(--space-8); padding: var(--space-5); background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
                <h4 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-eye" style="color: var(--accent-secondary);"></i>
                    Live Preview
                </h4>
                <div id="naming-preview" style="font-family: var(--font-mono); font-size: var(--font-size-sm); color: var(--text-primary); word-break: break-all;">
                    <div style="color: var(--text-muted); margin-bottom: var(--space-2);">/mnt/music/</div>
                    <div id="preview-artist" style="padding-left: var(--space-4);">Pink Floyd/</div>
                    <div id="preview-album" style="padding-left: var(--space-8);">The Dark Side of the Moon (1973)/</div>
                    <div id="preview-track" style="padding-left: var(--space-12); color: var(--accent-primary);">01 - Speak to Me.flac</div>
                </div>
            </div>

            <!-- Behavior Options Section -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-sliders" style="color: #7c3aed;"></i>
                    Behavior Options
                </h3>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #1DB954, #169c46);">
                            <i class="fa-solid fa-file-signature"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Rename Tracks on Import</div>
                            <div class="sync-option-desc">Automatically rename files according to templates</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="naming-rename-tracks" checked onchange="toggleNamingSetting('rename_tracks')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Replace Illegal Characters</div>
                            <div class="sync-option-desc">Replace characters not allowed in filenames (: ? * " < > |)</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="naming-replace-illegal" checked onchange="toggleNamingSetting('replace_illegal_characters')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fa-solid fa-folder-plus"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Create Artist Folders</div>
                            <div class="sync-option-desc">Automatically create artist folder if it doesn't exist</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="naming-create-artist-folder" checked onchange="toggleNamingSetting('create_artist_folder')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                            <i class="fa-solid fa-compact-disc"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Create Album Folders</div>
                            <div class="sync-option-desc">Automatically create album folder if it doesn't exist</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="naming-create-album-folder" checked onchange="toggleNamingSetting('create_album_folder')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Character Replacements Section -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-text-slash" style="color: #ef4444;"></i>
                    Character Replacements
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="naming-colon-replacement">Colon (:) Replacement</label>
                        <input type="text" id="naming-colon-replacement" class="form-input" value=" -" style="max-width: 150px;">
                        <p class="form-helper">Replace : with this string. Lidarr uses " -"</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="naming-slash-replacement">Slash (/) Replacement</label>
                        <input type="text" id="naming-slash-replacement" class="form-input" value="-" style="max-width: 150px;">
                        <p class="form-helper">Replace / with this string</p>
                    </div>
                </div>
            </div>

            <!-- Available Variables Reference -->
            <div style="margin-bottom: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <details style="cursor: pointer;">
                    <summary style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);">
                        <i class="fa-solid fa-code" style="color: #06b6d4;"></i>
                        Available Variables Reference
                    </summary>
                    <div style="padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: var(--space-3);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4);">
                            <div>
                                <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); color: #1DB954;">Artist</h5>
                                <ul style="font-size: var(--font-size-sm); color: var(--text-muted); list-style: none; padding: 0;">
                                    <li><code>{Artist Name}</code> - Full artist name</li>
                                    <li><code>{Artist CleanName}</code> - Sanitized name</li>
                                </ul>
                            </div>
                            <div>
                                <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); color: #7c3aed;">Album</h5>
                                <ul style="font-size: var(--font-size-sm); color: var(--text-muted); list-style: none; padding: 0;">
                                    <li><code>{Album Title}</code> - Full album title</li>
                                    <li><code>{Album CleanTitle}</code> - Sanitized title</li>
                                    <li><code>{Album Type}</code> - Album/Single/EP</li>
                                    <li><code>{Release Year}</code> - Release year</li>
                                </ul>
                            </div>
                            <div>
                                <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); color: #f59e0b;">Track</h5>
                                <ul style="font-size: var(--font-size-sm); color: var(--text-muted); list-style: none; padding: 0;">
                                    <li><code>{Track Title}</code> - Full track title</li>
                                    <li><code>{Track CleanTitle}</code> - Sanitized title</li>
                                    <li><code>{Track Number}</code> - Track number</li>
                                    <li><code>{Track Number:00}</code> - Zero-padded</li>
                                </ul>
                            </div>
                            <div>
                                <h5 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); color: #06b6d4;">Disc</h5>
                                <ul style="font-size: var(--font-size-sm); color: var(--text-muted); list-style: none; padding: 0;">
                                    <li><code>{Medium}</code> - Disc number</li>
                                    <li><code>{Medium:00}</code> - Zero-padded disc</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Batch Rename Section -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-wand-magic-sparkles" style="color: #ec4899;"></i>
                    Batch Rename (Manual)
                </h3>
                
                <div class="alert alert-warning" style="margin-bottom: var(--space-4);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span><strong>Note:</strong> Only NEW downloads are renamed automatically. Use batch rename to apply templates to existing files.</span>
                </div>
                
                <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                    <button type="button" class="btn btn-outline" onclick="previewBatchRename()">
                        <i class="fa-solid fa-eye"></i>
                        Preview Changes
                    </button>
                    <button type="button" class="btn btn-primary" onclick="startBatchRename()" disabled id="btn-batch-rename">
                        <i class="fa-solid fa-file-signature"></i>
                        Rename Library Files
                    </button>
                </div>
                
                <div id="batch-rename-preview" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md); max-height: 300px; overflow-y: auto;">
                    <!-- Preview results will be shown here -->
                </div>
            </div>

            <!-- Spotify Enrichment Section -->
            <!-- Hey future me - Simplified! Just a single toggle. Auto-enrichment runs automatically
                 after every library scan when enabled. No manual buttons, no extra options.
                 Artwork download, confidence threshold etc. use sensible defaults. -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="bi bi-spotify" style="color: #1DB954;"></i>
                    Spotify Enrichment
                </h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #1DB954, #169c46);">
                            <i class="bi bi-magic"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Auto-Enrich Local Library</div>
                            <div class="sync-option-desc">Automatically enrich local files with Spotify metadata &amp; artwork after each library scan</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enrichment-auto-enabled" checked onchange="toggleEnrichmentSetting('auto_enrichment_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Save Button -->
            <div style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-primary); display: flex; justify-content: flex-end;">
                <button type="button" class="btn btn-primary" onclick="saveNamingSettings()">
                    <i class="fa-solid fa-save"></i>
                    Save Library Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Automation Settings Tab -->
    <div id="tab-automation" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-primary);">
                <div>
                    <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                        <i class="fa-solid fa-robot" style="color: var(--accent-primary); margin-right: var(--space-2);"></i>
                        Automation & Background Workers
                    </h2>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Configure automatic tasks like watchlists, cleanup, and duplicate detection</p>
                </div>
            </div>

            <!-- Watchlist Worker Section -->
            <div style="margin-bottom: var(--space-8);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-eye" style="color: #1DB954;"></i>
                    Artist Watchlist
                </h3>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                    Automatically check for new releases from artists you follow
                </p>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #1DB954, #1ed760);">
                            <i class="fa-solid fa-bell"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Enable Watchlist Monitoring</div>
                            <div class="sync-option-desc">Check Spotify for new releases from watched artists</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="automation-watchlist-enabled" onchange="toggleAutomationSetting('watchlist_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="watchlist-options" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-group" style="margin-top: var(--space-4);">
                        <label class="form-label" for="watchlist-interval">Check Interval</label>
                        <div class="input-with-suffix">
                            <input type="number" id="watchlist-interval" class="form-input" value="60" min="15" max="1440">
                            <span class="input-suffix">minutes</span>
                        </div>
                        <p class="form-helper">How often to check for new releases (15-1440 min)</p>
                    </div>
                </div>
            </div>

            <!-- Discography Worker Section -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-compact-disc" style="color: #7c3aed;"></i>
                    Discography Completion
                </h3>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                    Identify and download missing albums from your watched artists
                </p>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #7c3aed, #6366f1);">
                            <i class="fa-solid fa-list-check"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Enable Discography Scan</div>
                            <div class="sync-option-desc">Find missing albums from watched artists</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="automation-discography-enabled" onchange="toggleAutomationSetting('discography_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="discography-options" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-group" style="margin-top: var(--space-4);">
                        <label class="form-label" for="discography-interval">Scan Interval</label>
                        <div class="input-with-suffix">
                            <input type="number" id="discography-interval" class="form-input" value="24" min="1" max="168">
                            <span class="input-suffix">hours</span>
                        </div>
                        <p class="form-helper">How often to scan for missing albums (1-168 hours)</p>
                    </div>
                </div>
            </div>

            <!-- Quality Upgrade Worker Section -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-arrow-up-right-dots" style="color: #f59e0b;"></i>
                    Quality Upgrades
                </h3>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                    Automatically find higher quality versions of your tracks (e.g., 128kbps  FLAC)
                </p>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Enable Quality Upgrade Detection</div>
                            <div class="sync-option-desc">Find tracks that could be upgraded to better quality</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="automation-quality-enabled" onchange="toggleAutomationSetting('quality_upgrade_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="quality-options" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-group" style="margin-top: var(--space-4);">
                        <label class="form-label" for="quality-profile">Target Quality Profile</label>
                        <select id="quality-profile" class="form-input">
                            <option value="medium">Medium (192+ kbps)</option>
                            <option value="high" selected>High (320 kbps)</option>
                            <option value="lossless">Lossless (FLAC)</option>
                        </select>
                        <p class="form-helper">Minimum quality level for upgrades</p>
                    </div>
                </div>
            </div>

            <!-- Cleanup Worker Section -->
            <div style="margin-bottom: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-broom" style="color: #ef4444;"></i>
                    Cleanup & Maintenance
                </h3>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                    Automatically remove old temp files and orphaned downloads
                </p>
                
                <div class="alert alert-warning" style="margin-bottom: var(--space-4);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span><strong>Caution:</strong> Cleanup permanently deletes files. Enabled at your own risk.</span>
                </div>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fa-solid fa-trash-can"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Enable Auto-Cleanup</div>
                            <div class="sync-option-desc">Remove old temp files and incomplete downloads</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="automation-cleanup-enabled" onchange="toggleAutomationSetting('cleanup_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="cleanup-options" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-group" style="margin-top: var(--space-4);">
                        <label class="form-label" for="cleanup-retention">Retention Period</label>
                        <div class="input-with-suffix">
                            <input type="number" id="cleanup-retention" class="form-input" value="7" min="1" max="90">
                            <span class="input-suffix">days</span>
                        </div>
                        <p class="form-helper">Files older than this will be considered for cleanup</p>
                    </div>
                </div>
            </div>

            <!-- Duplicate Detection Section -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-clone" style="color: #06b6d4;"></i>
                    Duplicate Detection
                </h3>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                    Scan your library for potential duplicate tracks based on metadata
                </p>
                
                <div class="sync-option-card" style="margin-bottom: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Enable Duplicate Scanning</div>
                            <div class="sync-option-desc">Find tracks that might be duplicates</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="automation-duplicate-enabled" onchange="toggleAutomationSetting('duplicate_detection_enabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="duplicate-options" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-group" style="margin-top: var(--space-4);">
                        <label class="form-label" for="duplicate-interval">Scan Interval</label>
                        <div class="input-with-suffix">
                            <input type="number" id="duplicate-interval" class="form-input" value="168" min="24" max="720">
                            <span class="input-suffix">hours</span>
                        </div>
                        <p class="form-helper">How often to scan for duplicates (24-720 hours, default: weekly)</p>
                    </div>

                    <div style="margin-top: var(--space-4);">
                        <a href="/library/duplicates" class="btn btn-outline">
                            <i class="fa-solid fa-list"></i>
                            View Duplicate Candidates
                        </a>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-primary); display: flex; justify-content: flex-end;">
                <button type="button" class="btn btn-primary" onclick="saveAutomationSettings()">
                    <i class="fa-solid fa-save"></i>
                    Save Automation Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Tab -->
    <div id="tab-advanced" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Advanced Configuration</h2>
            
            <div class="alert alert-warning" style="margin-bottom: var(--space-6);">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span><strong>Warning:</strong> Changing these settings may affect application stability. Proceed with caution.</span>
            </div>

            <div style="margin-bottom: var(--space-8);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">API Server</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="api-host">API Host</label>
                            <input type="text" id="api-host" name="advanced.api_host" class="form-input" value="0.0.0.0" required>
                            <p class="form-helper">Host address to bind the API server to</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="api-port">API Port</label>
                            <input type="number" id="api-port" name="advanced.api_port" class="form-input" value="8000" min="1" max="65535" required>
                            <p class="form-helper">Port number for the API server (1-65535)</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="secure-cookies" name="advanced.secure_cookies" style="accent-color: var(--accent-primary);">
                            <span>Use Secure Cookies</span>
                        </label>
                        <p class="form-helper" style="margin-left: 1.75rem;">Enable for HTTPS deployments (production only)</p>
                    </div>
                </div>
            </div>

            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Circuit Breaker</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-failure-threshold">Failure Threshold</label>
                            <input type="number" id="circuit-breaker-failure-threshold" name="advanced.circuit_breaker_failure_threshold" class="form-input" value="5" min="1" required>
                            <p class="form-helper">Number of failures before opening the circuit</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-timeout">Timeout (seconds)</label>
                            <input type="number" id="circuit-breaker-timeout" name="advanced.circuit_breaker_timeout" class="form-input" value="60" min="1" step="0.1" required>
                            <p class="form-helper">Time to wait before attempting recovery</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<style>
    .tab-btn {
        padding: var(--space-3) var(--space-5);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        transition: all var(--transition-fast);
        white-space: nowrap;
    }
    .tab-btn:hover {
        color: var(--text-primary);
    }
    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    .form-stack {
        display: flex;
        flex-direction: column;
        gap: var(--space-5);
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    .form-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }
    .form-helper {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
    }
    .input-with-toggle {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-with-toggle .form-input {
        padding-right: 2.5rem;
    }
    .input-with-toggle .btn-icon {
        position: absolute;
        right: var(--space-2);
    }
    .theme-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-4);
    }
    .theme-option {
        cursor: pointer;
    }
    .theme-option input {
        display: none;
    }
    .theme-card {
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        text-align: center;
        transition: all var(--transition-fast);
    }
    .theme-option input:checked + .theme-card {
        border-color: var(--accent-primary);
        background: rgba(var(--accent-primary-rgb), 0.1);
    }
    .theme-card:hover {
        border-color: var(--text-muted);
    }
    .alert {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-md);
    }
    .alert-info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }
    .alert-warning {
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
    }
    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-tertiary);
        border-radius: 26px;
        transition: all var(--transition-fast);
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: all var(--transition-fast);
    }
    .toggle-switch input:checked + .toggle-slider {
        background-color: #1DB954;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }
    .toggle-switch input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* Sync Option Cards */
    .sync-option-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        transition: all var(--transition-fast);
    }
    .sync-option-card:hover {
        border-color: var(--border-secondary);
    }
    .sync-option-info {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }
    .sync-option-icon {
        width: 42px;
        height: 42px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }
    .sync-option-title {
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }
    .sync-option-desc {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: 2px;
    }
    /* Stats Container */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--space-3);
    }
    .stat-box {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
    }
    .stat-box.stat-total {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border-color: rgba(59, 130, 246, 0.3);
    }
    .stat-icon {
        width: 36px;
        height: 36px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    .stat-content {
        flex: 1;
    }
    .stat-value {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }
    .stat-label {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .stat-size {
        font-size: var(--font-size-xs);
        color: var(--accent-primary);
        margin-top: 2px;
    }
    /* Input with suffix */
    .input-with-suffix {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    .input-suffix {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    /* Validation Error */
    .validation-error {
        font-size: var(--font-size-xs);
        color: #ef4444;
        margin-top: var(--space-1);
        padding: var(--space-2);
        background: rgba(239, 68, 68, 0.1);
        border-radius: var(--radius-sm);
    }
</style>
<script>
    // Hey future me - All the settings page logic is here!
    // Tab switching, password toggles, theme application, form save/load.
    // The API endpoints are /api/settings/ for GET/POST.

    // Tab Switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id === `tab-${tabName}` ? 'block' : 'none';
        });
    }

    // Password Toggle
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = field.nextElementSibling?.querySelector('i') || field.parentElement.querySelector('.btn-icon i');
        if (field.type === 'password') {
            field.type = 'text';
            if (icon) icon.className = 'fa-solid fa-eye-slash';
        } else {
            field.type = 'password';
            if (icon) icon.className = 'fa-solid fa-eye';
        }
    }

    // Theme Management
    // Hey future me - this ACTUALLY applies the theme now, not just saves it!
    // Sets data-theme attribute on <html>, saves to localStorage, updates meta theme-color,
    // and handles "auto" mode with system preference detection + live listener.
    function applyTheme(theme) {
        localStorage.setItem('theme', theme);
        
        let appliedTheme = theme;
        if (theme === 'auto') {
            // Detect system preference
            appliedTheme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
            
            // Listen for system theme changes (only in auto mode)
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                if (localStorage.getItem('theme') === 'auto') {
                    const newTheme = e.matches ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    updateThemeColor(newTheme);
                }
            });
        }
        
        // Apply theme to DOM
        document.documentElement.setAttribute('data-theme', appliedTheme);
        
        // Update meta theme-color for PWA
        updateThemeColor(appliedTheme);
        
        SoulSpot.showNotification(`Theme set to ${theme}`, 'success');
    }
    
    // Helper to update PWA theme-color meta tag
    function updateThemeColor(theme) {
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) {
            metaTheme.content = theme === 'light' ? '#ffffff' : '#0f0f0f';
        }
    }
    
    // Initialize theme selection on page load
    function initThemeSelection() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const themeRadios = document.querySelectorAll('input[name="appearance.theme"]');
        themeRadios.forEach(radio => {
            radio.checked = radio.value === savedTheme;
        });
    }

    // Load Settings from API
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings/');
            if (!response.ok) throw new Error('Failed to load settings');
            
            const settings = await response.json();
            
            if (settings.general) {
                document.getElementById('app-name').value = settings.general.app_name || 'SoulSpot';
                document.getElementById('log-level').value = settings.general.log_level || 'INFO';
                document.getElementById('debug-mode').checked = settings.general.debug || false;
            }
            
            if (settings.integration) {
                document.getElementById('spotify-client-id').value = settings.integration.spotify_client_id || '';
                document.getElementById('spotify-redirect-uri').value = settings.integration.spotify_redirect_uri || 'http://localhost:8000/api/auth/callback';
                document.getElementById('slskd-url').value = settings.integration.slskd_url || 'http://localhost:5030';
                document.getElementById('slskd-username').value = settings.integration.slskd_username || 'admin';
                document.getElementById('musicbrainz-app-name').value = settings.integration.musicbrainz_app_name || 'SoulSpot';
                document.getElementById('musicbrainz-contact').value = settings.integration.musicbrainz_contact || '';
            }
            
            if (settings.download) {
                document.getElementById('max-concurrent-downloads').value = settings.download.max_concurrent_downloads || 3;
                document.getElementById('default-max-retries').value = settings.download.default_max_retries || 3;
                document.getElementById('enable-priority-queue').checked = settings.download.enable_priority_queue !== false;
            }
            
            if (settings.advanced) {
                document.getElementById('api-host').value = settings.advanced.api_host || '0.0.0.0';
                document.getElementById('api-port').value = settings.advanced.api_port || 8000;
                document.getElementById('secure-cookies').checked = settings.advanced.secure_cookies || false;
                document.getElementById('circuit-breaker-failure-threshold').value = settings.advanced.circuit_breaker_failure_threshold || 5;
                document.getElementById('circuit-breaker-timeout').value = settings.advanced.circuit_breaker_timeout || 60;
            }
            
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    // Save Settings
    async function saveSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('settings-form');
        const formData = new FormData(form);
        
        const settings = {
            general: {
                app_name: formData.get('general.app_name'),
                log_level: formData.get('general.log_level'),
                debug: document.getElementById('debug-mode').checked,
            },
            integration: {
                spotify_client_id: formData.get('integration.spotify_client_id'),
                spotify_client_secret: formData.get('integration.spotify_client_secret'),
                spotify_redirect_uri: formData.get('integration.spotify_redirect_uri'),
                slskd_url: formData.get('integration.slskd_url'),
                slskd_username: formData.get('integration.slskd_username'),
                slskd_password: formData.get('integration.slskd_password'),
                slskd_api_key: formData.get('integration.slskd_api_key') || null,
                musicbrainz_app_name: formData.get('integration.musicbrainz_app_name'),
                musicbrainz_contact: formData.get('integration.musicbrainz_contact'),
            },
            download: {
                max_concurrent_downloads: parseInt(formData.get('download.max_concurrent_downloads')),
                default_max_retries: parseInt(formData.get('download.default_max_retries')),
                enable_priority_queue: document.getElementById('enable-priority-queue').checked,
            },
            appearance: {
                theme: formData.get('appearance.theme'),
            },
            advanced: {
                api_host: formData.get('advanced.api_host'),
                api_port: parseInt(formData.get('advanced.api_port')),
                secure_cookies: document.getElementById('secure-cookies').checked,
                circuit_breaker_failure_threshold: parseInt(formData.get('advanced.circuit_breaker_failure_threshold')),
                circuit_breaker_timeout: parseFloat(formData.get('advanced.circuit_breaker_timeout')),
            },
        };
        
        try {
            const response = await fetch('/api/settings/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings),
            });
            
            if (!response.ok) throw new Error('Failed to save settings');
            
            SoulSpot.showNotification('Settings saved successfully', 'success');
        } catch (error) {
            console.error('Failed to save settings:', error);
            SoulSpot.showNotification('Failed to save settings', 'error');
        }
    }

    // Confirm Reset
    async function confirmReset() {
        if (!confirm('Are you sure you want to reset all settings to their default values?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/settings/reset', {method: 'POST'});
            if (!response.ok) throw new Error('Failed to reset settings');
            
            SoulSpot.showNotification('Settings reset to defaults', 'success');
            await loadSettings();
        } catch (error) {
            console.error('Failed to reset settings:', error);
            SoulSpot.showNotification('Failed to reset settings', 'error');
        }
    }

    // =====================================================
    // Spotify Sync Settings Functions
    // =====================================================
    
    // Hey future me  diese Funktion ldt die Spotify Sync Settings aus der DB.
    // Die API gibt ein SpotifySyncSettingsResponse zurck mit settings-Objekt drin!
    // Die Felder heien auto_sync_enabled, auto_sync_artists etc (mit "auto_" prefix).
    // WICHTIG: Die HTML-IDs folgen dem Muster "spotify-xyz" nicht "sync-xyz-enabled"!
    async function loadSpotifySyncSettings() {
        try {
            const response = await fetch('/api/settings/spotify-sync');
            if (!response.ok) throw new Error('Failed to load Spotify sync settings');
            
            const data = await response.json();
            // API returns { settings: {...}, image_stats: {...} }
            const settings = data.settings || data;
            
            // Master toggle
            const masterToggle = document.getElementById('spotify-auto-sync-enabled');
            if (masterToggle) masterToggle.checked = settings.auto_sync_enabled ?? true;
            
            // Individual sync toggles
            const artistToggle = document.getElementById('spotify-sync-artists');
            if (artistToggle) artistToggle.checked = settings.auto_sync_artists ?? true;
            
            const playlistToggle = document.getElementById('spotify-sync-playlists');
            if (playlistToggle) playlistToggle.checked = settings.auto_sync_playlists ?? true;
            
            const likedToggle = document.getElementById('spotify-sync-liked-songs');
            if (likedToggle) likedToggle.checked = settings.auto_sync_liked_songs ?? true;
            
            const albumsToggle = document.getElementById('spotify-sync-saved-albums');
            if (albumsToggle) albumsToggle.checked = settings.auto_sync_saved_albums ?? true;
            
            // Intervals
            const artistInterval = document.getElementById('artists-sync-interval');
            if (artistInterval) artistInterval.value = settings.artists_sync_interval_minutes ?? 5;
            
            const playlistInterval = document.getElementById('playlists-sync-interval');
            if (playlistInterval) playlistInterval.value = settings.playlists_sync_interval_minutes ?? 10;
            
            // Image download toggle
            const imageToggle = document.getElementById('spotify-download-images');
            if (imageToggle) imageToggle.checked = settings.download_images ?? true;
            
            // Cleanup toggles
            const removeArtists = document.getElementById('spotify-remove-unfollowed-artists');
            if (removeArtists) removeArtists.checked = settings.remove_unfollowed_artists ?? true;
            
            const removePlaylists = document.getElementById('spotify-remove-unfollowed-playlists');
            if (removePlaylists) removePlaylists.checked = settings.remove_unfollowed_playlists ?? false;
            
            // Update UI state based on master toggle
            updateSyncOptionsState(settings.auto_sync_enabled ?? true);
            
            // Load image stats from response if available, otherwise fetch separately
            if (data.image_stats) {
                updateImageStatsDisplay(data.image_stats);
            } else {
                await loadImageStats();
            }
            
        } catch (error) {
            console.error('Failed to load Spotify sync settings:', error);
        }
    }
    
    // Hey future me  diese Funktion speichert die Spotify Sync Settings.
    // Wichtig: Die API erwartet snake_case Keys mit "auto_" prefix!
    // Die Interval-Werte werden als Integer gesendet (Minuten).
    async function saveSpotifySyncSettings() {
        const settings = {
            auto_sync_enabled: document.getElementById('spotify-auto-sync-enabled')?.checked ?? true,
            auto_sync_artists: document.getElementById('spotify-sync-artists')?.checked ?? true,
            auto_sync_playlists: document.getElementById('spotify-sync-playlists')?.checked ?? true,
            auto_sync_liked_songs: document.getElementById('spotify-sync-liked-songs')?.checked ?? true,
            auto_sync_saved_albums: document.getElementById('spotify-sync-saved-albums')?.checked ?? true,
            artists_sync_interval_minutes: parseInt(document.getElementById('artists-sync-interval')?.value) || 5,
            playlists_sync_interval_minutes: parseInt(document.getElementById('playlists-sync-interval')?.value) || 10,
            download_images: document.getElementById('spotify-download-images')?.checked ?? true,
            remove_unfollowed_artists: document.getElementById('spotify-remove-unfollowed-artists')?.checked ?? true,
            remove_unfollowed_playlists: document.getElementById('spotify-remove-unfollowed-playlists')?.checked ?? false,
        };
        
        try {
            const response = await fetch('/api/settings/spotify-sync', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings),
            });
            
            if (!response.ok) throw new Error('Failed to save Spotify sync settings');
            
            SoulSpot.showNotification('Spotify sync settings saved', 'success');
            
            // Update UI state
            updateSyncOptionsState(settings.auto_sync_enabled);
            
        } catch (error) {
            console.error('Failed to save Spotify sync settings:', error);
            SoulSpot.showNotification('Failed to save Spotify sync settings', 'error');
        }
    }
    
    // Hey future me  diese Funktion toggled ein einzelnes Setting und speichert es sofort.
    // Wird von den onchange-Handlern der Toggles aufgerufen.
    // settingName ist der kurze Name ohne "spotify." prefix (z.B. "auto_sync_enabled")
    async function toggleSpotifySyncSetting(settingName) {
        try {
            const response = await fetch(`/api/settings/spotify-sync/toggle/${settingName}`, {
                method: 'POST',
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Toggle failed');
            }
            
            const result = await response.json();
            
            // Update UI state if master toggle changed
            if (settingName === 'auto_sync_enabled') {
                updateSyncOptionsState(result.new_value);
            }
            
            // Subtle feedback - no notification for quick toggles
            console.log(`Toggled ${settingName}: ${result.old_value} -> ${result.new_value}`);
            
        } catch (error) {
            console.error(`Failed to toggle ${settingName}:`, error);
            SoulSpot.showNotification(`Failed to update setting: ${error.message}`, 'error');
            
            // Revert toggle on error
            await loadSpotifySyncSettings();
        }
    }
    
    // Hey future me  diese Funktion triggert einen sofortigen Sync.
    // syncType kann sein: 'artists', 'playlists', 'liked', 'albums', oder 'all'.
    // Die API gibt sofort zurck, der Sync luft im Background.
    // Der Button wird whrend des Syncs disabled um Doppelklicks zu vermeiden.
    async function triggerManualSync(syncType) {
        const button = event?.target?.closest('button');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
        }
        
        try {
            const response = await fetch(`/api/settings/spotify-sync/trigger/${syncType}`, {
                method: 'POST',
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Sync failed');
            }
            
            const result = await response.json();
            SoulSpot.showNotification(result.message || `${syncType} sync started`, 'success');
            
            // Reload image stats after sync
            setTimeout(loadImageStats, 2000);
            
        } catch (error) {
            console.error(`Failed to trigger ${syncType} sync:`, error);
            SoulSpot.showNotification(error.message || `Failed to sync ${syncType}`, 'error');
        } finally {
            if (button) {
                button.disabled = false;
                // Restore original button text based on syncType
                const labels = {
                    'artists': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'playlists': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'liked': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'albums': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'all': '<i class="fas fa-sync mr-2"></i>Sync All Now',
                };
                button.innerHTML = labels[syncType] || '<i class="fas fa-sync mr-2"></i>Sync Now';
            }
        }
    }
    
    // Hey future me  diese Funktion ldt die Image Statistics fr Spotify Images.
    // Die API gibt bytes zurck, wir formatieren das zu human-readable.
    // Wenn keine Images existieren, zeigen wir "0 B" und "0" an.
    async function loadImageStats() {
        try {
            const response = await fetch('/api/settings/spotify-sync/disk-usage');
            if (!response.ok) throw new Error('Failed to load image stats');
            
            const stats = await response.json();
            updateImageStatsDisplay(stats);
            
        } catch (error) {
            console.error('Failed to load image stats:', error);
        }
    }
    
    // Hey future me  separierte Funktion um die Image Stats anzuzeigen.
    // Wird sowohl von loadImageStats als auch von loadSpotifySyncSettings verwendet
    // (wenn die Daten schon in der Response sind).
    // Die HTML-IDs folgen dem Muster "stat-{type}-{count|size}"
    function updateImageStatsDisplay(stats) {
        // Artist images
        const artistsCountEl = document.getElementById('stat-artists-count');
        if (artistsCountEl) artistsCountEl.textContent = stats.artists_count ?? 0;
        const artistsSizeEl = document.getElementById('stat-artists-size');
        if (artistsSizeEl) artistsSizeEl.textContent = formatBytes(stats.artists_bytes ?? 0);
        
        // Album covers
        const albumsCountEl = document.getElementById('stat-albums-count');
        if (albumsCountEl) albumsCountEl.textContent = stats.albums_count ?? 0;
        const albumsSizeEl = document.getElementById('stat-albums-size');
        if (albumsSizeEl) albumsSizeEl.textContent = formatBytes(stats.albums_bytes ?? 0);
        
        // Playlist covers
        const playlistsCountEl = document.getElementById('stat-playlists-count');
        if (playlistsCountEl) playlistsCountEl.textContent = stats.playlists_count ?? 0;
        const playlistsSizeEl = document.getElementById('stat-playlists-size');
        if (playlistsSizeEl) playlistsSizeEl.textContent = formatBytes(stats.playlists_bytes ?? 0);
        
        // Totals
        const totalCountEl = document.getElementById('stat-total-count');
        if (totalCountEl) totalCountEl.textContent = stats.total_count ?? 0;
        const totalSizeEl = document.getElementById('stat-total-size');
        if (totalSizeEl) totalSizeEl.textContent = formatBytes(stats.total_bytes ?? 0);
    }
    
    // Hey future me  simple Bytes-zu-Human-Readable Konvertierung.
    // Nutzt 1024 als Basis (KiB, MiB, GiB) weil das fr Festplatten blicher ist.
    // Bei 0 Bytes geben wir "0 B" zurck, nicht "0 undefined".
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Hey future me  diese Funktion updated den UI State basierend auf dem Master Toggle.
    // Wenn Sync disabled ist, werden alle Sub-Toggles ausgegraut aber behalten ihren Wert.
    // Das ist wichtig damit der User seine Einstellungen nicht verliert wenn er Sync kurz deaktiviert.
    // Die HTML-ID fr die Optionen-Container ist "spotify-sync-options" nicht "sync-options-container"
    function updateSyncOptionsState(enabled) {
        const syncOptions = document.getElementById('spotify-sync-options');
        if (syncOptions) {
            syncOptions.style.opacity = enabled ? '1' : '0.5';
            syncOptions.style.pointerEvents = enabled ? 'auto' : 'none';
        }
    }

    // =====================================================
    // Automation Settings Functions
    // =====================================================
    
    // Hey future me  diese Funktion ldt die Automation Settings aus der DB.
    // Die API gibt ein JSON mit allen Automation-bezogenen Settings zurck.
    // Jeder Worker hat einen enable Toggle und optional Intervall/Optionen.
    async function loadAutomationSettings() {
        try {
            const response = await fetch('/api/settings/automation');
            if (!response.ok) throw new Error('Failed to load automation settings');
            
            const data = await response.json();
            const settings = data.settings || data;
            
            // Watchlist
            const watchlistToggle = document.getElementById('automation-watchlist-enabled');
            if (watchlistToggle) {
                watchlistToggle.checked = settings.watchlist_enabled ?? false;
                updateAutomationOptionsState('watchlist', settings.watchlist_enabled ?? false);
            }
            const watchlistInterval = document.getElementById('watchlist-interval');
            if (watchlistInterval) watchlistInterval.value = settings.watchlist_interval_minutes ?? 60;
            
            // Discography
            const discographyToggle = document.getElementById('automation-discography-enabled');
            if (discographyToggle) {
                discographyToggle.checked = settings.discography_enabled ?? false;
                updateAutomationOptionsState('discography', settings.discography_enabled ?? false);
            }
            const discographyInterval = document.getElementById('discography-interval');
            if (discographyInterval) discographyInterval.value = (settings.discography_interval_hours ?? 24);
            
            // Quality Upgrade
            const qualityToggle = document.getElementById('automation-quality-enabled');
            if (qualityToggle) {
                qualityToggle.checked = settings.quality_upgrade_enabled ?? false;
                updateAutomationOptionsState('quality', settings.quality_upgrade_enabled ?? false);
            }
            const qualityProfile = document.getElementById('quality-profile');
            if (qualityProfile) qualityProfile.value = settings.quality_profile ?? 'high';
            
            // Cleanup
            const cleanupToggle = document.getElementById('automation-cleanup-enabled');
            if (cleanupToggle) {
                cleanupToggle.checked = settings.cleanup_enabled ?? false;
                updateAutomationOptionsState('cleanup', settings.cleanup_enabled ?? false);
            }
            const cleanupRetention = document.getElementById('cleanup-retention');
            if (cleanupRetention) cleanupRetention.value = settings.cleanup_retention_days ?? 7;
            
            // Duplicate Detection
            const duplicateToggle = document.getElementById('automation-duplicate-enabled');
            if (duplicateToggle) {
                duplicateToggle.checked = settings.duplicate_detection_enabled ?? false;
                updateAutomationOptionsState('duplicate', settings.duplicate_detection_enabled ?? false);
            }
            const duplicateInterval = document.getElementById('duplicate-interval');
            if (duplicateInterval) duplicateInterval.value = settings.duplicate_scan_interval_hours ?? 168;
            
        } catch (error) {
            console.error('Failed to load automation settings:', error);
        }
    }
    
    // Hey future me  Einzelne Automation Settings toggeln.
    // Wird bei onChange der Checkboxen aufgerufen.
    // Updated auch den UI State der Options-Sektion.
    async function toggleAutomationSetting(settingName) {
        const checkboxId = `automation-${settingName.replace(/_enabled$/, '').replace(/_/g, '-')}-enabled`;
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        
        const optionsKey = settingName.replace(/_enabled$/, '').replace(/_/g, '-');
        updateAutomationOptionsState(optionsKey, checkbox.checked);
        
        // Auto-save on toggle change
        try {
            const response = await fetch('/api/settings/automation', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [settingName]: checkbox.checked })
            });
            
            if (!response.ok) throw new Error('Failed to update setting');
            
            const status = checkbox.checked ? 'enabled' : 'disabled';
            SoulSpot.showNotification(`${settingName.replace(/_/g, ' ')} ${status}`, 'success');
        } catch (error) {
            console.error('Failed to toggle automation setting:', error);
            SoulSpot.showNotification('Failed to update setting', 'error');
        }
    }
    
    // Hey future me  Updated den UI State der Options-Sektion fr einen Worker.
    // Wenn disabled, werden die Optionen ausgegraut aber behalten ihren Wert.
    function updateAutomationOptionsState(workerKey, enabled) {
        // Map worker key to options container ID
        const containerMap = {
            'watchlist': 'watchlist-options',
            'discography': 'discography-options', 
            'quality': 'quality-options',
            'cleanup': 'cleanup-options',
            'duplicate': 'duplicate-options',
            'duplicate-detection': 'duplicate-options',
            'quality-upgrade': 'quality-options',
        };
        
        const containerId = containerMap[workerKey] || `${workerKey}-options`;
        const container = document.getElementById(containerId);
        if (container) {
            container.style.opacity = enabled ? '1' : '0.5';
            container.style.pointerEvents = enabled ? 'auto' : 'none';
        }
    }
    
    // Hey future me  Speichert alle Automation Settings auf einmal.
    // Wird beim Klick auf "Save Automation Settings" aufgerufen.
    async function saveAutomationSettings() {
        const settings = {
            watchlist_enabled: document.getElementById('automation-watchlist-enabled')?.checked ?? false,
            watchlist_interval_minutes: parseInt(document.getElementById('watchlist-interval')?.value) || 60,
            discography_enabled: document.getElementById('automation-discography-enabled')?.checked ?? false,
            discography_interval_hours: parseInt(document.getElementById('discography-interval')?.value) || 24,
            quality_upgrade_enabled: document.getElementById('automation-quality-enabled')?.checked ?? false,
            quality_profile: document.getElementById('quality-profile')?.value || 'high',
            cleanup_enabled: document.getElementById('automation-cleanup-enabled')?.checked ?? false,
            cleanup_retention_days: parseInt(document.getElementById('cleanup-retention')?.value) || 7,
            duplicate_detection_enabled: document.getElementById('automation-duplicate-enabled')?.checked ?? false,
            duplicate_scan_interval_hours: parseInt(document.getElementById('duplicate-interval')?.value) || 168,
        };
        
        try {
            const response = await fetch('/api/settings/automation', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            
            if (!response.ok) throw new Error('Failed to save automation settings');
            
            SoulSpot.showNotification('Automation settings saved', 'success');
        } catch (error) {
            console.error('Failed to save automation settings:', error);
            SoulSpot.showNotification('Failed to save automation settings', 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initThemeSelection();
        loadSettings();
        loadSpotifySyncSettings();
        loadAutomationSettings();
        loadNamingSettings();
    });

    // =====================================================
    // Library Naming Settings Functions
    // =====================================================
    
    // Hey future me  diese Funktion ldt die Naming Settings aus der DB.
    // Die API gibt alle naming.* Settings als JSON zurck.
    // Wichtig: Die Felder sind snake_case (artist_folder_format) nicht camelCase!
    async function loadNamingSettings() {
        try {
            const response = await fetch('/api/settings/naming');
            if (!response.ok) throw new Error('Failed to load naming settings');
            
            const settings = await response.json();
            
            // Template formats
            const artistFolder = document.getElementById('naming-artist-folder');
            if (artistFolder) artistFolder.value = settings.artist_folder_format || '{Artist Name}';
            
            const albumFolder = document.getElementById('naming-album-folder');
            if (albumFolder) albumFolder.value = settings.album_folder_format || '{Album Title} ({Release Year})';
            
            const trackFormat = document.getElementById('naming-track-format');
            if (trackFormat) trackFormat.value = settings.standard_track_format || '{Track Number:00} - {Track Title}';
            
            const multiDiscFormat = document.getElementById('naming-multi-disc-format');
            if (multiDiscFormat) multiDiscFormat.value = settings.multi_disc_track_format || '{Medium:00}-{Track Number:00} - {Track Title}';
            
            // Behavior toggles
            const renameTracks = document.getElementById('naming-rename-tracks');
            if (renameTracks) renameTracks.checked = settings.rename_tracks ?? true;
            
            const replaceIllegal = document.getElementById('naming-replace-illegal');
            if (replaceIllegal) replaceIllegal.checked = settings.replace_illegal_characters ?? true;
            
            const createArtistFolder = document.getElementById('naming-create-artist-folder');
            if (createArtistFolder) createArtistFolder.checked = settings.create_artist_folder ?? true;
            
            const createAlbumFolder = document.getElementById('naming-create-album-folder');
            if (createAlbumFolder) createAlbumFolder.checked = settings.create_album_folder ?? true;
            
            // Character replacements
            const colonReplacement = document.getElementById('naming-colon-replacement');
            if (colonReplacement) colonReplacement.value = settings.colon_replacement || ' -';
            
            const slashReplacement = document.getElementById('naming-slash-replacement');
            if (slashReplacement) slashReplacement.value = settings.slash_replacement || '-';
            
            // Update preview
            updateNamingPreview();
            
            // Also load enrichment settings
            await loadEnrichmentSettings();
            
        } catch (error) {
            console.error('Failed to load naming settings:', error);
        }
    }
    
    // Hey future me  Ldt das Enrichment-Setting (nur ein Boolean Toggle).
    // Separate Funktion damit es auch beim Tab-Wechsel aufgerufen werden kann.
    async function loadEnrichmentSettings() {
        try {
            const response = await fetch('/api/settings/library/enrichment');
            if (!response.ok) throw new Error('Failed to load enrichment settings');
            
            const settings = await response.json();
            
            const enrichmentToggle = document.getElementById('enrichment-auto-enabled');
            if (enrichmentToggle) {
                enrichmentToggle.checked = settings.auto_enrichment_enabled ?? true;
            }
        } catch (error) {
            console.error('Failed to load enrichment settings:', error);
        }
    }
    
    // Hey future me  diese Funktion speichert alle Naming Settings auf einmal.
    // Die API validiert die Templates und gibt 400 zurck bei ungltigen Variablen.
    async function saveNamingSettings() {
        const settings = {
            artist_folder_format: document.getElementById('naming-artist-folder')?.value || '{Artist Name}',
            album_folder_format: document.getElementById('naming-album-folder')?.value || '{Album Title} ({Release Year})',
            standard_track_format: document.getElementById('naming-track-format')?.value || '{Track Number:00} - {Track Title}',
            multi_disc_track_format: document.getElementById('naming-multi-disc-format')?.value || '{Medium:00}-{Track Number:00} - {Track Title}',
            rename_tracks: document.getElementById('naming-rename-tracks')?.checked ?? true,
            replace_illegal_characters: document.getElementById('naming-replace-illegal')?.checked ?? true,
            create_artist_folder: document.getElementById('naming-create-artist-folder')?.checked ?? true,
            create_album_folder: document.getElementById('naming-create-album-folder')?.checked ?? true,
            colon_replacement: document.getElementById('naming-colon-replacement')?.value || ' -',
            slash_replacement: document.getElementById('naming-slash-replacement')?.value || '-',
        };
        
        try {
            const response = await fetch('/api/settings/naming', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save naming settings');
            }
            
            SoulSpot.showNotification('Library settings saved', 'success');
        } catch (error) {
            console.error('Failed to save naming settings:', error);
            SoulSpot.showNotification(error.message || 'Failed to save settings', 'error');
        }
    }
    
    // Hey future me  Einzelne Boolean Settings toggeln ohne alle zu speichern.
    // Diese Methode verwendet PATCH statt PUT fr einzelne nderungen.
    async function toggleNamingSetting(settingName) {
        // For naming settings, we just update the preview and let the user save manually
        // This is different from Spotify settings which auto-save on toggle
        updateNamingPreview();
    }
    
    // Hey future me  Validiert ein einzelnes Template und zeigt Fehler an.
    // Ruft die /api/settings/naming/validate API auf.
    // Bei Fehler wird die Fehlermeldung unter dem Input angezeigt.
    async function validateNamingTemplate(template, fieldId) {
        const errorEl = document.getElementById(`${fieldId}-error`);
        if (!errorEl) return true;
        
        try {
            const response = await fetch('/api/settings/naming/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ template })
            });
            
            const result = await response.json();
            
            if (result.valid) {
                errorEl.style.display = 'none';
                return true;
            } else {
                errorEl.textContent = `Unknown variables: ${result.invalid_variables.join(', ')}`;
                errorEl.style.display = 'block';
                return false;
            }
        } catch (error) {
            console.error('Validation error:', error);
            return true; // Don't block on validation errors
        }
    }
    
    // Hey future me  Validiert alle Templates und aktualisiert die Preview.
    // Wird bei jedem Input-Event aufgerufen (debounced wre besser!).
    let namingValidationTimeout;
    async function validateAndPreviewNaming() {
        // Debounce validation to avoid too many API calls
        clearTimeout(namingValidationTimeout);
        namingValidationTimeout = setTimeout(async () => {
            const artistFolder = document.getElementById('naming-artist-folder')?.value;
            const albumFolder = document.getElementById('naming-album-folder')?.value;
            const trackFormat = document.getElementById('naming-track-format')?.value;
            const multiDiscFormat = document.getElementById('naming-multi-disc-format')?.value;
            
            // Validate all templates
            await Promise.all([
                validateNamingTemplate(artistFolder, 'naming-artist-folder'),
                validateNamingTemplate(albumFolder, 'naming-album-folder'),
                validateNamingTemplate(trackFormat, 'naming-track-format'),
                validateNamingTemplate(multiDiscFormat, 'naming-multi-disc-format'),
            ]);
            
            // Update preview
            updateNamingPreview();
        }, 300);
    }
    
    // Hey future me  Aktualisiert die Live Preview mit Sample-Daten.
    // Ersetzt die Variablen durch Beispielwerte (Pink Floyd, The Dark Side of the Moon, etc.)
    function updateNamingPreview() {
        const sampleData = {
            'Artist Name': 'Pink Floyd',
            'Artist CleanName': 'Pink Floyd',
            'Album Title': 'The Dark Side of the Moon',
            'Album CleanTitle': 'The Dark Side of the Moon',
            'Album Type': 'Album',
            'Release Year': '1973',
            'Track Title': 'Speak to Me',
            'Track CleanTitle': 'Speak to Me',
            'Track Number': '1',
            'Track Number:00': '01',
            'Medium': '1',
            'Medium:00': '01',
            // Legacy variables
            'artist': 'Pink Floyd',
            'album': 'The Dark Side of the Moon',
            'title': 'Speak to Me',
            'track': '1',
            'track:02d': '01',
            'year': '1973',
            'disc': '1',
        };
        
        function renderTemplate(template) {
            let result = template;
            for (const [key, value] of Object.entries(sampleData)) {
                result = result.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
            }
            return result;
        }
        
        const artistFolder = document.getElementById('naming-artist-folder')?.value || '{Artist Name}';
        const albumFolder = document.getElementById('naming-album-folder')?.value || '{Album Title} ({Release Year})';
        const trackFormat = document.getElementById('naming-track-format')?.value || '{Track Number:00} - {Track Title}';
        
        const previewArtist = document.getElementById('preview-artist');
        const previewAlbum = document.getElementById('preview-album');
        const previewTrack = document.getElementById('preview-track');
        
        if (previewArtist) previewArtist.textContent = renderTemplate(artistFolder) + '/';
        if (previewAlbum) previewAlbum.textContent = renderTemplate(albumFolder) + '/';
        if (previewTrack) previewTrack.textContent = renderTemplate(trackFormat) + '.flac';
    }
    
    // Hey future me  Preview fr Batch Rename.
    // Zeigt an welche Dateien umbenannt wrden (Dry Run).
    // Ruft GET /api/library/batch-rename/preview auf und zeigt Ergebnisse in Tabelle.
    async function previewBatchRename() {
        const previewContainer = document.getElementById('batch-rename-preview');
        const batchRenameBtn = document.getElementById('btn-batch-rename');
        
        if (!previewContainer) return;
        
        previewContainer.innerHTML = '<div style="text-align: center; padding: var(--space-4);"><i class="fa-solid fa-spinner fa-spin"></i> Scanning library...</div>';
        previewContainer.style.display = 'block';
        
        try {
            const response = await fetch('/api/library/batch-rename/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 100 })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.total_files === 0) {
                previewContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fa-solid fa-info-circle"></i>
                        <span>No files found in library or rename_tracks is disabled.</span>
                    </div>
                `;
                return;
            }
            
            if (data.files_to_rename === 0) {
                previewContainer.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fa-solid fa-check-circle"></i>
                        <span>All ${data.total_files} files already match the naming template!</span>
                    </div>
                `;
                return;
            }
            
            // Build preview table
            let html = `
                <div class="alert alert-info" style="margin-bottom: var(--space-3);">
                    <i class="fa-solid fa-info-circle"></i>
                    <span><strong>${data.files_to_rename}</strong> of ${data.total_files} files would be renamed.</span>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-default); border-radius: var(--radius-md);">
                    <table class="table" style="margin: 0;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="width: 50%;">Current Path</th>
                                <th style="width: 50%;">New Path</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (const item of data.preview) {
                if (!item.will_change) continue;
                
                const currentPath = item.current_path.split('/').slice(-3).join('/');
                const newPath = item.new_path.split('/').slice(-3).join('/');
                
                html += `
                    <tr>
                        <td style="font-size: var(--font-size-sm); word-break: break-all;">${currentPath}</td>
                        <td style="font-size: var(--font-size-sm); word-break: break-all; color: var(--text-success);">${newPath}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table></div>';
            previewContainer.innerHTML = html;
            
            // Enable the batch rename button after preview
            if (batchRenameBtn) batchRenameBtn.disabled = false;
            
        } catch (error) {
            console.error('Failed to preview batch rename:', error);
            previewContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span>Failed to generate preview: ${error.message}</span>
                </div>
            `;
        }
    }
    
    // Hey future me  Startet den Batch Rename Prozess.
    // ACHTUNG: Das ist eine destruktive Operation! Dateien werden umbenannt.
    // Ruft POST /api/library/batch-rename mit dry_run=false auf.
    async function startBatchRename() {
        if (!confirm('Are you sure you want to rename library files? This cannot be undone.\n\nMake sure Lidarr is not scanning at the same time!')) {
            return;
        }
        
        const batchRenameBtn = document.getElementById('btn-batch-rename');
        const previewContainer = document.getElementById('batch-rename-preview');
        
        if (batchRenameBtn) {
            batchRenameBtn.disabled = true;
            batchRenameBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Renaming...';
        }
        
        try {
            const response = await fetch('/api/library/batch-rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dry_run: false })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Show results
            if (previewContainer) {
                if (data.failed > 0) {
                    previewContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <span>Batch rename completed with errors: <strong>${data.successful}</strong> successful, <strong>${data.failed}</strong> failed.</span>
                        </div>
                    `;
                } else {
                    previewContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fa-solid fa-check-circle"></i>
                            <span>Batch rename completed successfully! <strong>${data.successful}</strong> files renamed.</span>
                        </div>
                    `;
                }
            }
            
            SoulSpot.showNotification(`Batch rename: ${data.successful} files renamed`, data.failed > 0 ? 'warning' : 'success');
            
        } catch (error) {
            console.error('Failed to start batch rename:', error);
            SoulSpot.showNotification('Failed to start batch rename: ' + error.message, 'error');
            
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fa-solid fa-times-circle"></i>
                        <span>Batch rename failed: ${error.message}</span>
                    </div>
                `;
            }
        } finally {
            if (batchRenameBtn) {
                batchRenameBtn.disabled = true;
                batchRenameBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Rename Files';
            }
        }
    }
    
    // =========================================================================
    // ENRICHMENT FUNCTION
    // Hey future me - Simplified! Just one toggle for auto-enrichment.
    // No manual buttons needed - enrichment runs automatically after library scan.
    // =========================================================================
    
    async function toggleEnrichmentSetting(setting) {
        // Get current value from checkbox
        const checkbox = document.getElementById('enrichment-auto-enabled');
        if (!checkbox) return;
        
        const value = checkbox.checked;
        
        try {
            const response = await fetch('/api/settings/library/enrichment', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto_enrichment_enabled: value })
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const status = value ? 'enabled' : 'disabled';
            SoulSpot.showNotification(`Auto-enrichment ${status}`, 'success');
        } catch (error) {
            console.error('Failed to update enrichment setting:', error);
            SoulSpot.showNotification('Failed to update setting', 'error');
            // Revert checkbox on error
            checkbox.checked = !value;
        }
    }
</script>
{% endblock %}