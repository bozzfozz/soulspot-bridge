{# Hey future me - Settings page with tabbed interface!
   Tabs: General, Integration, Downloads, Appearance, Advanced.
   All the JS logic for tab switching, form validation, and API calls is at the bottom.
   Password fields have toggle buttons - watch for the onclick handler! #}

{% extends "base.html" %}

{% block title %}Settings - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-6); flex-wrap: wrap; gap: var(--space-4);">
    <div style="display: flex; align-items: center; gap: var(--space-4);">
        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-secondary), #7c3aed); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-cog" style="color: white; font-size: 1.25rem;"></i>
        </div>
        <div>
            <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-1);">Settings</h1>
            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Configure your SoulSpot instance</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button class="btn btn-outline" onclick="confirmReset()">
            <i class="fa-solid fa-rotate-left"></i>
            Reset to Defaults
        </button>
        <button class="btn btn-primary" onclick="saveSettings()">
            <i class="fa-solid fa-save"></i>
            Save Changes
        </button>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="card" style="margin-bottom: var(--space-6);">
    <div class="tabs-nav" style="display: flex; border-bottom: 1px solid var(--border-primary); overflow-x: auto;">
        <button class="tab-btn active" data-tab="general" onclick="switchTab('general')">
            <i class="fa-solid fa-sliders"></i>
            General
        </button>
        <button class="tab-btn" data-tab="integration" onclick="switchTab('integration')">
            <i class="fa-solid fa-plug"></i>
            Integration
        </button>
        <button class="tab-btn" data-tab="download" onclick="switchTab('download')">
            <i class="fa-solid fa-download"></i>
            Downloads
        </button>
        <button class="tab-btn" data-tab="appearance" onclick="switchTab('appearance')">
            <i class="fa-solid fa-palette"></i>
            Appearance
        </button>
        <button class="tab-btn" data-tab="advanced" onclick="switchTab('advanced')">
            <i class="fa-solid fa-gear"></i>
            Advanced
        </button>
    </div>
</div>

<!-- Settings Form -->
<form id="settings-form" onsubmit="saveSettings(event)">
    <!-- General Settings Tab -->
    <div id="tab-general" class="tab-content">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">General Settings</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="app-name">Application Name</label>
                    <input type="text" id="app-name" name="general.app_name" class="form-input" value="SoulSpot" required>
                    <p class="form-helper">Display name for the application</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="log-level">Log Level</label>
                    <select id="log-level" name="general.log_level" class="form-input" required>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                    <p class="form-helper">Logging verbosity level</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="debug-mode" name="general.debug" style="accent-color: var(--accent-primary);">
                        <span>Enable Debug Mode</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Show detailed debug information (not recommended for production)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Settings Tab -->
    <div id="tab-integration" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Spotify -->
            <div style="margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-brands fa-spotify" style="color: #1DB954;"></i>
                    Spotify Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="spotify-client-id">Client ID</label>
                        <input type="text" id="spotify-client-id" name="integration.spotify_client_id" class="form-input" placeholder="Your Spotify Client ID">
                        <p class="form-helper">Get this from <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: var(--accent-primary);">Spotify Developer Dashboard</a></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-client-secret">Client Secret</label>
                        <div class="input-with-toggle">
                            <input type="password" id="spotify-client-secret" name="integration.spotify_client_secret" class="form-input" placeholder="Your Spotify Client Secret">
                            <button type="button" class="btn-icon" onclick="togglePassword('spotify-client-secret')" title="Toggle visibility">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-redirect-uri">Redirect URI</label>
                        <input type="url" id="spotify-redirect-uri" name="integration.spotify_redirect_uri" class="form-input" value="http://localhost:8000/api/auth/callback">
                    </div>
                </div>
            </div>

            <!-- slskd -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary); margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-server" style="color: #3b82f6;"></i>
                    slskd Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="slskd-url">slskd URL</label>
                        <input type="url" id="slskd-url" name="integration.slskd_url" class="form-input" value="http://localhost:5030" required>
                        <p class="form-helper">Base URL for your slskd instance</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="slskd-username">Username</label>
                            <input type="text" id="slskd-username" name="integration.slskd_username" class="form-input" value="admin" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="slskd-password">Password</label>
                            <div class="input-with-toggle">
                                <input type="password" id="slskd-password" name="integration.slskd_password" class="form-input" placeholder="slskd password">
                                <button type="button" class="btn-icon" onclick="togglePassword('slskd-password')" title="Toggle visibility">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="slskd-api-key">API Key (Optional)</label>
                        <div class="input-with-toggle">
                            <input type="password" id="slskd-api-key" name="integration.slskd_api_key" class="form-input" placeholder="Optional API key">
                            <button type="button" class="btn-icon" onclick="togglePassword('slskd-api-key')" title="Toggle visibility">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MusicBrainz -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-music" style="color: #ba478f;"></i>
                    MusicBrainz Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-app-name">Application Name</label>
                        <input type="text" id="musicbrainz-app-name" name="integration.musicbrainz_app_name" class="form-input" value="SoulSpot" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-contact">Contact Email</label>
                        <input type="email" id="musicbrainz-contact" name="integration.musicbrainz_contact" class="form-input" placeholder="your@email.com">
                        <p class="form-helper">MusicBrainz requires a contact email for API access</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Settings Tab -->
    <div id="tab-download" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Download Queue Configuration</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="max-concurrent-downloads">Maximum Concurrent Downloads</label>
                    <input type="number" id="max-concurrent-downloads" name="download.max_concurrent_downloads" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of downloads that can run simultaneously (1-10, recommended: 3)</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="default-max-retries">Default Maximum Retries</label>
                    <input type="number" id="default-max-retries" name="download.default_max_retries" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of retry attempts for failed downloads (1-10)</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable-priority-queue" name="download.enable_priority_queue" checked style="accent-color: var(--accent-primary);">
                        <span>Enable Priority Queue</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Allow downloads to be prioritized (P0/P1/P2)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Settings Tab -->
    <div id="tab-appearance" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Theme & Appearance</h2>
            
            <div class="form-group">
                <label class="form-label">Theme</label>
                <div class="theme-options">
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="dark" checked onclick="applyTheme('dark')">
                        <div class="theme-card">
                            <i class="fa-solid fa-moon" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Dark</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="light" onclick="applyTheme('light')">
                        <div class="theme-card">
                            <i class="fa-solid fa-sun" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Light</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="auto" onclick="applyTheme('auto')">
                        <div class="theme-card">
                            <i class="fa-solid fa-circle-half-stroke" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Auto</span>
                        </div>
                    </label>
                </div>
                <p class="form-helper" style="margin-top: var(--space-3);">Choose how the application looks. Auto follows your system preferences.</p>
            </div>

            <div class="alert alert-info" style="margin-top: var(--space-6);">
                <i class="fa-solid fa-info-circle"></i>
                <span><strong>Theme Persistence:</strong> Your theme preference is saved in your browser and will be remembered on future visits.</span>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Tab -->
    <div id="tab-advanced" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Advanced Configuration</h2>
            
            <div class="alert alert-warning" style="margin-bottom: var(--space-6);">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span><strong>Warning:</strong> Changing these settings may affect application stability. Proceed with caution.</span>
            </div>

            <div style="margin-bottom: var(--space-8);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">API Server</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="api-host">API Host</label>
                            <input type="text" id="api-host" name="advanced.api_host" class="form-input" value="0.0.0.0" required>
                            <p class="form-helper">Host address to bind the API server to</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="api-port">API Port</label>
                            <input type="number" id="api-port" name="advanced.api_port" class="form-input" value="8000" min="1" max="65535" required>
                            <p class="form-helper">Port number for the API server (1-65535)</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="secure-cookies" name="advanced.secure_cookies" style="accent-color: var(--accent-primary);">
                            <span>Use Secure Cookies</span>
                        </label>
                        <p class="form-helper" style="margin-left: 1.75rem;">Enable for HTTPS deployments (production only)</p>
                    </div>
                </div>
            </div>

            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Circuit Breaker</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-failure-threshold">Failure Threshold</label>
                            <input type="number" id="circuit-breaker-failure-threshold" name="advanced.circuit_breaker_failure_threshold" class="form-input" value="5" min="1" required>
                            <p class="form-helper">Number of failures before opening the circuit</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-timeout">Timeout (seconds)</label>
                            <input type="number" id="circuit-breaker-timeout" name="advanced.circuit_breaker_timeout" class="form-input" value="60" min="1" step="0.1" required>
                            <p class="form-helper">Time to wait before attempting recovery</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<style>
    .tab-btn {
        padding: var(--space-3) var(--space-5);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        transition: all var(--transition-fast);
        white-space: nowrap;
    }
    .tab-btn:hover {
        color: var(--text-primary);
    }
    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    .form-stack {
        display: flex;
        flex-direction: column;
        gap: var(--space-5);
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    .form-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }
    .form-helper {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
    }
    .input-with-toggle {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-with-toggle .form-input {
        padding-right: 2.5rem;
    }
    .input-with-toggle .btn-icon {
        position: absolute;
        right: var(--space-2);
    }
    .theme-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-4);
    }
    .theme-option {
        cursor: pointer;
    }
    .theme-option input {
        display: none;
    }
    .theme-card {
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        text-align: center;
        transition: all var(--transition-fast);
    }
    .theme-option input:checked + .theme-card {
        border-color: var(--accent-primary);
        background: rgba(var(--accent-primary-rgb), 0.1);
    }
    .theme-card:hover {
        border-color: var(--text-muted);
    }
    .alert {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-md);
    }
    .alert-info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }
    .alert-warning {
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
    }
</style>
<script>
    // Hey future me - All the settings page logic is here!
    // Tab switching, password toggles, theme application, form save/load.
    // The API endpoints are /api/settings/ for GET/POST.

    // Tab Switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id === `tab-${tabName}` ? 'block' : 'none';
        });
    }

    // Password Toggle
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = field.nextElementSibling?.querySelector('i') || field.parentElement.querySelector('.btn-icon i');
        if (field.type === 'password') {
            field.type = 'text';
            if (icon) icon.className = 'fa-solid fa-eye-slash';
        } else {
            field.type = 'password';
            if (icon) icon.className = 'fa-solid fa-eye';
        }
    }

    // Theme Management
    function applyTheme(theme) {
        localStorage.setItem('theme', theme);
        SoulSpot.showNotification(`Theme set to ${theme}`, 'success');
    }

    // Load Settings from API
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings/');
            if (!response.ok) throw new Error('Failed to load settings');
            
            const settings = await response.json();
            
            if (settings.general) {
                document.getElementById('app-name').value = settings.general.app_name || 'SoulSpot';
                document.getElementById('log-level').value = settings.general.log_level || 'INFO';
                document.getElementById('debug-mode').checked = settings.general.debug || false;
            }
            
            if (settings.integration) {
                document.getElementById('spotify-client-id').value = settings.integration.spotify_client_id || '';
                document.getElementById('spotify-redirect-uri').value = settings.integration.spotify_redirect_uri || 'http://localhost:8000/api/auth/callback';
                document.getElementById('slskd-url').value = settings.integration.slskd_url || 'http://localhost:5030';
                document.getElementById('slskd-username').value = settings.integration.slskd_username || 'admin';
                document.getElementById('musicbrainz-app-name').value = settings.integration.musicbrainz_app_name || 'SoulSpot';
                document.getElementById('musicbrainz-contact').value = settings.integration.musicbrainz_contact || '';
            }
            
            if (settings.download) {
                document.getElementById('max-concurrent-downloads').value = settings.download.max_concurrent_downloads || 3;
                document.getElementById('default-max-retries').value = settings.download.default_max_retries || 3;
                document.getElementById('enable-priority-queue').checked = settings.download.enable_priority_queue !== false;
            }
            
            if (settings.advanced) {
                document.getElementById('api-host').value = settings.advanced.api_host || '0.0.0.0';
                document.getElementById('api-port').value = settings.advanced.api_port || 8000;
                document.getElementById('secure-cookies').checked = settings.advanced.secure_cookies || false;
                document.getElementById('circuit-breaker-failure-threshold').value = settings.advanced.circuit_breaker_failure_threshold || 5;
                document.getElementById('circuit-breaker-timeout').value = settings.advanced.circuit_breaker_timeout || 60;
            }
            
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    // Save Settings
    async function saveSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('settings-form');
        const formData = new FormData(form);
        
        const settings = {
            general: {
                app_name: formData.get('general.app_name'),
                log_level: formData.get('general.log_level'),
                debug: document.getElementById('debug-mode').checked,
            },
            integration: {
                spotify_client_id: formData.get('integration.spotify_client_id'),
                spotify_client_secret: formData.get('integration.spotify_client_secret'),
                spotify_redirect_uri: formData.get('integration.spotify_redirect_uri'),
                slskd_url: formData.get('integration.slskd_url'),
                slskd_username: formData.get('integration.slskd_username'),
                slskd_password: formData.get('integration.slskd_password'),
                slskd_api_key: formData.get('integration.slskd_api_key') || null,
                musicbrainz_app_name: formData.get('integration.musicbrainz_app_name'),
                musicbrainz_contact: formData.get('integration.musicbrainz_contact'),
            },
            download: {
                max_concurrent_downloads: parseInt(formData.get('download.max_concurrent_downloads')),
                default_max_retries: parseInt(formData.get('download.default_max_retries')),
                enable_priority_queue: document.getElementById('enable-priority-queue').checked,
            },
            appearance: {
                theme: formData.get('appearance.theme'),
            },
            advanced: {
                api_host: formData.get('advanced.api_host'),
                api_port: parseInt(formData.get('advanced.api_port')),
                secure_cookies: document.getElementById('secure-cookies').checked,
                circuit_breaker_failure_threshold: parseInt(formData.get('advanced.circuit_breaker_failure_threshold')),
                circuit_breaker_timeout: parseFloat(formData.get('advanced.circuit_breaker_timeout')),
            },
        };
        
        try {
            const response = await fetch('/api/settings/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings),
            });
            
            if (!response.ok) throw new Error('Failed to save settings');
            
            SoulSpot.showNotification('Settings saved successfully', 'success');
        } catch (error) {
            console.error('Failed to save settings:', error);
            SoulSpot.showNotification('Failed to save settings', 'error');
        }
    }

    // Confirm Reset
    async function confirmReset() {
        if (!confirm('Are you sure you want to reset all settings to their default values?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/settings/reset', {method: 'POST'});
            if (!response.ok) throw new Error('Failed to reset settings');
            
            SoulSpot.showNotification('Settings reset to defaults', 'success');
            await loadSettings();
        } catch (error) {
            console.error('Failed to reset settings:', error);
            SoulSpot.showNotification('Failed to reset settings', 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
    });
</script>
{% endblock %}
