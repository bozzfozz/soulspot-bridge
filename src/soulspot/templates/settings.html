{# Hey future me - Settings page with tabbed interface!
   Tabs: General, Integration, Downloads, Appearance, Advanced.
   All the JS logic for tab switching, form validation, and API calls is at the bottom.
   Password fields have toggle buttons - watch for the onclick handler! #}

{% extends "base.html" %}

{% block title %}Settings - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-6); flex-wrap: wrap; gap: var(--space-4);">
    <div style="display: flex; align-items: center; gap: var(--space-4);">
        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-secondary), #7c3aed); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-cog" style="color: white; font-size: 1.25rem;"></i>
        </div>
        <div>
            <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-1);">Settings</h1>
            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Configure your SoulSpot instance</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button class="btn btn-outline" onclick="confirmReset()">
            <i class="fa-solid fa-rotate-left"></i>
            Reset to Defaults
        </button>
        <button class="btn btn-primary" onclick="saveSettings()">
            <i class="fa-solid fa-save"></i>
            Save Changes
        </button>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="card" style="margin-bottom: var(--space-6);">
    <div class="tabs-nav" style="display: flex; border-bottom: 1px solid var(--border-primary); overflow-x: auto;">
        <button class="tab-btn active" data-tab="general" onclick="switchTab('general')">
            <i class="fa-solid fa-sliders"></i>
            General
        </button>
        <button class="tab-btn" data-tab="spotify-sync" onclick="switchTab('spotify-sync')">
            <i class="fa-brands fa-spotify" style="color: #1DB954;"></i>
            Spotify Sync
        </button>
        <button class="tab-btn" data-tab="integration" onclick="switchTab('integration')">
            <i class="fa-solid fa-plug"></i>
            Integration
        </button>
        <button class="tab-btn" data-tab="download" onclick="switchTab('download')">
            <i class="fa-solid fa-download"></i>
            Downloads
        </button>
        <button class="tab-btn" data-tab="appearance" onclick="switchTab('appearance')">
            <i class="fa-solid fa-palette"></i>
            Appearance
        </button>
        <button class="tab-btn" data-tab="advanced" onclick="switchTab('advanced')">
            <i class="fa-solid fa-gear"></i>
            Advanced
        </button>
    </div>
</div>

<!-- Settings Form -->
<form id="settings-form" onsubmit="saveSettings(event)">
    <!-- General Settings Tab -->
    <div id="tab-general" class="tab-content">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">General Settings</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="app-name">Application Name</label>
                    <input type="text" id="app-name" name="general.app_name" class="form-input" value="SoulSpot" required>
                    <p class="form-helper">Display name for the application</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="log-level">Log Level</label>
                    <select id="log-level" name="general.log_level" class="form-input" required>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                    <p class="form-helper">Logging verbosity level</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="debug-mode" name="general.debug" style="accent-color: var(--accent-primary);">
                        <span>Enable Debug Mode</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Show detailed debug information (not recommended for production)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Spotify Sync Settings Tab -->
    <div id="tab-spotify-sync" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Master Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-primary);">
                <div>
                    <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                        <i class="fa-brands fa-spotify" style="color: #1DB954; margin-right: var(--space-2);"></i>
                        Spotify Auto-Sync
                    </h2>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Automatically sync data from your Spotify account</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="spotify-auto-sync-enabled" checked onchange="toggleSpotifySyncSetting('auto_sync_enabled')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Sync Types -->
            <div class="form-stack" id="spotify-sync-options">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">What to Sync</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #1DB954, #169c46);">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Followed Artists</div>
                            <div class="sync-option-desc">Sync artists you follow on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-artists" checked onchange="toggleSpotifySyncSetting('auto_sync_artists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #7c3aed, #6366f1);">
                            <i class="fa-solid fa-list-music"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Playlists</div>
                            <div class="sync-option-desc">Sync your Spotify playlists</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-playlists" checked onchange="toggleSpotifySyncSetting('auto_sync_playlists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fa-solid fa-heart"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Liked Songs</div>
                            <div class="sync-option-desc">Sync your Liked Songs playlist</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-liked-songs" checked onchange="toggleSpotifySyncSetting('auto_sync_liked_songs')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fa-solid fa-compact-disc"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Saved Albums</div>
                            <div class="sync-option-desc">Sync albums you've saved to your library</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-sync-saved-albums" checked onchange="toggleSpotifySyncSetting('auto_sync_saved_albums')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Sync Intervals -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Sync Intervals</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="artists-sync-interval">Artists Sync Cooldown</label>
                        <div class="input-with-suffix">
                            <input type="number" id="artists-sync-interval" class="form-input" value="5" min="1" max="60" style="max-width: 100px;">
                            <span class="input-suffix">minutes</span>
                        </div>
                        <p class="form-helper">Minimum time between artist sync runs</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="playlists-sync-interval">Playlists Sync Cooldown</label>
                        <div class="input-with-suffix">
                            <input type="number" id="playlists-sync-interval" class="form-input" value="10" min="1" max="60" style="max-width: 100px;">
                            <span class="input-suffix">minutes</span>
                        </div>
                        <p class="form-helper">Minimum time between playlist sync runs</p>
                    </div>
                </div>
            </div>

            <!-- Image Download -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Image Storage</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fa-solid fa-images"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Download Images Locally</div>
                            <div class="sync-option-desc">Store artist, album, and playlist images on disk for offline access</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-download-images" checked onchange="toggleSpotifySyncSetting('download_images')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Disk Usage Stats -->
                <div id="image-stats-container" class="stats-container" style="margin-top: var(--space-4);">
                    <div class="stat-box">
                        <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-artists-count">-</div>
                            <div class="stat-label">Artist Images</div>
                            <div class="stat-size" id="stat-artists-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon"><i class="fa-solid fa-compact-disc"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-albums-count">-</div>
                            <div class="stat-label">Album Covers</div>
                            <div class="stat-size" id="stat-albums-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon"><i class="fa-solid fa-list-music"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-playlists-count">-</div>
                            <div class="stat-label">Playlist Covers</div>
                            <div class="stat-size" id="stat-playlists-size">-</div>
                        </div>
                    </div>
                    <div class="stat-box stat-total">
                        <div class="stat-icon"><i class="fa-solid fa-hard-drive"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-count">-</div>
                            <div class="stat-label">Total Images</div>
                            <div class="stat-size" id="stat-total-size">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cleanup Behavior -->
            <div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Cleanup Behavior</h3>
                
                <div class="sync-option-card">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">
                            <i class="fa-solid fa-user-minus"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Remove Unfollowed Artists</div>
                            <div class="sync-option-desc">Automatically remove artists when you unfollow them on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-remove-unfollowed-artists" checked onchange="toggleSpotifySyncSetting('remove_unfollowed_artists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="sync-option-card" style="margin-top: var(--space-3);">
                    <div class="sync-option-info">
                        <div class="sync-option-icon" style="background: linear-gradient(135deg, #f59e0b, #b45309);">
                            <i class="fa-solid fa-list-xmark"></i>
                        </div>
                        <div>
                            <div class="sync-option-title">Remove Deleted Playlists</div>
                            <div class="sync-option-desc">Automatically remove playlists when you delete them on Spotify</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spotify-remove-unfollowed-playlists" onchange="toggleSpotifySyncSetting('remove_unfollowed_playlists')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="alert alert-info" style="margin-top: var(--space-4);">
                    <i class="fa-solid fa-info-circle"></i>
                    <span>Downloaded tracks are never automatically removed. Only metadata and images are affected by these settings.</span>
                </div>
            </div>

            <!-- Save Button for Intervals -->
            <div style="margin-top: var(--space-6); display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="saveSpotifySyncSettings()">
                    <i class="fa-solid fa-save"></i>
                    Save Sync Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Integration Settings Tab -->
    <div id="tab-integration" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <!-- Spotify -->
            <div style="margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-brands fa-spotify" style="color: #1DB954;"></i>
                    Spotify Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="spotify-client-id">Client ID</label>
                        <input type="text" id="spotify-client-id" name="integration.spotify_client_id" class="form-input" placeholder="Your Spotify Client ID">
                        <p class="form-helper">Get this from <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: var(--accent-primary);">Spotify Developer Dashboard</a></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-client-secret">Client Secret</label>
                        <div class="input-with-toggle">
                            <input type="password" id="spotify-client-secret" name="integration.spotify_client_secret" class="form-input" placeholder="Your Spotify Client Secret">
                            <button type="button" class="btn-icon" onclick="togglePassword('spotify-client-secret')" title="Toggle visibility">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="spotify-redirect-uri">Redirect URI</label>
                        <input type="url" id="spotify-redirect-uri" name="integration.spotify_redirect_uri" class="form-input" value="http://localhost:8000/api/auth/callback">
                    </div>
                </div>
            </div>

            <!-- slskd -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary); margin-bottom: var(--space-8);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-server" style="color: #3b82f6;"></i>
                    slskd Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="slskd-url">slskd URL</label>
                        <input type="url" id="slskd-url" name="integration.slskd_url" class="form-input" value="http://localhost:5030" required>
                        <p class="form-helper">Base URL for your slskd instance</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="slskd-username">Username</label>
                            <input type="text" id="slskd-username" name="integration.slskd_username" class="form-input" value="admin" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="slskd-password">Password</label>
                            <div class="input-with-toggle">
                                <input type="password" id="slskd-password" name="integration.slskd_password" class="form-input" placeholder="slskd password">
                                <button type="button" class="btn-icon" onclick="togglePassword('slskd-password')" title="Toggle visibility">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="slskd-api-key">API Key (Optional)</label>
                        <div class="input-with-toggle">
                            <input type="password" id="slskd-api-key" name="integration.slskd_api_key" class="form-input" placeholder="Optional API key">
                            <button type="button" class="btn-icon" onclick="togglePassword('slskd-api-key')" title="Toggle visibility">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MusicBrainz -->
            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fa-solid fa-music" style="color: #ba478f;"></i>
                    MusicBrainz Configuration
                </h2>
                <div class="form-stack">
                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-app-name">Application Name</label>
                        <input type="text" id="musicbrainz-app-name" name="integration.musicbrainz_app_name" class="form-input" value="SoulSpot" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="musicbrainz-contact">Contact Email</label>
                        <input type="email" id="musicbrainz-contact" name="integration.musicbrainz_contact" class="form-input" placeholder="your@email.com">
                        <p class="form-helper">MusicBrainz requires a contact email for API access</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Settings Tab -->
    <div id="tab-download" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Download Queue Configuration</h2>
            
            <div class="form-stack">
                <div class="form-group">
                    <label class="form-label" for="max-concurrent-downloads">Maximum Concurrent Downloads</label>
                    <input type="number" id="max-concurrent-downloads" name="download.max_concurrent_downloads" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of downloads that can run simultaneously (1-10, recommended: 3)</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="default-max-retries">Default Maximum Retries</label>
                    <input type="number" id="default-max-retries" name="download.default_max_retries" class="form-input" value="3" min="1" max="10" required style="max-width: 200px;">
                    <p class="form-helper">Number of retry attempts for failed downloads (1-10)</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable-priority-queue" name="download.enable_priority_queue" checked style="accent-color: var(--accent-primary);">
                        <span>Enable Priority Queue</span>
                    </label>
                    <p class="form-helper" style="margin-left: 1.75rem;">Allow downloads to be prioritized (P0/P1/P2)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Settings Tab -->
    <div id="tab-appearance" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-6);">Theme & Appearance</h2>
            
            <div class="form-group">
                <label class="form-label">Theme</label>
                <div class="theme-options">
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="dark" checked onclick="applyTheme('dark')">
                        <div class="theme-card">
                            <i class="fa-solid fa-moon" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Dark</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="light" onclick="applyTheme('light')">
                        <div class="theme-card">
                            <i class="fa-solid fa-sun" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Light</span>
                        </div>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="appearance.theme" value="auto" onclick="applyTheme('auto')">
                        <div class="theme-card">
                            <i class="fa-solid fa-circle-half-stroke" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
                            <span>Auto</span>
                        </div>
                    </label>
                </div>
                <p class="form-helper" style="margin-top: var(--space-3);">Choose how the application looks. Auto follows your system preferences.</p>
            </div>

            <div class="alert alert-info" style="margin-top: var(--space-6);">
                <i class="fa-solid fa-info-circle"></i>
                <span><strong>Theme Persistence:</strong> Your theme preference is saved in your browser and will be remembered on future visits.</span>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Tab -->
    <div id="tab-advanced" class="tab-content" style="display: none;">
        <div class="card" style="padding: var(--space-6);">
            <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Advanced Configuration</h2>
            
            <div class="alert alert-warning" style="margin-bottom: var(--space-6);">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span><strong>Warning:</strong> Changing these settings may affect application stability. Proceed with caution.</span>
            </div>

            <div style="margin-bottom: var(--space-8);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">API Server</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="api-host">API Host</label>
                            <input type="text" id="api-host" name="advanced.api_host" class="form-input" value="0.0.0.0" required>
                            <p class="form-helper">Host address to bind the API server to</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="api-port">API Port</label>
                            <input type="number" id="api-port" name="advanced.api_port" class="form-input" value="8000" min="1" max="65535" required>
                            <p class="form-helper">Port number for the API server (1-65535)</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="secure-cookies" name="advanced.secure_cookies" style="accent-color: var(--accent-primary);">
                            <span>Use Secure Cookies</span>
                        </label>
                        <p class="form-helper" style="margin-left: 1.75rem;">Enable for HTTPS deployments (production only)</p>
                    </div>
                </div>
            </div>

            <div style="padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">Circuit Breaker</h3>
                <div class="form-stack">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-failure-threshold">Failure Threshold</label>
                            <input type="number" id="circuit-breaker-failure-threshold" name="advanced.circuit_breaker_failure_threshold" class="form-input" value="5" min="1" required>
                            <p class="form-helper">Number of failures before opening the circuit</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="circuit-breaker-timeout">Timeout (seconds)</label>
                            <input type="number" id="circuit-breaker-timeout" name="advanced.circuit_breaker_timeout" class="form-input" value="60" min="1" step="0.1" required>
                            <p class="form-helper">Time to wait before attempting recovery</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<style>
    .tab-btn {
        padding: var(--space-3) var(--space-5);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        transition: all var(--transition-fast);
        white-space: nowrap;
    }
    .tab-btn:hover {
        color: var(--text-primary);
    }
    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    .form-stack {
        display: flex;
        flex-direction: column;
        gap: var(--space-5);
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    .form-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }
    .form-helper {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
    }
    .input-with-toggle {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-with-toggle .form-input {
        padding-right: 2.5rem;
    }
    .input-with-toggle .btn-icon {
        position: absolute;
        right: var(--space-2);
    }
    .theme-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-4);
    }
    .theme-option {
        cursor: pointer;
    }
    .theme-option input {
        display: none;
    }
    .theme-card {
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        text-align: center;
        transition: all var(--transition-fast);
    }
    .theme-option input:checked + .theme-card {
        border-color: var(--accent-primary);
        background: rgba(var(--accent-primary-rgb), 0.1);
    }
    .theme-card:hover {
        border-color: var(--text-muted);
    }
    .alert {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-md);
    }
    .alert-info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }
    .alert-warning {
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
    }
    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-tertiary);
        border-radius: 26px;
        transition: all var(--transition-fast);
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: all var(--transition-fast);
    }
    .toggle-switch input:checked + .toggle-slider {
        background-color: #1DB954;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }
    .toggle-switch input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* Sync Option Cards */
    .sync-option-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        transition: all var(--transition-fast);
    }
    .sync-option-card:hover {
        border-color: var(--border-secondary);
    }
    .sync-option-info {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }
    .sync-option-icon {
        width: 42px;
        height: 42px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }
    .sync-option-title {
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }
    .sync-option-desc {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: 2px;
    }
    /* Stats Container */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--space-3);
    }
    .stat-box {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
    }
    .stat-box.stat-total {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border-color: rgba(59, 130, 246, 0.3);
    }
    .stat-icon {
        width: 36px;
        height: 36px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    .stat-content {
        flex: 1;
    }
    .stat-value {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }
    .stat-label {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    .stat-size {
        font-size: var(--font-size-xs);
        color: var(--accent-primary);
        margin-top: 2px;
    }
    /* Input with suffix */
    .input-with-suffix {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    .input-suffix {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
</style>
<script>
    // Hey future me - All the settings page logic is here!
    // Tab switching, password toggles, theme application, form save/load.
    // The API endpoints are /api/settings/ for GET/POST.

    // Tab Switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id === `tab-${tabName}` ? 'block' : 'none';
        });
    }

    // Password Toggle
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = field.nextElementSibling?.querySelector('i') || field.parentElement.querySelector('.btn-icon i');
        if (field.type === 'password') {
            field.type = 'text';
            if (icon) icon.className = 'fa-solid fa-eye-slash';
        } else {
            field.type = 'password';
            if (icon) icon.className = 'fa-solid fa-eye';
        }
    }

    // Theme Management
    function applyTheme(theme) {
        localStorage.setItem('theme', theme);
        SoulSpot.showNotification(`Theme set to ${theme}`, 'success');
    }

    // Load Settings from API
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings/');
            if (!response.ok) throw new Error('Failed to load settings');
            
            const settings = await response.json();
            
            if (settings.general) {
                document.getElementById('app-name').value = settings.general.app_name || 'SoulSpot';
                document.getElementById('log-level').value = settings.general.log_level || 'INFO';
                document.getElementById('debug-mode').checked = settings.general.debug || false;
            }
            
            if (settings.integration) {
                document.getElementById('spotify-client-id').value = settings.integration.spotify_client_id || '';
                document.getElementById('spotify-redirect-uri').value = settings.integration.spotify_redirect_uri || 'http://localhost:8000/api/auth/callback';
                document.getElementById('slskd-url').value = settings.integration.slskd_url || 'http://localhost:5030';
                document.getElementById('slskd-username').value = settings.integration.slskd_username || 'admin';
                document.getElementById('musicbrainz-app-name').value = settings.integration.musicbrainz_app_name || 'SoulSpot';
                document.getElementById('musicbrainz-contact').value = settings.integration.musicbrainz_contact || '';
            }
            
            if (settings.download) {
                document.getElementById('max-concurrent-downloads').value = settings.download.max_concurrent_downloads || 3;
                document.getElementById('default-max-retries').value = settings.download.default_max_retries || 3;
                document.getElementById('enable-priority-queue').checked = settings.download.enable_priority_queue !== false;
            }
            
            if (settings.advanced) {
                document.getElementById('api-host').value = settings.advanced.api_host || '0.0.0.0';
                document.getElementById('api-port').value = settings.advanced.api_port || 8000;
                document.getElementById('secure-cookies').checked = settings.advanced.secure_cookies || false;
                document.getElementById('circuit-breaker-failure-threshold').value = settings.advanced.circuit_breaker_failure_threshold || 5;
                document.getElementById('circuit-breaker-timeout').value = settings.advanced.circuit_breaker_timeout || 60;
            }
            
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    // Save Settings
    async function saveSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('settings-form');
        const formData = new FormData(form);
        
        const settings = {
            general: {
                app_name: formData.get('general.app_name'),
                log_level: formData.get('general.log_level'),
                debug: document.getElementById('debug-mode').checked,
            },
            integration: {
                spotify_client_id: formData.get('integration.spotify_client_id'),
                spotify_client_secret: formData.get('integration.spotify_client_secret'),
                spotify_redirect_uri: formData.get('integration.spotify_redirect_uri'),
                slskd_url: formData.get('integration.slskd_url'),
                slskd_username: formData.get('integration.slskd_username'),
                slskd_password: formData.get('integration.slskd_password'),
                slskd_api_key: formData.get('integration.slskd_api_key') || null,
                musicbrainz_app_name: formData.get('integration.musicbrainz_app_name'),
                musicbrainz_contact: formData.get('integration.musicbrainz_contact'),
            },
            download: {
                max_concurrent_downloads: parseInt(formData.get('download.max_concurrent_downloads')),
                default_max_retries: parseInt(formData.get('download.default_max_retries')),
                enable_priority_queue: document.getElementById('enable-priority-queue').checked,
            },
            appearance: {
                theme: formData.get('appearance.theme'),
            },
            advanced: {
                api_host: formData.get('advanced.api_host'),
                api_port: parseInt(formData.get('advanced.api_port')),
                secure_cookies: document.getElementById('secure-cookies').checked,
                circuit_breaker_failure_threshold: parseInt(formData.get('advanced.circuit_breaker_failure_threshold')),
                circuit_breaker_timeout: parseFloat(formData.get('advanced.circuit_breaker_timeout')),
            },
        };
        
        try {
            const response = await fetch('/api/settings/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings),
            });
            
            if (!response.ok) throw new Error('Failed to save settings');
            
            SoulSpot.showNotification('Settings saved successfully', 'success');
        } catch (error) {
            console.error('Failed to save settings:', error);
            SoulSpot.showNotification('Failed to save settings', 'error');
        }
    }

    // Confirm Reset
    async function confirmReset() {
        if (!confirm('Are you sure you want to reset all settings to their default values?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/settings/reset', {method: 'POST'});
            if (!response.ok) throw new Error('Failed to reset settings');
            
            SoulSpot.showNotification('Settings reset to defaults', 'success');
            await loadSettings();
        } catch (error) {
            console.error('Failed to reset settings:', error);
            SoulSpot.showNotification('Failed to reset settings', 'error');
        }
    }

    // =====================================================
    // Spotify Sync Settings Functions
    // =====================================================
    
    // Hey future me – diese Funktion lädt die Spotify Sync Settings aus der DB.
    // Die API gibt ein SpotifySyncSettingsResponse zurück mit settings-Objekt drin!
    // Die Felder heißen auto_sync_enabled, auto_sync_artists etc (mit "auto_" prefix).
    // WICHTIG: Die HTML-IDs folgen dem Muster "spotify-xyz" nicht "sync-xyz-enabled"!
    async function loadSpotifySyncSettings() {
        try {
            const response = await fetch('/api/settings/spotify-sync');
            if (!response.ok) throw new Error('Failed to load Spotify sync settings');
            
            const data = await response.json();
            // API returns { settings: {...}, image_stats: {...} }
            const settings = data.settings || data;
            
            // Master toggle
            const masterToggle = document.getElementById('spotify-auto-sync-enabled');
            if (masterToggle) masterToggle.checked = settings.auto_sync_enabled ?? true;
            
            // Individual sync toggles
            const artistToggle = document.getElementById('spotify-sync-artists');
            if (artistToggle) artistToggle.checked = settings.auto_sync_artists ?? true;
            
            const playlistToggle = document.getElementById('spotify-sync-playlists');
            if (playlistToggle) playlistToggle.checked = settings.auto_sync_playlists ?? true;
            
            const likedToggle = document.getElementById('spotify-sync-liked-songs');
            if (likedToggle) likedToggle.checked = settings.auto_sync_liked_songs ?? true;
            
            const albumsToggle = document.getElementById('spotify-sync-saved-albums');
            if (albumsToggle) albumsToggle.checked = settings.auto_sync_saved_albums ?? true;
            
            // Intervals
            const artistInterval = document.getElementById('artists-sync-interval');
            if (artistInterval) artistInterval.value = settings.artists_sync_interval_minutes ?? 5;
            
            const playlistInterval = document.getElementById('playlists-sync-interval');
            if (playlistInterval) playlistInterval.value = settings.playlists_sync_interval_minutes ?? 10;
            
            // Image download toggle
            const imageToggle = document.getElementById('spotify-download-images');
            if (imageToggle) imageToggle.checked = settings.download_images ?? true;
            
            // Cleanup toggles
            const removeArtists = document.getElementById('spotify-remove-unfollowed-artists');
            if (removeArtists) removeArtists.checked = settings.remove_unfollowed_artists ?? true;
            
            const removePlaylists = document.getElementById('spotify-remove-unfollowed-playlists');
            if (removePlaylists) removePlaylists.checked = settings.remove_unfollowed_playlists ?? false;
            
            // Update UI state based on master toggle
            updateSyncOptionsState(settings.auto_sync_enabled ?? true);
            
            // Load image stats from response if available, otherwise fetch separately
            if (data.image_stats) {
                updateImageStatsDisplay(data.image_stats);
            } else {
                await loadImageStats();
            }
            
        } catch (error) {
            console.error('Failed to load Spotify sync settings:', error);
        }
    }
    
    // Hey future me – diese Funktion speichert die Spotify Sync Settings.
    // Wichtig: Die API erwartet snake_case Keys mit "auto_" prefix!
    // Die Interval-Werte werden als Integer gesendet (Minuten).
    async function saveSpotifySyncSettings() {
        const settings = {
            auto_sync_enabled: document.getElementById('spotify-auto-sync-enabled')?.checked ?? true,
            auto_sync_artists: document.getElementById('spotify-sync-artists')?.checked ?? true,
            auto_sync_playlists: document.getElementById('spotify-sync-playlists')?.checked ?? true,
            auto_sync_liked_songs: document.getElementById('spotify-sync-liked-songs')?.checked ?? true,
            auto_sync_saved_albums: document.getElementById('spotify-sync-saved-albums')?.checked ?? true,
            artists_sync_interval_minutes: parseInt(document.getElementById('artists-sync-interval')?.value) || 5,
            playlists_sync_interval_minutes: parseInt(document.getElementById('playlists-sync-interval')?.value) || 10,
            download_images: document.getElementById('spotify-download-images')?.checked ?? true,
            remove_unfollowed_artists: document.getElementById('spotify-remove-unfollowed-artists')?.checked ?? true,
            remove_unfollowed_playlists: document.getElementById('spotify-remove-unfollowed-playlists')?.checked ?? false,
        };
        
        try {
            const response = await fetch('/api/settings/spotify-sync', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings),
            });
            
            if (!response.ok) throw new Error('Failed to save Spotify sync settings');
            
            SoulSpot.showNotification('Spotify sync settings saved', 'success');
            
            // Update UI state
            updateSyncOptionsState(settings.auto_sync_enabled);
            
        } catch (error) {
            console.error('Failed to save Spotify sync settings:', error);
            SoulSpot.showNotification('Failed to save Spotify sync settings', 'error');
        }
    }
    
    // Hey future me – diese Funktion toggled ein einzelnes Setting und speichert es sofort.
    // Wird von den onchange-Handlern der Toggles aufgerufen.
    // settingName ist der kurze Name ohne "spotify." prefix (z.B. "auto_sync_enabled")
    async function toggleSpotifySyncSetting(settingName) {
        try {
            const response = await fetch(`/api/settings/spotify-sync/toggle/${settingName}`, {
                method: 'POST',
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Toggle failed');
            }
            
            const result = await response.json();
            
            // Update UI state if master toggle changed
            if (settingName === 'auto_sync_enabled') {
                updateSyncOptionsState(result.new_value);
            }
            
            // Subtle feedback - no notification for quick toggles
            console.log(`Toggled ${settingName}: ${result.old_value} -> ${result.new_value}`);
            
        } catch (error) {
            console.error(`Failed to toggle ${settingName}:`, error);
            SoulSpot.showNotification(`Failed to update setting: ${error.message}`, 'error');
            
            // Revert toggle on error
            await loadSpotifySyncSettings();
        }
    }
    
    // Hey future me – diese Funktion triggert einen sofortigen Sync.
    // syncType kann sein: 'artists', 'playlists', 'liked', 'albums', oder 'all'.
    // Die API gibt sofort zurück, der Sync läuft im Background.
    // Der Button wird während des Syncs disabled um Doppelklicks zu vermeiden.
    async function triggerManualSync(syncType) {
        const button = event?.target?.closest('button');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
        }
        
        try {
            const response = await fetch(`/api/settings/spotify-sync/trigger/${syncType}`, {
                method: 'POST',
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Sync failed');
            }
            
            const result = await response.json();
            SoulSpot.showNotification(result.message || `${syncType} sync started`, 'success');
            
            // Reload image stats after sync
            setTimeout(loadImageStats, 2000);
            
        } catch (error) {
            console.error(`Failed to trigger ${syncType} sync:`, error);
            SoulSpot.showNotification(error.message || `Failed to sync ${syncType}`, 'error');
        } finally {
            if (button) {
                button.disabled = false;
                // Restore original button text based on syncType
                const labels = {
                    'artists': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'playlists': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'liked': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'albums': '<i class="fas fa-sync mr-2"></i>Sync Now',
                    'all': '<i class="fas fa-sync mr-2"></i>Sync All Now',
                };
                button.innerHTML = labels[syncType] || '<i class="fas fa-sync mr-2"></i>Sync Now';
            }
        }
    }
    
    // Hey future me – diese Funktion lädt die Image Statistics für Spotify Images.
    // Die API gibt bytes zurück, wir formatieren das zu human-readable.
    // Wenn keine Images existieren, zeigen wir "0 B" und "0" an.
    async function loadImageStats() {
        try {
            const response = await fetch('/api/settings/spotify-sync/disk-usage');
            if (!response.ok) throw new Error('Failed to load image stats');
            
            const stats = await response.json();
            updateImageStatsDisplay(stats);
            
        } catch (error) {
            console.error('Failed to load image stats:', error);
        }
    }
    
    // Hey future me – separierte Funktion um die Image Stats anzuzeigen.
    // Wird sowohl von loadImageStats als auch von loadSpotifySyncSettings verwendet
    // (wenn die Daten schon in der Response sind).
    // Die HTML-IDs folgen dem Muster "stat-{type}-{count|size}"
    function updateImageStatsDisplay(stats) {
        // Artist images
        const artistsCountEl = document.getElementById('stat-artists-count');
        if (artistsCountEl) artistsCountEl.textContent = stats.artists_count ?? 0;
        const artistsSizeEl = document.getElementById('stat-artists-size');
        if (artistsSizeEl) artistsSizeEl.textContent = formatBytes(stats.artists_bytes ?? 0);
        
        // Album covers
        const albumsCountEl = document.getElementById('stat-albums-count');
        if (albumsCountEl) albumsCountEl.textContent = stats.albums_count ?? 0;
        const albumsSizeEl = document.getElementById('stat-albums-size');
        if (albumsSizeEl) albumsSizeEl.textContent = formatBytes(stats.albums_bytes ?? 0);
        
        // Playlist covers
        const playlistsCountEl = document.getElementById('stat-playlists-count');
        if (playlistsCountEl) playlistsCountEl.textContent = stats.playlists_count ?? 0;
        const playlistsSizeEl = document.getElementById('stat-playlists-size');
        if (playlistsSizeEl) playlistsSizeEl.textContent = formatBytes(stats.playlists_bytes ?? 0);
        
        // Totals
        const totalCountEl = document.getElementById('stat-total-count');
        if (totalCountEl) totalCountEl.textContent = stats.total_count ?? 0;
        const totalSizeEl = document.getElementById('stat-total-size');
        if (totalSizeEl) totalSizeEl.textContent = formatBytes(stats.total_bytes ?? 0);
    }
    
    // Hey future me – simple Bytes-zu-Human-Readable Konvertierung.
    // Nutzt 1024 als Basis (KiB, MiB, GiB) weil das für Festplatten üblicher ist.
    // Bei 0 Bytes geben wir "0 B" zurück, nicht "0 undefined".
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Hey future me – diese Funktion updated den UI State basierend auf dem Master Toggle.
    // Wenn Sync disabled ist, werden alle Sub-Toggles ausgegraut aber behalten ihren Wert.
    // Das ist wichtig damit der User seine Einstellungen nicht verliert wenn er Sync kurz deaktiviert.
    // Die HTML-ID für die Optionen-Container ist "spotify-sync-options" nicht "sync-options-container"
    function updateSyncOptionsState(enabled) {
        const syncOptions = document.getElementById('spotify-sync-options');
        if (syncOptions) {
            syncOptions.style.opacity = enabled ? '1' : '0.5';
            syncOptions.style.pointerEvents = enabled ? 'auto' : 'none';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        loadSpotifySyncSettings();
    });
</script>
{% endblock %}