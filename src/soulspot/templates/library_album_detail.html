{# Hey future me - Album detail page with stats, bulk actions, and track table.
   Shows album cover placeholder, artist link, year, track count, duration.
   Stats cards show total/downloaded/missing/broken counts.
   Bulk selection like playlist_detail but scoped to album tracks.
   Download all missing button queues multiple API calls. #}

{% extends "base.html" %}

{% block title %}{{ album.title }} - Albums - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm);">
        <li><a href="/ui/library" style="color: var(--accent-primary);">Library</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        <li><a href="/ui/library/albums" style="color: var(--accent-primary);">Albums</a></li>
        <li style="color: var(--text-muted);"><i class="bi bi-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i>{{ album.title }}</li>
    </ol>
</nav>

<!-- Album Header -->
<div style="display: flex; flex-wrap: wrap; gap: var(--space-6); margin-bottom: var(--space-8);">
    <div class="album-cover-large">
        <i class="bi bi-disc"></i>
    </div>
    <div style="flex: 1; min-width: 200px;">
        <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-2);">{{ album.title }}</h1>
        <a href="/ui/library/artists/{{ album.artist_slug }}" style="color: var(--accent-primary); font-size: var(--font-size-lg); font-weight: var(--font-weight-medium);">{{ album.artist }}</a>
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-4); margin-top: var(--space-3); color: var(--text-muted); font-size: var(--font-size-sm);">
            {% if album.year %}
            <span><i class="bi bi-calendar" style="margin-right: var(--space-2);"></i>{{ album.year }}</span>
            {% endif %}
            <span><i class="bi bi-music-note" style="margin-right: var(--space-2);"></i>{{ album.tracks|length }} track{{ 's' if album.tracks|length != 1 else '' }}</span>
            {% if album.total_duration_ms %}
                {% set total_minutes = (album.total_duration_ms / 60000) | int %}
            <span><i class="bi bi-clock" style="margin-right: var(--space-2);"></i>{{ total_minutes }} min</span>
            {% endif %}
        </div>
        {% if album.is_complete is defined %}
        <div style="margin-top: var(--space-3);">
            {% if album.is_complete %}
                <span class="badge badge-success">Complete</span>
            {% else %}
                <span class="badge badge-warning">Incomplete</span>
                <span style="color: var(--text-muted); margin-left: var(--space-2); font-size: var(--font-size-sm);">
                    {{ album.tracks|length }} of {{ album.expected_tracks }} tracks
                </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Stats Cards -->
{% set downloaded_count = album.tracks | selectattr("file_path") | list | length %}
{% set missing_count = album.tracks | rejectattr("file_path") | list | length %}
{% set broken_count = album.tracks | selectattr("is_broken") | list | length %}
<div class="stats-grid" style="margin-bottom: var(--space-6);">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary);">
            <i class="bi bi-music-note"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ album.tracks|length }}</div>
            <div class="stat-label">Total Tracks</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
            <i class="bi bi-check"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #22c55e;">{{ downloaded_count }}</div>
            <div class="stat-label">Downloaded</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(234, 179, 8, 0.1); color: #eab308;">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #eab308;">{{ missing_count }}</div>
            <div class="stat-label">Missing</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
            <i class="bi bi-x-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #ef4444;">{{ broken_count }}</div>
            <div class="stat-label">Broken</div>
        </div>
    </div>
</div>

<!-- Tracks Section -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--space-4); padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--border-primary);">
        <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold);">Tracks</h2>
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3);">
            <input type="text" 
                   id="track-search"
                   placeholder="Search tracks..."
                   class="form-input"
                   style="min-width: 160px;">
            {% if missing_count > 0 or broken_count > 0 %}
            <button id="download-all-missing-btn" 
                    class="btn btn-primary"
                    onclick="downloadAllMissing()">
                <i class="bi bi-download"></i>
                Download All Missing ({{ missing_count + broken_count }})
            </button>
            {% endif %}
            <button id="bulk-download-btn" 
                    class="btn btn-outline hidden"
                    onclick="bulkDownloadSelected()">
                <i class="bi bi-download"></i>
                Download Selected (<span id="selected-count">0</span>)
            </button>
        </div>
    </div>
    {% if album.tracks %}
    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" 
                               id="select-all-checkbox"
                               class="form-checkbox"
                               onclick="toggleSelectAll()">
                    </th>
                    <th style="width: 50px;">#</th>
                    <th>Title</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tracks-tbody">
                {% for track in album.tracks %}
                <tr class="track-row" 
                    data-track-id="{{ track.id }}"
                    data-title="{{ track.title|lower }}">
                    <td>
                        <input type="checkbox" 
                               class="track-checkbox form-checkbox"
                               data-track-id="{{ track.id }}"
                               data-status="{% if track.is_broken %}broken{% elif track.file_path %}downloaded{% else %}missing{% endif %}"
                               onchange="updateBulkActions()">
                    </td>
                    <td style="color: var(--text-muted);">{{ track.track_number or loop.index }}</td>
                    <td><span style="font-weight: var(--font-weight-medium);">{{ track.title }}</span></td>
                    <td style="color: var(--text-muted);">
                        {% if track.duration_ms %}
                            {% set minutes = (track.duration_ms / 60000) | int %}
                            {% set seconds = ((track.duration_ms % 60000) / 1000) | int %}
                            {{ "%d:%02d" | format(minutes, seconds) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if track.is_broken %}
                            <span class="badge badge-error">Broken</span>
                        {% elif track.file_path %}
                            <span class="badge badge-success">Downloaded</span>
                        {% else %}
                            <span class="badge badge-warning">Missing</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: var(--space-2);">
                            {% if not track.file_path or track.is_broken %}
                            <button class="btn btn-sm btn-outline"
                                    hx-post="/api/tracks/{{ track.id }}/download"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML">
                                Download
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-ghost"
                                    hx-get="/tracks/{{ track.id }}/metadata-editor"
                                    hx-target="#metadata-modal"
                                    hx-swap="innerHTML">
                                Edit
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state" style="padding: var(--space-12);">
        <div class="empty-icon">
            <i class="bi bi-music-note"></i>
        </div>
        <h3>No tracks found</h3>
        <p>This album does not have any tracks in your library.</p>
    </div>
    {% endif %}
</div>

<!-- Metadata Modal Container -->
<div id="metadata-modal"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    .album-cover-large {
        width: 180px;
        height: 180px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-radius: var(--radius-xl);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 5rem;
        color: rgba(255, 255, 255, 0.4);
        flex-shrink: 0;
        box-shadow: var(--shadow-xl);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--space-4);
    }
    .stat-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        border: 1px solid var(--border-primary);
    }
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-lg);
    }
    .stat-value {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
    }
    .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th {
        padding: var(--space-3) var(--space-4);
        text-align: left;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-tertiary);
    }
    .data-table td {
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
    }
    .data-table tr:hover {
        background: var(--bg-hover);
    }
    .form-checkbox {
        width: 16px;
        height: 16px;
        border-radius: var(--radius-sm);
        border: 2px solid var(--border-secondary);
        background: transparent;
        cursor: pointer;
    }
    .form-checkbox:checked {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
    }
    .empty-state {
        text-align: center;
    }
    .empty-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--bg-tertiary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-2xl);
        color: var(--text-muted);
    }
    .empty-state h3 {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }
    .empty-state p {
        color: var(--text-muted);
    }
    .hidden {
        display: none !important;
    }
</style>
<script>
// Hey future me - handles bulk selection, download all missing, and search filter for album tracks.
// Pattern from playlist_detail but simplified for album context.

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const trackCheckboxes = document.querySelectorAll('.track-checkbox');
    const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : 
                     document.querySelectorAll('.track-checkbox:checked').length === 0;
    
    trackCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('.track-row');
        if (row && row.style.display !== 'none') {
            checkbox.checked = isChecked;
        }
    });
    
    if (selectAllCheckbox) selectAllCheckbox.checked = isChecked;
    updateBulkActions();
}

function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
    const bulkDownloadBtn = document.getElementById('bulk-download-btn');
    const selectedCount = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const visibleCheckboxes = Array.from(document.querySelectorAll('.track-checkbox')).filter(cb => {
        const row = cb.closest('.track-row');
        return row && row.style.display !== 'none';
    });
    
    const downloadableSelected = Array.from(checkedBoxes).filter(cb => 
        cb.getAttribute('data-status') !== 'downloaded'
    ).length;
    
    if (selectedCount) selectedCount.textContent = downloadableSelected;
    
    if (bulkDownloadBtn) {
        bulkDownloadBtn.classList.toggle('hidden', downloadableSelected === 0);
    }
    
    if (selectAllCheckbox && visibleCheckboxes.length > 0) {
        const visibleChecked = visibleCheckboxes.filter(cb => cb.checked).length;
        selectAllCheckbox.checked = visibleChecked === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = visibleChecked > 0 && visibleChecked < visibleCheckboxes.length;
    }
}

function bulkDownloadSelected() {
    const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
    const trackIds = Array.from(checkedBoxes)
        .filter(cb => cb.getAttribute('data-status') !== 'downloaded')
        .map(cb => cb.getAttribute('data-track-id'));
    
    if (trackIds.length === 0) {
        SoulSpot.showNotification('No tracks to download', 'info');
        return;
    }
    
    queueDownloads(trackIds, `Queued ${trackIds.length} track(s) for download`);
    
    document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = false);
    if (document.getElementById('select-all-checkbox')) {
        document.getElementById('select-all-checkbox').checked = false;
    }
    updateBulkActions();
}

function downloadAllMissing() {
    const missingTracks = document.querySelectorAll('.track-checkbox[data-status="missing"], .track-checkbox[data-status="broken"]');
    const trackIds = Array.from(missingTracks).map(cb => cb.getAttribute('data-track-id'));
    
    if (trackIds.length === 0) {
        SoulSpot.showNotification('All tracks are already downloaded!', 'info');
        return;
    }
    
    queueDownloads(trackIds, `Queued all ${trackIds.length} missing track(s) for download`);
}

function queueDownloads(trackIds, successMessage) {
    let successCount = 0;
    let failureCount = 0;
    
    const downloadPromises = trackIds.map(trackId => 
        fetch(`/api/tracks/${trackId}/download`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                failureCount++;
                return { success: false, trackId };
            }
            successCount++;
            return { success: true, trackId };
        })
        .catch(error => {
            failureCount++;
            console.error(`Error queuing download for track ${trackId}:`, error);
            return { success: false, trackId };
        })
    );
    
    Promise.all(downloadPromises).then(() => {
        if (failureCount === 0) {
            SoulSpot.showNotification(successMessage, 'success');
        } else if (successCount === 0) {
            SoulSpot.showNotification(`Failed to queue ${failureCount} track(s). Please try again.`, 'error');
        } else {
            SoulSpot.showNotification(`Queued ${successCount} track(s), ${failureCount} failed`, 'warning');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('track-search');
    
    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const trackRows = document.querySelectorAll('.track-row');
                
                trackRows.forEach(row => {
                    const title = row.getAttribute('data-title') || '';
                    row.style.display = (title.includes(searchTerm) || searchTerm === '') ? '' : 'none';
                });
                
                updateBulkActions();
            }, 200);
        });
    }
    
    updateBulkActions();
});
</script>
{% endblock %}
