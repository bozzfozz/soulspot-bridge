{# Hey future me - Onboarding page for first-time users!
   German language UI ("Willkommen bei SoulSpot").
   HTMX checks Spotify auth status and shows connect button or success state.
   getConnectSpotifyOnboardingHTML() helper handles unauthenticated state. #}

{% extends "base.html" %}

{% block title %}Willkommen - SoulSpot{% endblock %}

{% block content %}
<div style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
    <div style="max-width: 600px; width: 100%; padding: 0 var(--space-4);">
        <!-- Onboarding Card -->
        <div class="card" style="text-align: center;">
            <!-- Logo & Header -->
            <div style="padding: var(--space-8) var(--space-8) var(--space-6);">
                <div style="width: 100px; height: 100px; margin: 0 auto var(--space-6); background: linear-gradient(135deg, var(--accent-primary), #a855f7); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-xl);">
                    <span style="font-size: 3rem;">üéµ</span>
                </div>
                <h1 style="font-size: var(--font-size-4xl); margin-bottom: var(--space-3);">
                    Willkommen bei SoulSpot
                </h1>
                <p style="color: var(--text-muted); font-size: var(--font-size-lg);">
                    Verbinde Spotify, um Songs und Playlists zu synchronisieren.
                </p>
            </div>

            <!-- Status Area (HTMX Target) -->
            <div id="onboarding-status" style="padding: var(--space-6); border-top: 1px solid var(--border-primary); border-bottom: 1px solid var(--border-primary);">
                <!-- Initial loading state -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: var(--space-4);">
                    <div class="spinner"></div>
                    <p style="color: var(--text-muted);">Verbindungsstatus wird gepr√ºft...</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="onboarding-actions" style="padding: var(--space-6); display: flex; flex-wrap: wrap; justify-content: center; gap: var(--space-3);">
                <button 
                    id="continueBtn"
                    class="btn btn-primary btn-lg"
                    hx-get="/api/auth/spotify/status"
                    hx-target="#onboarding-status"
                    hx-swap="innerHTML"
                    hx-trigger="click"
                    disabled
                >
                    <i class="fa-solid fa-arrow-right"></i>
                    Weiter
                </button>
                <button 
                    id="skipBtn"
                    class="btn btn-outline btn-lg"
                    hx-post="/api/auth/onboarding/skip"
                    hx-swap="none"
                >
                    Nicht jetzt
                </button>
            </div>
        </div>

        <!-- Help Text -->
        <div style="margin-top: var(--space-8);">
            <div class="card" style="padding: var(--space-4); background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                    <i class="fa-solid fa-circle-info" style="color: #3b82f6; margin-top: 2px;"></i>
                    <p style="font-size: var(--font-size-sm); color: var(--text-secondary); text-align: left;">
                        Die Spotify-Verbindung ist erforderlich, um Playlists zu synchronisieren und Songs herunterzuladen.
                        Du kannst diesen Schritt auch sp√§ter in den Einstellungen durchf√ºhren.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-secondary);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .status-card {
        padding: var(--space-5);
        border-radius: var(--radius-lg);
        text-align: center;
    }
    .status-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }
</style>
<script>
function getConnectSpotifyOnboardingHTML() {
    return `
        <div class="status-card" style="background: rgba(var(--accent-primary-rgb), 0.1); border: 1px solid rgba(var(--accent-primary-rgb), 0.2);">
            <div class="status-icon" style="background: #1DB954;">
                <i class="fa-brands fa-spotify" style="color: white;"></i>
            </div>
            <p style="font-weight: var(--font-weight-bold); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">Verbinde dein Spotify-Konto</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--space-4);">Klicke auf "Verbinden", um mit der Einrichtung fortzufahren.</p>
            <a href="/auth" class="btn btn-primary btn-lg" style="background: #1DB954; border-color: #1DB954;">
                <i class="fa-brands fa-spotify"></i>
                Mit Spotify verbinden
            </a>
        </div>
    `;
}

document.body.addEventListener('htmx:responseError', function(evt) {
    if (evt.detail.target.id === 'onboarding-status') {
        document.getElementById('onboarding-status').innerHTML = getConnectSpotifyOnboardingHTML();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const continueBtn = document.getElementById('continueBtn');
    const statusDiv = document.getElementById('onboarding-status');

    // Auto-check Spotify status on load
    setTimeout(() => {
        htmx.trigger('#continueBtn', 'click');
    }, 500);

    // Enable button after short delay
    setTimeout(() => {
        if (continueBtn) {
            continueBtn.disabled = false;
        }
    }, 1000);

    // Handle successful status check
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'onboarding-status') {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                
                const isConnected = response.connected === true || 
                    (response.has_access_token && !response.token_expired);
                
                if (isConnected) {
                    statusDiv.innerHTML = `
                        <div class="status-card" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                            <div class="status-icon" style="background: #22c55e;">
                                <i class="fa-solid fa-check" style="color: white;"></i>
                            </div>
                            <p style="font-weight: var(--font-weight-bold); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">Spotify ist bereits verbunden!</p>
                            <p style="font-size: var(--font-size-sm); color: var(--text-muted);">Du kannst direkt loslegen.</p>
                        </div>
                    `;
                    
                    continueBtn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Zum Dashboard';
                    continueBtn.onclick = () => window.location.href = '/';
                    continueBtn.removeAttribute('hx-get');
                } else {
                    statusDiv.innerHTML = getConnectSpotifyOnboardingHTML();
                }
            } catch (e) {
                statusDiv.innerHTML = getConnectSpotifyOnboardingHTML();
            }
        }
    });
    
    // Handle skip button
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.pathInfo?.requestPath === '/api/onboarding/skip') {
            if (evt.detail.successful) {
                window.location.href = '/';
            }
        }
    });
});
</script>
{% endblock %}
