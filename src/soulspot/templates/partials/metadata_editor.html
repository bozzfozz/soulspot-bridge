{# 
  Hey future me - Track Metadata Editor Modal (HTMX loaded)
  
  This is a modal dialog for editing track metadata. Gets loaded into a container
  when user clicks "Edit" on a track. Uses new design system modal styling.
  Form submits via fetch() to PATCH endpoint and shows toast on success/error.
#}
<div style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px);" 
     id="metadata-modal-overlay"
     onclick="closeMetadataModal()"
     role="dialog"
     aria-modal="true"
     aria-labelledby="metadata-modal-title">
    <div class="card" 
         style="max-width: 640px; width: 100%; margin: var(--space-4); max-height: 90vh; overflow-y: auto;"
         onclick="event.stopPropagation()">
        
        <!-- Modal Header -->
        <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-6); border-bottom: 1px solid var(--border-color);">
            <h3 id="metadata-modal-title" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--text-primary);">
                Edit Track Metadata
            </h3>
            <button onclick="closeMetadataModal()" 
                    class="btn btn-outline btn-sm"
                    aria-label="Close modal">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="metadata-form" onsubmit="saveMetadata(event)">
            <div style="padding: var(--space-6); display: flex; flex-direction: column; gap: var(--space-4);">
                <!-- Track Title -->
                <div>
                    <label for="track-title" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                        Title <span style="color: var(--status-error);">*</span>
                    </label>
                    <input type="text" 
                           id="track-title" 
                           name="title"
                           value="{{ track.title or '' }}"
                           class="form-input"
                           required
                           aria-label="Track title">
                </div>

                <!-- Artist -->
                <div>
                    <label for="track-artist" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                        Artist <span style="color: var(--status-error);">*</span>
                    </label>
                    <input type="text" 
                           id="track-artist" 
                           name="artist"
                           value="{{ track.artist or '' }}"
                           class="form-input"
                           required
                           aria-label="Track artist">
                </div>

                <!-- Album -->
                <div>
                    <label for="track-album" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                        Album
                    </label>
                    <input type="text" 
                           id="track-album" 
                           name="album"
                           value="{{ track.album or '' }}"
                           class="form-input"
                           aria-label="Track album">
                </div>

                <!-- Album Artist -->
                <div>
                    <label for="track-album-artist" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                        Album Artist
                    </label>
                    <input type="text" 
                           id="track-album-artist" 
                           name="album_artist"
                           value="{{ track.album_artist or '' }}"
                           class="form-input"
                           aria-label="Album artist">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                    <!-- Genre -->
                    <div>
                        <label for="track-genre" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                            Genre
                        </label>
                        <input type="text" 
                               id="track-genre" 
                               name="genre"
                               value="{{ track.genre or '' }}"
                               class="form-input"
                               aria-label="Track genre">
                    </div>

                    <!-- Year -->
                    <div>
                        <label for="track-year" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                            Year
                        </label>
                        <input type="number" 
                               id="track-year" 
                               name="year"
                               value="{{ track.year or '' }}"
                               min="1900"
                               max="2100"
                               class="form-input"
                               aria-label="Track year">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                    <!-- Track Number -->
                    <div>
                        <label for="track-number" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                            Track Number
                        </label>
                        <input type="number" 
                               id="track-number" 
                               name="track_number"
                               value="{{ track.track_number or '' }}"
                               min="1"
                               class="form-input"
                               aria-label="Track number">
                    </div>

                    <!-- Disc Number -->
                    <div>
                        <label for="disc-number" style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                            Disc Number
                        </label>
                        <input type="number" 
                               id="disc-number" 
                               name="disc_number"
                               value="{{ track.disc_number or '' }}"
                               min="1"
                               class="form-input"
                               aria-label="Disc number">
                    </div>
                </div>

                <!-- Current File Path (Read-only info) -->
                {% if track.file_path %}
                <div>
                    <label style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-1);">
                        File Location
                    </label>
                    <div style="padding: var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: var(--font-size-sm); color: var(--text-muted); word-break: break-all;">
                        {{ track.file_path }}
                    </div>
                </div>
                {% endif %}

                <!-- Hidden field for track ID -->
                <input type="hidden" name="track_id" value="{{ track.id }}">
            </div>

            <!-- Modal Footer -->
            <div style="display: flex; justify-content: flex-end; gap: var(--space-3); padding: var(--space-6); border-top: 1px solid var(--border-color);">
                <button type="button" 
                        onclick="closeMetadataModal()" 
                        class="btn btn-outline">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function closeMetadataModal() {
    document.getElementById('metadata-modal').innerHTML = '';
}

function saveMetadata(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const trackId = formData.get('track_id');
    
    const data = {};
    formData.forEach((value, key) => {
        if (key !== 'track_id' && value !== '') {
            if (key === 'year' || key === 'track_number' || key === 'disc_number') {
                data[key] = parseInt(value);
            } else {
                data[key] = value;
            }
        }
    });
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-arrow-repeat bi-spin"></i> Saving...';
    
    fetch(`/api/tracks/${trackId}/metadata`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update metadata');
        return response.json();
    })
    .then(result => {
        if (typeof SoulSpot !== 'undefined') {
            SoulSpot.toast('Metadata updated successfully', 'success');
        }
        closeMetadataModal();
        setTimeout(() => window.location.reload(), 500);
    })
    .catch(error => {
        if (typeof SoulSpot !== 'undefined') {
            SoulSpot.toast('Failed to update metadata: ' + error.message, 'error');
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}
</script>
