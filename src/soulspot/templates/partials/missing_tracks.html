{# 
  Hey future me - Missing Tracks Comparison Partial (HTMX loaded)
  
  Shows tracks that are in Spotify playlist but not in local library.
  Includes "Download All" batch action and individual download buttons.
  Uses new design system data-table styling.
#}
{% from "includes/_components.html" import empty_state %}

<div class="card">
    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-4) var(--space-6); border-bottom: 1px solid var(--border-color);">
        <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--text-primary);">
            Missing Tracks Comparison
        </h3>
        <button class="btn btn-outline btn-sm"
                onclick="document.getElementById('missing-tracks-section').innerHTML = ''"
                aria-label="Close missing tracks view">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    
    <div style="padding: var(--space-6);">
        {% if missing_tracks %}
        <div class="alert alert-info" style="margin-bottom: var(--space-4);">
            <i class="bi bi-info-circle"></i>
            <div>
                <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                    {{ missing_tracks|length }} track{{ 's' if missing_tracks|length != 1 else '' }} not found in library
                </div>
                <p>These tracks are in the Spotify playlist but not downloaded to your library yet.</p>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
            <div style="font-size: var(--font-size-sm); color: var(--text-muted);">
                Showing {{ missing_tracks|length }} missing tracks
            </div>
            <button class="btn btn-primary"
                    onclick="downloadAllMissing()"
                    aria-label="Download all missing tracks">
                <i class="bi bi-download"></i> Download All Missing
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Artist</th>
                        <th>Album</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for track in missing_tracks %}
                    <tr data-track-id="{{ track.id }}">
                        <td>
                            <span style="font-weight: var(--font-weight-medium); color: var(--text-primary);">
                                {{ track.title or "Unknown Title" }}
                            </span>
                        </td>
                        <td>{{ track.artist or "Unknown Artist" }}</td>
                        <td>{{ track.album or "Unknown Album" }}</td>
                        <td style="white-space: nowrap;">
                            {% if track.duration_ms %}
                                {% set minutes = (track.duration_ms / 60000) | int %}
                                {% set seconds = ((track.duration_ms % 60000) / 1000) | int %}
                                {{ "%d:%02d" | format(minutes, seconds) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-outline btn-sm"
                                    hx-post="/api/tracks/{{ track.id }}/download"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                    hx-indicator="#download-indicator-{{ track.id }}"
                                    aria-label="Download track {{ track.title }}">
                                <span id="download-indicator-{{ track.id }}" class="htmx-indicator">
                                    <i class="bi bi-arrow-repeat bi-spin"></i>
                                </span>
                                <span class="htmx-indicator-off">
                                    <i class="bi bi-download"></i> Download
                                </span>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding: var(--space-12); text-align: center;">
            <i class="bi bi-check-circle" style="font-size: 48px; color: var(--status-success); margin-bottom: var(--space-4); display: block;"></i>
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); margin-bottom: var(--space-2);">All tracks downloaded!</h3>
            <p style="color: var(--text-muted);">All tracks from this playlist are available in your library.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function downloadAllMissing() {
    const trackRows = document.querySelectorAll('[data-track-id]');
    const trackIds = Array.from(trackRows).map(row => row.getAttribute('data-track-id'));
    
    if (trackIds.length === 0) return;
    
    if (confirm(`Download ${trackIds.length} missing track(s)?`)) {
        let completed = 0;
        trackIds.forEach(trackId => {
            fetch(`/api/tracks/${trackId}/download`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                completed++;
                if (completed === trackIds.length) {
                    if (typeof SoulSpot !== 'undefined') {
                        SoulSpot.toast(`Queued ${trackIds.length} track(s) for download`, 'success');
                    }
                    setTimeout(() => {
                        document.getElementById('missing-tracks-section').innerHTML = '';
                    }, 1000);
                }
            })
            .catch(error => {
                console.error(`Error queuing download for track ${trackId}:`, error);
            });
        });
    }
}
</script>
