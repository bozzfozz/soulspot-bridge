{#
  Hey future me - Download Item Partial (HTMX fragment)
  
  This is rendered for each download in the queue. Gets swapped via HTMX when status changes.
  Uses the new design system CSS classes (card, badge, btn).
  The status_indicator and priority_badge macros are from _components.html.
#}

{% from "includes/_components.html" import status_indicator, priority_badge, progress_bar %}

<div class="card download-item" 
     style="padding: var(--space-4);"
     data-download-id="{{ download.id }}"
     data-status="{{ download.status }}">
    <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
        <!-- Selection Checkbox -->
        <input type="checkbox" 
               class="download-checkbox" 
               style="margin-top: var(--space-1); accent-color: var(--accent-primary);"
               value="{{ download.id }}"
               onchange="updateBatchSelection()"
               aria-label="Select download">
        
        <!-- Download Info -->
        <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--space-2);">
                <div style="flex: 1; min-width: 0;">
                    <h3 style="font-weight: var(--font-weight-semibold); color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ download.track_title or 'Track ' + download.track_id }}
                    </h3>
                    <p style="font-size: var(--font-size-sm); color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ download.artist or 'Unknown Artist' }}
                    </p>
                </div>
                <div style="display: flex; gap: var(--space-2); margin-left: var(--space-4);">
                    {{ priority_badge(download.priority) }}
                    {{ status_indicator(download.status) }}
                </div>
            </div>
            
            <!-- Progress Bar -->
            {% if download.status in ['downloading', 'queued'] and download.progress_percent %}
            {{ progress_bar(download.progress_percent, 100, '') }}
            {% endif %}
            
            <!-- Metadata -->
            <div style="display: flex; gap: var(--space-4); font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--space-2);">
                {% if download.started_at %}
                <span>Started: {{ download.started_at }}</span>
                {% endif %}
                {% if download.created_at %}
                <span>Added: {{ download.created_at }}</span>
                {% endif %}
            </div>
            
            <!-- Error Message -->
            {% if download.error_message %}
            <div class="alert alert-error" style="margin-top: var(--space-2); padding: var(--space-2) var(--space-3); font-size: var(--font-size-sm);">
                <i class="bi bi-x-circle"></i>
                {{ download.error_message }}
            </div>
            {% endif %}
        </div>
        
        <!-- Actions -->
        <div style="display: flex; gap: var(--space-1);">
            {% if download.status == 'downloading' %}
            <button class="btn btn-outline btn-sm"
                    hx-post="/api/downloads/{{ download.id }}/pause"
                    hx-swap="outerHTML"
                    hx-target="closest .download-item"
                    aria-label="Pause download"
                    title="Pause">
                <i class="bi bi-pause-fill"></i>
            </button>
            {% elif download.status in ['paused', 'queued'] %}
            <button class="btn btn-outline btn-sm"
                    hx-post="/api/downloads/{{ download.id }}/resume"
                    hx-swap="outerHTML"
                    hx-target="closest .download-item"
                    aria-label="Resume download"
                    title="Resume">
                <i class="bi bi-play-fill"></i>
            </button>
            {% endif %}
            
            {% if download.status == 'failed' %}
            <button class="btn btn-outline btn-sm"
                    hx-post="/api/downloads/{{ download.id }}/retry"
                    hx-swap="outerHTML"
                    hx-target="closest .download-item"
                    aria-label="Retry download"
                    title="Retry">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            {% endif %}
            
            {% if download.status not in ['completed'] %}
            <button class="btn btn-outline btn-sm" 
                    style="color: var(--status-error);"
                    hx-delete="/api/downloads/{{ download.id }}"
                    hx-confirm="Are you sure you want to cancel this download?"
                    hx-swap="outerHTML swap:1s"
                    hx-target="closest .download-item"
                    aria-label="Cancel download"
                    title="Cancel">
                <i class="bi bi-x-lg"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>
