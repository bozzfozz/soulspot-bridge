{% extends "base.html" %}
{% from "includes/_components.html" import empty_state, badge %}

{% block title %}Tracks - SoulSpot{% endblock %}

{% block content %}
<div class="space-y-8 animate-fade-in">
    <!-- Modern Page Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex-1">
            <nav class="flex mb-3" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-2">
                    <li class="inline-flex items-center">
                        <a href="/ui/library" class="text-sm text-primary-600 dark:text-primary-400 hover:underline font-medium">
                            Library
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mx-1" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                            <span class="text-sm text-gray-500 dark:text-gray-400" aria-current="page">Tracks</span>
                        </div>
                    </li>
                </ol>
            </nav>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl flex items-center justify-center shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Tracks</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Browse {{ tracks|length }} tracks in your library</p>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <input type="text" 
                   id="track-search"
                   placeholder="Search tracks..."
                   class="input-modern focus-visible-ring"
                   aria-label="Search tracks">
            <select id="status-filter" class="input-modern focus-visible-ring">
                <option value="all">All Tracks</option>
                <option value="downloaded">Downloaded</option>
                <option value="missing">Missing</option>
                <option value="broken">Broken</option>
            </select>
        </div>
    </div>

    <!-- Tracks Table -->
    <div class="card-modern">
        <div class="p-0">
            {% if tracks %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-sort="title">
                                Title
                                <svg class="inline w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-sort="artist">
                                Artist
                                <svg class="inline w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-sort="album">
                                Album
                                <svg class="inline w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Duration
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Status
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700" id="tracks-tbody">
                        {% for track in tracks %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors track-row" 
                            data-status="{% if track.is_broken %}broken{% elif track.file_path %}downloaded{% else %}missing{% endif %}">
                            <td class="px-6 py-4 whitespace-nowrap" data-sort-value="{{ track.title }}">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ track.title }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" data-sort-value="{{ track.artist }}">
                                {{ track.artist }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" data-sort-value="{{ track.album }}">
                                {{ track.album }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                {% if track.duration_ms %}
                                    {% set minutes = (track.duration_ms / 60000) | int %}
                                    {% set seconds = ((track.duration_ms % 60000) / 1000) | int %}
                                    {{ "%d:%02d" | format(minutes, seconds) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if track.is_broken %}
                                    {{ badge('Broken', 'danger') }}
                                {% elif track.file_path %}
                                    {{ badge('Downloaded', 'success') }}
                                {% else %}
                                    {{ badge('Missing', 'warning') }}
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div class="flex gap-2">
                                    {% if not track.file_path or track.is_broken %}
                                    <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 focus-ring"
                                            hx-post="/api/tracks/{{ track.id }}/download"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            aria-label="Download track {{ track.title }}">
                                        Download
                                    </button>
                                    {% endif %}
                                    <button class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 focus-ring"
                                            hx-get="/ui/tracks/{{ track.id }}/metadata-editor"
                                            hx-target="#metadata-modal"
                                            hx-swap="innerHTML"
                                            aria-label="Edit metadata for {{ track.title }}">
                                        Edit
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-12">
                {% set icon %}
                <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
                {% endset %}
                {{ empty_state(icon, 'No tracks found', 'Your library does not contain any tracks yet. Import some playlists to get started!', 'Import Playlist', '/ui/playlists/import') }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Metadata Modal Container -->
    <div id="metadata-modal"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search filter
    const searchInput = document.getElementById('track-search');
    const statusFilter = document.getElementById('status-filter');
    
    function filterTracks() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const trackRows = document.querySelectorAll('.track-row');
        
        trackRows.forEach(row => {
            const title = row.querySelector('[data-sort-value]').getAttribute('data-sort-value').toLowerCase();
            const artist = row.querySelectorAll('[data-sort-value]')[1].getAttribute('data-sort-value').toLowerCase();
            const album = row.querySelectorAll('[data-sort-value]')[2].getAttribute('data-sort-value').toLowerCase();
            const status = row.getAttribute('data-status');
            
            const matchesSearch = title.includes(searchTerm) || artist.includes(searchTerm) || album.includes(searchTerm);
            const matchesStatus = statusValue === 'all' || status === statusValue;
            
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterTracks);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterTracks);
    }
    
    // Sortable columns
    const sortHeaders = document.querySelectorAll('[data-sort]');
    let currentSort = { column: null, direction: 'asc' };
    
    sortHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            const tbody = document.getElementById('tracks-tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle direction if same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.querySelector(`[data-sort-value]`)?.getAttribute('data-sort-value') || '';
                const bValue = b.querySelector(`[data-sort-value]`)?.getAttribute('data-sort-value') || '';
                
                if (currentSort.direction === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}
