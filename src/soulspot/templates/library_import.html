{% extends "base.html" %}

{% block title %}Library Import - SoulSpot{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1>
            <i class="bi bi-folder2-open"></i>
            Library Import
        </h1>
        <p class="subtitle">Scan and import your local music collection</p>
    </div>
</div>

<!-- Summary Stats -->
<div class="stats-grid" id="summary-stats">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="bi bi-person"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="total-artists">{{ summary.total_artists | default(0) }}</span>
            <span class="stat-label">Artists</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="bi bi-disc"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="total-albums">{{ summary.total_albums | default(0) }}</span>
            <span class="stat-label">Albums</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="bi bi-music-note"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="total-tracks">{{ summary.total_tracks | default(0) }}</span>
            <span class="stat-label">Tracks</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="bi bi-file-earmark-music"></i>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="local-files">{{ summary.local_files | default(0) }}</span>
            <span class="stat-label">Local Files</span>
        </div>
    </div>
</div>

<!-- Scan Controls -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3><i class="bi bi-play-fill"></i> Start Scan</h3>
    </div>
    <div class="card-body">
        <p class="text-muted" style="margin-bottom: 1rem;">
            <i class="bi bi-folder"></i>
            Music Path: <code>{{ summary.music_path | default('/music') }}</code>
        </p>

        <div class="scan-options" style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <!-- Incremental Scan (Default) -->
            <button 
                class="btn btn-primary"
                id="btn-incremental-scan"
                hx-post="/api/library/import/scan"
                hx-vals='{"incremental": true}'
                hx-target="#scan-status"
                hx-swap="innerHTML"
                hx-indicator="#scan-loading"
            >
                <i class="bi bi-lightning"></i>
                Incremental Scan
            </button>

            <!-- Full Scan -->
            <button 
                class="btn btn-secondary"
                id="btn-full-scan"
                hx-post="/api/library/import/scan"
                hx-vals='{"incremental": false}'
                hx-target="#scan-status"
                hx-swap="innerHTML"
                hx-indicator="#scan-loading"
            >
                <i class="bi bi-arrow-clockwise"></i>
                Full Scan
            </button>
        </div>

        <div class="scan-info" style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
            <p><strong>Incremental:</strong> Only scan new or modified files (fast)</p>
            <p><strong>Full:</strong> Re-scan all files, update metadata (slow)</p>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="scan-loading" class="htmx-indicator" style="text-align: center; padding: 1rem;">
    <div class="loading-spinner"></div>
    <p>Starting scan...</p>
</div>

<!-- Scan Status -->
<div id="scan-status" style="margin-top: 1.5rem;">
    {% if active_job %}
    <div class="card">
        <div class="card-header">
            <h3><i class="bi bi-list-task"></i> Scan in Progress</h3>
        </div>
        <div class="card-body"
             hx-get="/api/library/import/status/{{ active_job.job_id }}"
             hx-trigger="every 2s"
             hx-swap="outerHTML">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ active_job.progress | default(0) }}%;"></div>
                </div>
                <span class="progress-text">{{ active_job.progress | default(0) | round(1) }}%</span>
            </div>
            
            {% if active_job.stats %}
            <div class="scan-stats" style="margin-top: 1rem;">
                <span><i class="bi bi-file-earmark"></i> Scanned: {{ active_job.stats.scanned | default(0) }}</span>
                <span><i class="bi bi-check text-success"></i> Imported: {{ active_job.stats.imported | default(0) }}</span>
                <span><i class="bi bi-skip-forward"></i> Skipped: {{ active_job.stats.skipped | default(0) }}</span>
                <span><i class="bi bi-exclamation-triangle text-warning"></i> Errors: {{ active_job.stats.errors | default(0) }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Recent Jobs -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3><i class="bi bi-clock-history"></i> Recent Scans</h3>
    </div>
    <div class="card-body"
         hx-get="/library/import/jobs-list"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <p class="text-muted">Loading recent jobs...</p>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stat-card {
    background: var(--surface-elevated);
    border-radius: 8px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--accent-primary-alpha);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent-primary);
    font-size: 1.25rem;
}

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.progress-container {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--surface-base);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--accent-primary);
    transition: width 0.3s ease;
}

.progress-text {
    font-weight: 600;
    min-width: 60px;
    text-align: right;
}

.scan-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.scan-stats span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.scan-options .btn {
    min-width: 180px;
}

.scan-info p {
    margin: 0.25rem 0;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--surface-elevated);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.htmx-indicator {
    display: none;
}

.htmx-request .htmx-indicator {
    display: block;
}

.htmx-request.htmx-indicator {
    display: block;
}
</style>

<script>
// Handle scan response
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/library/import/scan') {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            if (response.job_id) {
                // Show clean scan status card
                const statusDiv = document.getElementById('scan-status');
                const stats = response.stats || {};
                const isCompleted = response.status === 'completed';
                
                statusDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <i class="bi bi-${isCompleted ? 'check-circle text-success' : 'hourglass-split'}"></i> 
                                ${isCompleted ? 'Scan Completed' : 'Scan Started'}
                            </h3>
                        </div>
                        <div class="card-body"
                             ${!isCompleted ? `hx-get="/api/library/import/status/${response.job_id}" hx-trigger="load, every 2s" hx-swap="innerHTML"` : ''}>
                            ${isCompleted ? `
                                <div class="scan-stats" style="margin-bottom: 1rem;">
                                    <span><i class="bi bi-file-earmark"></i> Files Scanned: <strong>${stats.scanned || 0}</strong></span>
                                    <span><i class="bi bi-check text-success"></i> Imported: <strong>${stats.imported || 0}</strong></span>
                                    <span><i class="bi bi-skip-forward"></i> Skipped: <strong>${stats.skipped || 0}</strong></span>
                                    ${stats.errors > 0 ? `<span><i class="bi bi-exclamation-triangle text-warning"></i> Errors: <strong>${stats.errors}</strong></span>` : ''}
                                </div>
                                ${stats.new_artists > 0 || stats.new_albums > 0 || stats.new_tracks > 0 ? `
                                <div class="scan-stats" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle);">
                                    ${stats.new_artists > 0 ? `<span><i class="bi bi-person-plus"></i> New Artists: <strong>${stats.new_artists}</strong></span>` : ''}
                                    ${stats.new_albums > 0 ? `<span><i class="bi bi-disc"></i> New Albums: <strong>${stats.new_albums}</strong></span>` : ''}
                                    ${stats.new_tracks > 0 ? `<span><i class="bi bi-music-note-beamed"></i> New Tracks: <strong>${stats.new_tracks}</strong></span>` : ''}
                                </div>
                                ` : ''}
                                <p class="text-muted" style="margin-top: 1rem; margin-bottom: 0; font-size: 0.85rem;">
                                    <i class="bi bi-clock"></i> Completed in ${stats.completed_at && stats.started_at ? calculateDuration(stats.started_at, stats.completed_at) : 'N/A'}
                                </p>
                            ` : `
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                    <span class="progress-text">Starting...</span>
                                </div>
                                <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.85rem;">
                                    Job ID: <code>${response.job_id}</code>
                                </p>
                            `}
                        </div>
                    </div>
                `;
                htmx.process(statusDiv);
                
                // Reload summary stats after completion
                if (isCompleted && stats.imported > 0) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        } catch (e) {
            console.error('Error parsing scan response:', e);
            document.getElementById('scan-status').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error starting scan. Check console for details.</p>
                    </div>
                </div>
            `;
        }
    }
});

// Helper function to calculate duration
function calculateDuration(start, end) {
    const startTime = new Date(start);
    const endTime = new Date(end);
    const durationMs = endTime - startTime;
    
    if (durationMs < 1000) return `${durationMs}ms`;
    if (durationMs < 60000) return `${(durationMs / 1000).toFixed(1)}s`;
    return `${Math.floor(durationMs / 60000)}m ${Math.floor((durationMs % 60000) / 1000)}s`;
}
</script>
{% endblock %}
