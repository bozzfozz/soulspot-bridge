{# Hey future me - Followed Artists page for automation!
   Syncs artists you follow on Spotify and creates watchlists for auto-downloads.
   HTMX POST to /api/automation/followed-artists/sync fetches the list.
   selectedArtists Set tracks checkboxes, createWatchlistsForSelected() bulk-creates watchlists. #}

{% extends "base.html" %}

{% block title %}Followed Artists - SoulSpot{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    
    <!-- Page Header -->
    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: var(--space-4); margin-bottom: var(--space-8);">
        <div style="flex: 1;">
            <!-- Breadcrumb -->
            <nav style="margin-bottom: var(--space-3);">
                <ol style="display: flex; align-items: center; gap: var(--space-2); list-style: none; font-size: var(--font-size-sm);">
                    <li><a href="/" style="color: var(--accent-primary);">Home</a></li>
                    <li><i class="bi bi-chevron-right" style="color: var(--text-muted); font-size: 0.625rem;"></i></li>
                    <li style="color: var(--text-muted);">Automation</li>
                    <li><i class="bi bi-chevron-right" style="color: var(--text-muted); font-size: 0.625rem;"></i></li>
                    <li style="color: var(--text-muted);">Followed Artists</li>
                </ol>
            </nav>
            
            <div style="display: flex; align-items: center; gap: var(--space-3);">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg);">
                    <i class="bi bi-person" style="color: white; font-size: 1.25rem;"></i>
                </div>
                <div>
                    <h1 style="font-size: var(--font-size-3xl);">Followed Artists</h1>
                    <p style="color: var(--text-muted);">Sync your Spotify followed artists and create watchlists</p>
                </div>
            </div>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
            <button id="sync-btn" 
                    class="btn btn-primary"
                    hx-post="/api/automation/followed-artists/sync"
                    hx-target="#artists-list"
                    hx-swap="innerHTML"
                    hx-indicator="#sync-spinner">
                <i class="bi bi-arrow-repeat"></i>
                Sync from Spotify
            </button>
            <button id="create-watchlists-btn"
                    class="btn btn-outline"
                    onclick="createWatchlistsForSelected()"
                    disabled>
                <i class="bi bi-plus-lg"></i>
                Create Watchlists
            </button>
        </div>
    </div>

    <!-- Sync Progress Indicator -->
    <div id="sync-spinner" class="htmx-indicator card" style="padding: var(--space-8); text-align: center; margin-bottom: var(--space-6); background: rgba(var(--accent-primary-rgb), 0.1); border: 1px solid rgba(var(--accent-primary-rgb), 0.2);">
        <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
        <p style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); color: var(--accent-primary);">Syncing followed artists from Spotify...</p>
        <p style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: var(--space-2);">This may take a few moments if you follow many artists</p>
    </div>

    <!-- Stats Banner -->
    <div id="stats-banner" style="display: none; margin-bottom: var(--space-6);">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4);">
            <div class="card" style="padding: var(--space-4); text-align: center;">
                <div style="width: 40px; height: 40px; margin: 0 auto var(--space-2); background: rgba(var(--accent-primary-rgb), 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-people" style="color: var(--accent-primary);"></i>
                </div>
                <p id="stat-total" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">0</p>
                <p style="font-size: var(--font-size-xs); color: var(--text-muted);">Total Fetched</p>
            </div>
            <div class="card" style="padding: var(--space-4); text-align: center;">
                <div style="width: 40px; height: 40px; margin: 0 auto var(--space-2); background: rgba(34, 197, 94, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-plus-lg" style="color: #22c55e;"></i>
                </div>
                <p id="stat-created" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: #22c55e;">0</p>
                <p style="font-size: var(--font-size-xs); color: var(--text-muted);">Created</p>
            </div>
            <div class="card" style="padding: var(--space-4); text-align: center;">
                <div style="width: 40px; height: 40px; margin: 0 auto var(--space-2); background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-arrow-repeat" style="color: #3b82f6;"></i>
                </div>
                <p id="stat-updated" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: #3b82f6;">0</p>
                <p style="font-size: var(--font-size-xs); color: var(--text-muted);">Updated</p>
            </div>
            <div class="card" style="padding: var(--space-4); text-align: center;">
                <div style="width: 40px; height: 40px; margin: 0 auto var(--space-2); background: rgba(168, 85, 247, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-check" style="color: #a855f7;"></i>
                </div>
                <p id="stat-selected" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: #a855f7;">0</p>
                <p style="font-size: var(--font-size-xs); color: var(--text-muted);">Selected</p>
            </div>
        </div>
    </div>

    <!-- Artists List -->
    <div id="artists-list">
        <!-- Empty state -->
        <div class="card" style="padding: var(--space-16); text-align: center;">
            <div style="max-width: 400px; margin: 0 auto;">
                <div style="width: 96px; height: 96px; margin: 0 auto var(--space-6); background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-person" style="font-size: 3rem; color: #10b981;"></i>
                </div>
                <h3 style="font-size: var(--font-size-2xl); margin-bottom: var(--space-3);">No artists synced yet</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--space-6);">
                    Click "Sync from Spotify" to fetch all artists you follow on Spotify and create watchlists for automatic downloads.
                </p>
                <button onclick="document.getElementById('sync-btn').click()" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-repeat"></i>
                    Sync from Spotify
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border-secondary);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator { display: block; }
    .htmx-request.htmx-indicator { display: block; }
    
    @media (max-width: 768px) {
        #stats-banner > div { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 480px) {
        #stats-banner > div { grid-template-columns: 1fr !important; }
    }
</style>
<script>
    let selectedArtists = new Set();

    window.updateStatsFromPartial = function() {
        if (window.syncStats) {
            document.getElementById('stat-total').textContent = window.syncStats.total_fetched;
            document.getElementById('stat-created').textContent = window.syncStats.created;
            document.getElementById('stat-updated').textContent = window.syncStats.updated;
            document.getElementById('stats-banner').style.display = 'block';
            
            SoulSpot.showNotification(`Synced ${window.syncStats.total_fetched} artists successfully!`, 'success');
        }
    };

    function toggleArtist(artistId) {
        if (selectedArtists.has(artistId)) {
            selectedArtists.delete(artistId);
        } else {
            selectedArtists.add(artistId);
        }
        updateSelectedCount();
        updateCreateButton();
    }

    function updateSelectedCount() {
        document.getElementById('stat-selected').textContent = selectedArtists.size;
    }

    function updateCreateButton() {
        const btn = document.getElementById('create-watchlists-btn');
        btn.disabled = selectedArtists.size === 0;
    }

    async function createWatchlistsForSelected() {
        if (selectedArtists.size === 0) {
            SoulSpot.showNotification('Please select at least one artist', 'warning');
            return;
        }

        const btn = document.getElementById('create-watchlists-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> Creating...';

        try {
            const response = await fetch('/api/automation/followed-artists/watchlists/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    artist_ids: Array.from(selectedArtists),
                    check_frequency_hours: 24,
                    auto_download: true,
                    quality_profile: 'high'
                })
            });

            const result = await response.json();

            if (response.ok) {
                SoulSpot.showNotification(
                    `Successfully created ${result.created} watchlist${result.created > 1 ? 's' : ''}!${result.failed > 0 ? ` (${result.failed} failed)` : ''}`,
                    'success'
                );
                
                selectedArtists.clear();
                document.querySelectorAll('.artist-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
                updateCreateButton();
            } else {
                throw new Error(result.detail || 'Failed to create watchlists');
            }
        } catch (error) {
            SoulSpot.showNotification('Error creating watchlists: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function selectAll() {
        document.querySelectorAll('.artist-checkbox').forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                selectedArtists.add(checkbox.dataset.artistId);
            }
        });
        updateSelectedCount();
        updateCreateButton();
    }

    function deselectAll() {
        document.querySelectorAll('.artist-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedArtists.clear();
        updateSelectedCount();
        updateCreateButton();
    }
</script>
{% endblock %}
