{% extends "base.html" %}
{% from "includes/_skeleton.html" import list_skeleton, spinner %}
{% from "includes/_components.html" import breadcrumb %}

{% block title %}Search - SoulSpot{% endblock %}

{% block extra_head %}
<style>
    /* Smooth transitions for collapsible sections */
    .filter-section {
        transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
        overflow: hidden;
    }
    .filter-section.collapsed {
        max-height: 0;
        opacity: 0;
    }
    .filter-section:not(.collapsed) {
        max-height: 500px;
        opacity: 1;
    }
    
    /* Filter button icon rotation */
    .filter-collapsed .filter-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="search-page space-y-8 animate-fade-in">
    
    <!-- Modern Page Header -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-gradient-to-br from-info-500 to-info-700 rounded-2xl flex items-center justify-center shadow-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">
                    Search Music
                </h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Find and download your favorite tracks from Soulseek</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Left Sidebar - Advanced Filters -->
        <div class="lg:col-span-1">
            <div class="card-modern sticky top-20">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            Filters
                        </h3>
                        <button 
                            id="clear-filters-btn"
                            class="btn btn-ghost btn-sm btn-modern focus-visible-ring text-xs"
                            onclick="SearchManager.clearFilters()"
                            aria-label="Clear all filters">
                            Clear All
                        </button>
                    </div>
                </div>
                <div class="p-4 space-y-4 max-h-[calc(100vh-250px)] overflow-y-auto">
                    <!-- Quality Filter -->
                    <div>
                        <button 
                            class="w-full text-left font-medium text-gray-700 dark:text-gray-300 flex items-center justify-between py-2 focus-ring rounded hover:bg-gray-50 dark:hover:bg-gray-800 px-2 -mx-2"
                            onclick="toggleFilterSection('quality')"
                            aria-expanded="true"
                            aria-controls="quality-filter">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-success-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Quality
                            </span>
                            <svg class="w-4 h-4 transition-transform filter-icon" id="quality-icon" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div id="quality-filter" class="filter-section space-y-2 mt-2 pl-6">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="radio" name="quality" value="flac" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">FLAC (Lossless)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="radio" name="quality" value="320" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">320kbps MP3</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="radio" name="quality" value="256" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">256kbps+</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="radio" name="quality" value="any" class="focus-ring" checked />
                                <span class="text-sm text-gray-700 dark:text-gray-300">Any Quality</span>
                            </label>
                        </div>
                    </div>

                    <!-- Artist Filter -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <button 
                            class="w-full text-left font-medium text-gray-700 dark:text-gray-300 flex items-center justify-between py-2 focus-ring rounded hover:bg-gray-50 dark:hover:bg-gray-800 px-2 -mx-2 filter-collapsed"
                            onclick="toggleFilterSection('artist')"
                            aria-expanded="false"
                            aria-controls="artist-filter">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-secondary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Artist
                            </span>
                            <svg class="w-4 h-4 transition-transform filter-icon" id="artist-icon" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div id="artist-filter" class="filter-section collapsed mt-2 pl-6">
                            <input 
                                type="text" 
                                id="artist-filter-input"
                                placeholder="Filter by artist..."
                                class="form-input w-full focus-ring text-sm"
                                oninput="SearchManager.updateFilters()"
                            />
                        </div>
                    </div>

                    <!-- Album Filter -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <button 
                            class="w-full text-left font-medium text-gray-700 dark:text-gray-300 flex items-center justify-between py-2 focus-ring rounded hover:bg-gray-50 dark:hover:bg-gray-800 px-2 -mx-2 filter-collapsed"
                            onclick="toggleFilterSection('album')"
                            aria-expanded="false"
                            aria-controls="album-filter">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-info-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Album
                            </span>
                            <svg class="w-4 h-4 transition-transform filter-icon" id="album-icon" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div id="album-filter" class="filter-section collapsed mt-2 pl-6">
                            <input 
                                type="text" 
                                id="album-filter-input"
                                placeholder="Filter by album..."
                                class="form-input w-full focus-ring text-sm"
                                oninput="SearchManager.updateFilters()"
                            />
                        </div>
                    </div>

                    <!-- Duration Filter -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <button 
                            class="w-full text-left font-medium text-gray-700 dark:text-gray-300 flex items-center justify-between py-2 focus-ring rounded hover:bg-gray-50 dark:hover:bg-gray-800 px-2 -mx-2 filter-collapsed"
                            onclick="toggleFilterSection('duration')"
                            aria-expanded="false"
                            aria-controls="duration-filter">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-warning-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Duration
                            </span>
                            <svg class="w-4 h-4 transition-transform filter-icon" id="duration-icon" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div id="duration-filter" class="filter-section collapsed space-y-2 mt-2 pl-6">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="checkbox" name="duration" value="short" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">Short (&lt; 3 min)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="checkbox" name="duration" value="medium" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">Medium (3-5 min)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded">
                                <input type="checkbox" name="duration" value="long" class="focus-ring" />
                                <span class="text-sm text-gray-700 dark:text-gray-300">Long (&gt; 5 min)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search History -->
            <div class="card mt-6">
                <div class="card-header border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="flex items-center justify-between">
                        <h3 class="card-title flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Recent Searches
                        </h3>
                        <button 
                            class="btn btn-ghost btn-sm focus-ring text-xs"
                            onclick="SearchManager.clearHistory()"
                            aria-label="Clear search history">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="search-history" class="space-y-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No recent searches</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content - Search and Results -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Search Bar with Autocomplete -->
            <div class="card">
                <div class="card-body">
                    <form onsubmit="SearchManager.performSearch(event)" class="space-y-4">
                        <div class="relative">
                            <label for="search-input" class="sr-only">Search for music</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="search-input"
                                    placeholder="Search for artists, albums, or tracks..."
                                    class="form-input w-full pl-10 text-lg focus-ring"
                                    autocomplete="off"
                                    oninput="SearchManager.handleSearchInput(event)"
                                    aria-describedby="search-helper"
                                    aria-autocomplete="list"
                                    aria-controls="autocomplete-results"
                                />
                            </div>
                            <!-- Autocomplete Dropdown -->
                            <div 
                                id="autocomplete-results" 
                                class="absolute w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-md shadow-lg mt-1 hidden z-10"
                                role="listbox"
                            ></div>
                            <p id="search-helper" class="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center gap-2">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Press Enter to search, or select a suggestion
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg focus-ring flex-1 sm:flex-none group">
                                <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Search
                            </button>
                            <button type="button" class="btn btn-secondary focus-ring" onclick="SearchManager.clearSearch()">
                                Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bulk Actions Bar (hidden by default) -->
            <div id="bulk-actions-bar" class="card bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-800 hidden">
                <div class="card-body">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium text-primary-900 dark:text-primary-100" id="selected-count">0 selected</span>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="select-all-checkbox"
                                    class="focus-ring"
                                    onchange="SearchManager.toggleSelectAll(this.checked)"
                                />
                                <span class="text-sm text-primary-900 dark:text-primary-100">Select All</span>
                            </label>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button 
                                class="btn btn-primary focus-ring"
                                onclick="SearchManager.bulkDownload()"
                                id="bulk-download-btn">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Download Selected
                            </button>
                            <button 
                                class="btn btn-secondary focus-ring"
                                onclick="SearchManager.clearSelection()">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div id="search-results" class="space-y-4">
                <!-- Empty state -->
                <div class="card text-center py-16">
                    <div class="card-body">
                        <svg class="w-24 h-24 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">Start Your Search</h3>
                        <p class="text-gray-600 dark:text-gray-400 max-w-md mx-auto">
                            Search for your favorite artists, albums, or tracks to find high-quality downloads from Soulseek
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/search.js"></script>
<script>
    function toggleFilterSection(sectionId) {
        const section = document.getElementById(`${sectionId}-filter`);
        const button = section.previousElementSibling;
        const icon = document.getElementById(`${sectionId}-icon`);
        
        section.classList.toggle('collapsed');
        button.classList.toggle('filter-collapsed');
        
        const isExpanded = !section.classList.contains('collapsed');
        button.setAttribute('aria-expanded', isExpanded);
    }
</script>
{% endblock %}
