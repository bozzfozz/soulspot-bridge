{# Hey future me - Spotify Album Detail page with tracks!
   Shows album info + all tracks. Tracks auto-sync on page load.
   Download buttons for each track (via slskd). Green/purple Spotify branding. #}

{% extends "base.html" %}

{% block title %}{{ album.name if album else 'Album' }} - Spotify - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav style="margin-bottom: var(--space-4);">
    <ol style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm); flex-wrap: wrap;">
        <li><a href="/spotify/artists" style="color: #1DB954;"><i class="fa-brands fa-spotify"></i> Spotify</a></li>
        <li style="color: var(--text-muted);"><i class="fa-solid fa-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        {% if artist %}
        <li><a href="/spotify/artists/{{ artist.spotify_id }}" style="color: #1DB954;">{{ artist.name }}</a></li>
        <li style="color: var(--text-muted);"><i class="fa-solid fa-chevron-right" style="font-size: 0.6rem; margin: 0 var(--space-2);"></i></li>
        {% endif %}
        <li style="color: var(--text-muted);">{{ album.name if album else 'Unknown' }}</li>
    </ol>
</nav>

{% if error %}
<div class="alert alert-error" style="margin-bottom: var(--space-6);">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <span>{{ error }}</span>
</div>
{% endif %}

{% if album %}
<!-- Album Header -->
<div class="album-header">
    {% if album.image_url %}
    <img src="{{ album.image_url }}" alt="{{ album.name }}" class="album-header-cover">
    {% else %}
    <div class="album-header-cover-placeholder">
        <i class="fa-solid fa-compact-disc"></i>
    </div>
    {% endif %}
    <div class="album-header-info">
        <span class="album-header-label">
            <span class="album-type-badge album-type-{{ album.album_type }}">{{ album.album_type|capitalize }}</span>
        </span>
        <h1 class="album-header-name">{{ album.name }}</h1>
        <div class="album-header-meta">
            {% if artist %}
            <a href="/spotify/artists/{{ artist.spotify_id }}" class="album-artist-link">
                {{ artist.name }}
            </a>
            <span class="meta-separator">•</span>
            {% endif %}
            <span>{{ album.release_date[:4] if album.release_date else 'Unknown year' }}</span>
            <span class="meta-separator">•</span>
            <span>{{ track_count }} track{{ 's' if track_count != 1 else '' }}</span>
            <span class="meta-separator">•</span>
            <span>{{ total_duration }}</span>
        </div>
        {% if sync_stats and sync_stats.synced %}
        <span style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: var(--space-2); display: block;">
            <i class="fa-solid fa-check" style="color: #1DB954;"></i>
            Tracks synced
        </span>
        {% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div class="album-actions">
    <button class="btn btn-primary btn-spotify" id="download-all-btn" 
            hx-post="/api/downloads/bulk"
            hx-vals='{"tracks": {{ tracks|map(attribute="spotify_id")|list|tojson }}, "artist": "{{ artist.name if artist else "" }}", "album": "{{ album.name }}"}'
            hx-swap="none">
        <i class="fa-solid fa-download"></i>
        Download All
    </button>
    <button class="btn btn-outline" id="download-missing-btn"
            hx-post="/api/downloads/bulk"
            hx-vals='{"tracks": {{ tracks|selectattr("is_downloaded", "equalto", false)|map(attribute="spotify_id")|list|tojson }}, "artist": "{{ artist.name if artist else "" }}", "album": "{{ album.name }}"}'
            hx-swap="none">
        <i class="fa-solid fa-cloud-download"></i>
        Download Missing ({{ tracks|selectattr("is_downloaded", "equalto", false)|list|length }})
    </button>
</div>

<!-- Track List -->
<div class="track-list">
    <div class="track-list-header">
        <span class="track-col-number">#</span>
        <span class="track-col-title">Title</span>
        <span class="track-col-duration"><i class="fa-regular fa-clock"></i></span>
        <span class="track-col-status">Status</span>
        <span class="track-col-actions"></span>
    </div>
    {% for track in tracks %}
    <div class="track-row {% if track.is_downloaded %}track-downloaded{% endif %}" data-spotify-id="{{ track.spotify_id }}">
        <span class="track-col-number">{{ track.track_number }}</span>
        <div class="track-col-title">
            <span class="track-name">{{ track.name }}</span>
            {% if track.explicit %}
            <span class="explicit-badge">E</span>
            {% endif %}
        </div>
        <span class="track-col-duration">{{ track.duration_str }}</span>
        <span class="track-col-status">
            {% if track.is_downloaded %}
            <span class="status-badge status-downloaded">
                <i class="fa-solid fa-check"></i> Downloaded
            </span>
            {% else %}
            <span class="status-badge status-missing">
                <i class="fa-solid fa-cloud"></i> Spotify
            </span>
            {% endif %}
        </span>
        <span class="track-col-actions">
            {% if not track.is_downloaded %}
            <button class="btn btn-sm btn-icon" title="Download"
                    hx-post="/api/downloads"
                    hx-vals='{"spotify_id": "{{ track.spotify_id }}", "title": "{{ track.name }}", "artist": "{{ artist.name if artist else "" }}", "album": "{{ album.name }}"}'
                    hx-swap="none">
                <i class="fa-solid fa-download"></i>
            </button>
            {% else %}
            <button class="btn btn-sm btn-icon btn-success" title="In Library" disabled>
                <i class="fa-solid fa-check"></i>
            </button>
            {% endif %}
            {% if track.preview_url %}
            <button class="btn btn-sm btn-icon preview-btn" title="Preview" data-preview-url="{{ track.preview_url }}">
                <i class="fa-solid fa-play"></i>
            </button>
            {% endif %}
        </span>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fa-solid fa-compact-disc"></i>
    </div>
    <h3>Album not found</h3>
    <p>The requested album could not be found.</p>
    <a href="/spotify/artists" class="btn btn-primary">
        <i class="fa-solid fa-arrow-left"></i>
        Back to Artists
    </a>
</div>
{% endif %}

<!-- Audio Preview Player (hidden) -->
<audio id="preview-player" style="display: none;"></audio>
{% endblock %}

{% block extra_scripts %}
<style>
    .album-header {
        display: flex;
        align-items: flex-end;
        gap: var(--space-6);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
    }
    .album-header-cover {
        width: 220px;
        height: 220px;
        border-radius: var(--radius-lg);
        object-fit: cover;
        box-shadow: var(--shadow-xl);
    }
    .album-header-cover-placeholder {
        width: 220px;
        height: 220px;
        border-radius: var(--radius-lg);
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        color: var(--text-muted);
        box-shadow: var(--shadow-xl);
    }
    .album-header-info {
        flex: 1;
    }
    .album-header-label {
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .album-header-name {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        margin: var(--space-2) 0;
        line-height: 1.2;
    }
    .album-header-meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--space-2);
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }
    .album-artist-link {
        color: var(--text-primary);
        font-weight: var(--font-weight-semibold);
        text-decoration: none;
    }
    .album-artist-link:hover {
        color: #1DB954;
        text-decoration: underline;
    }
    .meta-separator {
        color: var(--text-muted);
    }
    .album-type-badge {
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        font-weight: var(--font-weight-semibold);
    }
    .album-type-album {
        background: rgba(29, 185, 84, 0.2);
        color: #1DB954;
    }
    .album-type-single {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }
    .album-type-compilation {
        background: rgba(251, 146, 60, 0.2);
        color: #fb923c;
    }
    
    /* Action buttons */
    .album-actions {
        display: flex;
        gap: var(--space-3);
        margin: var(--space-6) 0;
    }
    .btn-spotify {
        background: #1DB954;
        border-color: #1DB954;
    }
    .btn-spotify:hover {
        background: #1ed760;
        border-color: #1ed760;
    }
    
    /* Track list */
    .track-list {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    .track-list-header {
        display: grid;
        grid-template-columns: 50px 1fr 80px 140px 100px;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        font-weight: var(--font-weight-semibold);
    }
    .track-row {
        display: grid;
        grid-template-columns: 50px 1fr 80px 140px 100px;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        align-items: center;
        border-bottom: 1px solid var(--border-secondary);
        transition: background var(--transition-fast);
    }
    .track-row:last-child {
        border-bottom: none;
    }
    .track-row:hover {
        background: var(--bg-tertiary);
    }
    .track-row.track-downloaded {
        background: rgba(29, 185, 84, 0.05);
    }
    .track-col-number {
        color: var(--text-muted);
        text-align: center;
    }
    .track-col-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        min-width: 0;
    }
    .track-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: var(--font-weight-medium);
    }
    .explicit-badge {
        background: var(--text-muted);
        color: var(--bg-primary);
        font-size: 9px;
        padding: 1px 4px;
        border-radius: 2px;
        font-weight: var(--font-weight-bold);
        flex-shrink: 0;
    }
    .track-col-duration {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
        text-align: right;
    }
    .track-col-status {
        text-align: center;
    }
    .track-col-actions {
        display: flex;
        gap: var(--space-1);
        justify-content: flex-end;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: var(--radius-full);
    }
    .status-downloaded {
        background: rgba(29, 185, 84, 0.2);
        color: #1DB954;
    }
    .status-missing {
        background: var(--bg-tertiary);
        color: var(--text-muted);
    }
    
    .btn-sm {
        padding: var(--space-1) var(--space-2);
        font-size: var(--font-size-sm);
    }
    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    .btn-icon:hover {
        background: #1DB954;
        border-color: #1DB954;
        color: white;
    }
    .btn-icon.btn-success {
        background: rgba(29, 185, 84, 0.2);
        border-color: #1DB954;
        color: #1DB954;
    }
    .btn-icon:disabled {
        cursor: default;
    }
    .preview-btn.playing {
        background: #1DB954;
        border-color: #1DB954;
        color: white;
    }
    .preview-btn.playing i::before {
        content: "\f04c"; /* pause icon */
    }
    
    .empty-state {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-xl);
        padding: var(--space-12);
        text-align: center;
    }
    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-4);
        background: var(--bg-tertiary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-3xl);
        color: var(--text-muted);
    }
    .empty-state h3 {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }
    .empty-state p {
        color: var(--text-muted);
        margin-bottom: var(--space-6);
    }
    .alert {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
    }
    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }
    
    @media (max-width: 768px) {
        .album-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .album-header-cover, .album-header-cover-placeholder {
            width: 180px;
            height: 180px;
        }
        .album-header-name {
            font-size: var(--font-size-2xl);
        }
        .album-header-meta {
            justify-content: center;
        }
        .track-list-header, .track-row {
            grid-template-columns: 40px 1fr 60px 80px;
        }
        .track-col-status {
            display: none;
        }
        .album-actions {
            flex-direction: column;
        }
    }
</style>
<script>
// Preview player functionality
document.addEventListener('DOMContentLoaded', function() {
    const player = document.getElementById('preview-player');
    const previewBtns = document.querySelectorAll('.preview-btn');
    let currentBtn = null;
    
    previewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const url = this.dataset.previewUrl;
            
            if (currentBtn === this && !player.paused) {
                // Pause current
                player.pause();
                this.classList.remove('playing');
                currentBtn = null;
            } else {
                // Stop previous
                if (currentBtn) {
                    currentBtn.classList.remove('playing');
                }
                // Play new
                player.src = url;
                player.play();
                this.classList.add('playing');
                currentBtn = this;
            }
        });
    });
    
    player.addEventListener('ended', function() {
        if (currentBtn) {
            currentBtn.classList.remove('playing');
            currentBtn = null;
        }
    });
});
</script>
{% endblock %}
