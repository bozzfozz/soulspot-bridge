{# Hey future me - Playlist detail page!
   Shows playlist header with cover, name, description, stats.
   Track list in a table with album art, status badges, actions.
   The download/sync actions use HTMX for async operations.
   Bulk selection logic is preserved - watch for checkbox state updates! #}

{% extends "base.html" %}

{% block title %}{{ playlist.name }} - SoulSpot{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb" style="margin-bottom: var(--space-6);">
    <a href="/playlists" style="color: var(--accent-primary);">Playlists</a>
    <span style="color: var(--text-muted); margin: 0 var(--space-2);">/</span>
    <span style="color: var(--text-muted);">{{ playlist.name }}</span>
</nav>

<!-- Playlist Header -->
<div class="card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); padding: var(--space-8); margin-bottom: var(--space-8);">
    <div class="flex gap-6" style="align-items: flex-start;">
        <img src="{{ playlist.cover_url or 'https://via.placeholder.com/200x200?text=' + (playlist.name[:1] if playlist.name else 'P') }}"
            alt="{{ playlist.name }}"
            style="width: 200px; height: 200px; border-radius: var(--radius-lg); object-fit: cover; box-shadow: var(--shadow-xl); flex-shrink: 0;">
        <div style="flex: 1; min-width: 0;">
            <div style="font-size: var(--font-size-xs); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: var(--space-2);">
                Playlist
            </div>
            <h1 style="font-size: var(--font-size-4xl); margin-bottom: var(--space-2);">{{ playlist.name }}</h1>
            {% if playlist.description %}
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">{{ playlist.description }}</p>
            {% endif %}
            <div class="flex gap-3" style="font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--space-6); flex-wrap: wrap;">
                <span>{{ playlist.track_count|default(0) }} tracks</span>
                <span>•</span>
                <span>{{ playlist.tracks|selectattr('file_path')|list|length if playlist.tracks else 0 }} downloaded</span>
                {% if playlist.source %}
                <span>•</span>
                <span class="badge badge-info">{{ playlist.source }}</span>
                {% endif %}
            </div>
            <div class="flex gap-3" style="flex-wrap: wrap;">
                <button class="btn btn-primary btn-lg"
                        hx-post="/api/playlists/{{ playlist.id }}/sync"
                        hx-target="#sync-status"
                        hx-swap="innerHTML"
                        hx-indicator="#sync-spinner">
                    <i class="fa-solid fa-sync"></i>
                    Sync Now
                </button>
                <button id="bulk-download-btn" class="btn btn-outline btn-lg" style="display: none;"
                        onclick="bulkDownloadSelected()">
                    <i class="fa-solid fa-download"></i>
                    Download Selected (<span id="selected-count">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sync Status -->
<div id="sync-status" style="margin-bottom: var(--space-6);"></div>
<span id="sync-spinner" class="htmx-indicator" style="display: none;">
    <i class="fa-solid fa-spinner fa-spin"></i> Syncing...
</span>

<!-- Stats Grid -->
<div class="stats-grid" style="margin-bottom: var(--space-8);">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary);">
            <i class="fa-solid fa-music"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ playlist.track_count|default(0) }}</div>
            <div class="stat-label">Total Tracks</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
            <i class="fa-solid fa-check"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #22c55e;">{{ playlist.tracks|selectattr('file_path')|list|length if playlist.tracks else 0 }}</div>
            <div class="stat-label">Downloaded</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(234, 179, 8, 0.1); color: #eab308;">
            <i class="fa-solid fa-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" style="color: #eab308;">{{ playlist.tracks|rejectattr('file_path')|list|length if playlist.tracks else 0 }}</div>
            <div class="stat-label">Missing</div>
        </div>
    </div>
</div>

<!-- Track List -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div style="padding: var(--space-4) var(--space-6); border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">Tracks</h2>
        <div class="flex gap-2">
            <button class="btn btn-outline btn-sm" onclick="toggleSelectAll()">
                <i class="fa-solid fa-check-double"></i>
                Select All
            </button>
            <button class="btn btn-outline btn-sm"
                    hx-get="/ui/playlists/{{ playlist.id }}/missing-tracks"
                    hx-target="#missing-tracks-section"
                    hx-swap="innerHTML">
                <i class="fa-solid fa-list-check"></i>
                Missing Tracks
            </button>
        </div>
    </div>
    
    {% if playlist.tracks %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-primary); background: var(--bg-tertiary);">
                    <th style="padding: var(--space-3) var(--space-4); text-align: left; width: 40px;">
                        <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()"
                               style="accent-color: var(--accent-primary);">
                    </th>
                    <th style="padding: var(--space-3); text-align: left; width: 50px; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">#</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Title</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Artist</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Album</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Duration</th>
                    <th style="padding: var(--space-3); text-align: left; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Status</th>
                    <th style="padding: var(--space-3) var(--space-4); text-align: right; color: var(--text-muted); font-size: var(--font-size-xs); text-transform: uppercase;">Actions</th>
                </tr>
            </thead>
            <tbody id="tracks-tbody">
                {% for track in playlist.tracks %}
                <tr class="track-row" data-track-id="{{ track.id }}" style="border-bottom: 1px solid var(--border-primary);">
                    <td style="padding: var(--space-3) var(--space-4);">
                        <input type="checkbox" class="track-checkbox"
                               data-track-id="{{ track.id }}"
                               data-status="{% if track.is_broken %}broken{% elif track.file_path %}downloaded{% else %}missing{% endif %}"
                               onchange="updateBulkActions()"
                               style="accent-color: var(--accent-primary);">
                    </td>
                    <td style="padding: var(--space-3); color: var(--text-muted);">{{ loop.index }}</td>
                    <td style="padding: var(--space-3);">
                        <div class="flex gap-3" style="align-items: center;">
                            <img src="{{ track.album_art or 'https://via.placeholder.com/40x40?text=' + (track.title[:1] if track.title else 'T') }}"
                                style="width: 40px; height: 40px; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0;">
                            <span style="font-weight: var(--font-weight-medium);">{{ track.title or 'Unknown Title' }}</span>
                        </div>
                    </td>
                    <td style="padding: var(--space-3); color: var(--text-secondary);">{{ track.artist or 'Unknown Artist' }}</td>
                    <td style="padding: var(--space-3); color: var(--text-secondary);">{{ track.album or 'Unknown Album' }}</td>
                    <td style="padding: var(--space-3); color: var(--text-muted);">
                        {% if track.duration_ms %}
                            {% set minutes = (track.duration_ms / 60000)|int %}
                            {% set seconds = ((track.duration_ms % 60000) / 1000)|int %}
                            {{ "%d:%02d"|format(minutes, seconds) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: var(--space-3);">
                        {% if track.is_broken %}
                        <span class="badge badge-error">
                            <i class="fa-solid fa-exclamation-triangle"></i>
                            Broken
                        </span>
                        {% elif track.file_path %}
                        <span class="badge badge-success">
                            <i class="fa-solid fa-check"></i>
                            Downloaded
                        </span>
                        {% else %}
                        <span class="badge badge-warning">
                            <i class="fa-solid fa-clock"></i>
                            Missing
                        </span>
                        {% endif %}
                    </td>
                    <td style="padding: var(--space-3) var(--space-4); text-align: right;">
                        <div class="flex gap-2" style="justify-content: flex-end;">
                            {% if not track.file_path or track.is_broken %}
                            <button class="btn-icon" hx-post="/api/tracks/{{ track.id }}/download" hx-swap="none" title="Download">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            {% endif %}
                            {% if track.spotify_uri %}
                            <a href="{{ track.spotify_uri }}" target="_blank" class="btn-icon" title="Open in Spotify" style="color: #1DB954;">
                                <i class="fa-brands fa-spotify"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 4rem;">
        <i class="fa-solid fa-music" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1.5rem; display: block;"></i>
        <h3 style="margin-bottom: var(--space-2);">No Tracks in Playlist</h3>
        <p style="color: var(--text-muted); margin-bottom: var(--space-6);">
            This playlist is empty. Sync with Spotify to add tracks.
        </p>
        <button class="btn btn-primary" hx-post="/api/playlists/{{ playlist.id }}/sync" hx-swap="none">
            <i class="fa-solid fa-sync"></i>
            Sync Now
        </button>
    </div>
    {% endif %}
</div>

<!-- Missing Tracks Section -->
<div id="missing-tracks-section" style="margin-top: var(--space-6);"></div>
{% endblock %}

{% block extra_scripts %}
<style>
    .track-row {
        transition: background-color var(--transition-fast);
    }
    .track-row:hover {
        background-color: var(--bg-tertiary);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }
    .stat-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        display: flex;
        align-items: center;
        gap: var(--space-4);
        border: 1px solid var(--border-primary);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xl);
    }
    .stat-value {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
    }
    .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }
</style>
<script>
    // Hey future me - Bulk selection functionality
    // This handles the checkbox logic for selecting multiple tracks at once.
    // Watch out: the data-status attribute is used to filter already-downloaded tracks!
    
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const trackCheckboxes = document.querySelectorAll('.track-checkbox');
        const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : 
                         document.querySelectorAll('.track-checkbox:checked').length === 0;
        
        trackCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = isChecked;
        }
        
        updateBulkActions();
    }

    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
        const bulkDownloadBtn = document.getElementById('bulk-download-btn');
        const selectedCount = document.getElementById('selected-count');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const allCheckboxes = document.querySelectorAll('.track-checkbox');
        
        if (selectedCount) {
            selectedCount.textContent = checkedBoxes.length;
        }
        
        if (bulkDownloadBtn) {
            bulkDownloadBtn.style.display = checkedBoxes.length > 0 ? 'inline-flex' : 'none';
        }
        
        // Update select all checkbox state
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = checkedBoxes.length === allCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        }
    }

    function bulkDownloadSelected() {
        const checkedBoxes = document.querySelectorAll('.track-checkbox:checked');
        const trackIds = Array.from(checkedBoxes)
            .filter(cb => cb.getAttribute('data-status') !== 'downloaded')
            .map(cb => cb.getAttribute('data-track-id'));
        
        if (trackIds.length === 0) {
            SoulSpot.showNotification('All selected tracks are already downloaded', 'info');
            return;
        }
        
        if (confirm(`Download ${trackIds.length} track(s)?`)) {
            trackIds.forEach(trackId => {
                fetch(`/api/tracks/${trackId}/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).catch(error => {
                    console.error(`Error queuing download for track ${trackId}:`, error);
                });
            });
            
            SoulSpot.showNotification(`Queued ${trackIds.length} track(s) for download`, 'success');
            
            // Clear selections
            document.querySelectorAll('.track-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkActions();
        }
    }

    // Show notification on HTMX success
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            const target = evt.detail.elt;
            if (target.matches('[hx-post*="download"]')) {
                SoulSpot.showNotification('Added to download queue', 'success');
            } else if (target.matches('[hx-post*="sync"]')) {
                SoulSpot.showNotification('Playlist sync started', 'info');
            }
        }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateBulkActions();
    });
</script>
{% endblock %}
