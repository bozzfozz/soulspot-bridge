{% extends "new-ui/base.html" %}

{% block title %}Import Playlist - SoulSpot{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1>Import from Spotify</h1>
    <p class="text-muted mt-2">Import your Spotify playlists to SoulSpot</p>
</div>

<!-- Connection Status -->
<div class="card mb-8">
    <div class="flex items-center gap-4">
        <div
            style="width: 64px; height: 64px; background: {{ 'var(--bg-success)' if spotify_connected else 'var(--bg-error)' }}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
            <i class="fa-brands fa-spotify"
                style="font-size: 2rem; color: {{ 'var(--color-success)' if spotify_connected else 'var(--color-error)' }};"></i>
        </div>
        <div style="flex: 1;">
            <h3>Spotify Connection</h3>
            <p class="text-muted" style="margin-top: 0.25rem;">
                {% if spotify_connected %}
                Your Spotify account is connected as <strong>{{ spotify_user }}</strong>
                {% else %}
                Connect your Spotify account to import playlists
                {% endif %}
            </p>
        </div>
        {% if spotify_connected %}
        <button class="btn btn-outline" onclick="disconnectSpotify()">
            <i class="fa-solid fa-unlink"></i>
            Disconnect
        </button>
        {% else %}
        <a href="/auth" class="btn btn-primary">
            <i class="fa-brands fa-spotify"></i>
            Connect Spotify
        </a>
        {% endif %}
    </div>
</div>

{% if spotify_connected %}
<!-- Import Options -->
<div class="grid grid-cols-2 gap-6 mb-8">
    <!-- Import by URL -->
    <div class="card">
        <h2 class="mb-4">Import by URL</h2>
        <p class="text-muted mb-4">Paste a Spotify playlist URL to import it</p>

        <form onsubmit="importByUrl(event)">
            <div class="mb-4">
                <label
                    style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); margin-bottom: var(--space-2);">
                    Playlist URL
                </label>
                <input type="url" id="playlist-url" placeholder="https://open.spotify.com/playlist/..."
                    style="width: 100%; padding: var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); color: var(--text-primary);"
                    required>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fa-solid fa-download"></i>
                Import Playlist
            </button>
        </form>
    </div>

    <!-- Sync All -->
    <div class="card">
        <h2 class="mb-4">Sync All Playlists</h2>
        <p class="text-muted mb-4">Import all your Spotify playlists at once</p>

        <div class="mb-4">
            <div
                style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                <span style="font-size: var(--font-size-sm);">Include liked songs</span>
                <label class="toggle">
                    <input type="checkbox" id="include-liked" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div
                style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <span style="font-size: var(--font-size-sm);">Auto-sync new tracks</span>
                <label class="toggle">
                    <input type="checkbox" id="auto-sync" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <button class="btn btn-primary" style="width: 100%;" onclick="syncAll()">
            <i class="fa-solid fa-sync"></i>
            Sync All Playlists
        </button>
    </div>
</div>

<!-- Your Spotify Playlists -->
<div class="card mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2>Your Spotify Playlists</h2>
        <button class="btn btn-outline btn-sm" onclick="refreshPlaylists()">
            <i class="fa-solid fa-refresh"></i>
            Refresh
        </button>
    </div>

    {% if spotify_playlists %}
    <div class="grid grid-cols-5">
        {% for playlist in spotify_playlists %}
        <div class="media-card" style="cursor: default;">
            <div class="media-card-image">
                <img src="{{ playlist.cover_url or 'https://via.placeholder.com/300x300' }}" alt="{{ playlist.name }}">
                <div class="media-card-overlay">
                    <div class="media-card-actions">
                        {% if playlist.imported %}
                        <button class="btn-icon btn-primary" disabled title="Already imported">
                            <i class="fa-solid fa-check"></i>
                        </button>
                        {% else %}
                        <button class="btn-icon btn-primary" onclick="importPlaylist('{{ playlist.id }}')"
                            title="Import">
                            <i class="fa-solid fa-download"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="media-card-content">
                <div class="media-card-title">{{ playlist.name }}</div>
                <div class="media-card-subtitle">{{ playlist.track_count }} tracks</div>
                {% if playlist.imported %}
                <div class="media-card-meta" style="margin-top: var(--space-2);">
                    <span class="badge badge-success">
                        <i class="fa-solid fa-check"></i>
                        Imported
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem;">
        <i class="fa-solid fa-list" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
        <p class="text-muted">No playlists found. Click refresh to load your playlists.</p>
    </div>
    {% endif %}
</div>

<!-- Import History -->
<div class="card">
    <h2 class="mb-4">Recent Imports</h2>

    {% if import_history %}
    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
        {% for item in import_history[:5] %}
        <div
            style="display: flex; align-items: center; gap: 1rem; padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <img src="{{ item.cover_url or 'https://via.placeholder.com/48x48' }}"
                style="width: 48px; height: 48px; border-radius: var(--radius-sm); object-fit: cover;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: var(--font-weight-medium);">{{ item.name }}</div>
                <div style="font-size: var(--font-size-sm); color: var(--text-muted);">
                    {{ item.track_count }} tracks â€¢ Imported {{ item.imported_at }}
                </div>
            </div>
            <div>
                {% if item.status == 'completed' %}
                <span class="badge badge-success">
                    <i class="fa-solid fa-check"></i>
                    Completed
                </span>
                {% elif item.status == 'importing' %}
                <span class="badge badge-info">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    Importing
                </span>
                {% elif item.status == 'failed' %}
                <span class="badge badge-error">
                    <i class="fa-solid fa-times"></i>
                    Failed
                </span>
                {% endif %}
            </div>
            <a href="/playlists/{{ item.id }}" class="btn btn-outline btn-sm">
                View
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem;">
        <p class="text-muted">No import history yet.</p>
    </div>
    {% endif %}
</div>

{% else %}
<!-- Not Connected State -->
<div class="card" style="text-align: center; padding: 4rem;">
    <i class="fa-brands fa-spotify" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1.5rem;"></i>
    <h2>Connect Spotify to Get Started</h2>
    <p class="text-muted" style="margin-top: 0.5rem; margin-bottom: 2rem;">
        Connect your Spotify account to import and sync your playlists.
    </p>
    <a href="/auth" class="btn btn-primary btn-lg">
        <i class="fa-brands fa-spotify"></i>
        Connect Spotify
    </a>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
    function importByUrl(event) {
        event.preventDefault();
        const url = document.getElementById('playlist-url').value;

        htmx.ajax('POST', '/api/playlists/import', {
            target: 'body',
            swap: 'none',
            values: { url: url }
        });

        SoulSpot.showNotification('Importing playlist...', 'info');
        document.getElementById('playlist-url').value = '';
    }

    function syncAll() {
        const includeLiked = document.getElementById('include-liked').checked;
        const autoSync = document.getElementById('auto-sync').checked;

        if (confirm('This will import all your Spotify playlists. Continue?')) {
            htmx.ajax('POST', '/api/playlists/sync-all', {
                target: 'body',
                swap: 'none',
                values: {
                    include_liked: includeLiked,
                    auto_sync: autoSync
                }
            });

            SoulSpot.showNotification('Syncing all playlists...', 'info');
        }
    }

    function importPlaylist(playlistId) {
        htmx.ajax('POST', `/api/playlists/import/${playlistId}`, {
            target: 'body',
            swap: 'none'
        });

        SoulSpot.showNotification('Importing playlist...', 'info');
    }

    function refreshPlaylists() {
        htmx.ajax('GET', '/api/spotify/playlists', {
            target: '#spotify-playlists-grid',
            swap: 'innerHTML'
        });
    }

    function disconnectSpotify() {
        if (confirm('Are you sure you want to disconnect your Spotify account?')) {
            htmx.ajax('POST', '/api/auth/disconnect', {
                target: 'body',
                swap: 'none'
            });
        }
    }
</script>

<style>
    /* Toggle Switch */
    .toggle {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }

    .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-tertiary);
        transition: var(--transition-normal);
        border-radius: var(--radius-full);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: var(--transition-normal);
        border-radius: 50%;
    }

    .toggle input:checked+.toggle-slider {
        background-color: var(--accent-primary);
    }

    .toggle input:checked+.toggle-slider:before {
        transform: translateX(24px);
    }
</style>
{% endblock %}